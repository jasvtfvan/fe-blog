<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Jenkins + Nexus | jasvtfvan前端博客</title>
    <meta name="description" content="欢迎来到我的前端工厂">
    <link rel="icon" href="/fe-blog/github.ico">
    
    <link rel="preload" href="/fe-blog/assets/css/0.styles.68cfcd3e.css" as="style"><link rel="preload" href="/fe-blog/assets/js/app.8a3559bf.js" as="script"><link rel="preload" href="/fe-blog/assets/js/2.fbf19223.js" as="script"><link rel="preload" href="/fe-blog/assets/js/25.21f6581b.js" as="script"><link rel="prefetch" href="/fe-blog/assets/js/10.399f0c01.js"><link rel="prefetch" href="/fe-blog/assets/js/11.08202412.js"><link rel="prefetch" href="/fe-blog/assets/js/12.cfc10ac9.js"><link rel="prefetch" href="/fe-blog/assets/js/13.bdceb3a3.js"><link rel="prefetch" href="/fe-blog/assets/js/14.0c886dba.js"><link rel="prefetch" href="/fe-blog/assets/js/15.f5d42d2e.js"><link rel="prefetch" href="/fe-blog/assets/js/16.19c927b2.js"><link rel="prefetch" href="/fe-blog/assets/js/17.cc368339.js"><link rel="prefetch" href="/fe-blog/assets/js/18.99786a0e.js"><link rel="prefetch" href="/fe-blog/assets/js/19.2c96aa8f.js"><link rel="prefetch" href="/fe-blog/assets/js/20.feb358f9.js"><link rel="prefetch" href="/fe-blog/assets/js/21.854b8672.js"><link rel="prefetch" href="/fe-blog/assets/js/22.78adf0af.js"><link rel="prefetch" href="/fe-blog/assets/js/23.a8c123d2.js"><link rel="prefetch" href="/fe-blog/assets/js/24.65de2737.js"><link rel="prefetch" href="/fe-blog/assets/js/26.19b2e629.js"><link rel="prefetch" href="/fe-blog/assets/js/27.b0579100.js"><link rel="prefetch" href="/fe-blog/assets/js/28.a0c1bad8.js"><link rel="prefetch" href="/fe-blog/assets/js/29.3869f6fd.js"><link rel="prefetch" href="/fe-blog/assets/js/3.a5dd7d81.js"><link rel="prefetch" href="/fe-blog/assets/js/30.be6becb7.js"><link rel="prefetch" href="/fe-blog/assets/js/31.e027926c.js"><link rel="prefetch" href="/fe-blog/assets/js/32.dd112bea.js"><link rel="prefetch" href="/fe-blog/assets/js/33.2cdeb0bd.js"><link rel="prefetch" href="/fe-blog/assets/js/34.2eb22cbc.js"><link rel="prefetch" href="/fe-blog/assets/js/35.a1660bb3.js"><link rel="prefetch" href="/fe-blog/assets/js/36.3d49d679.js"><link rel="prefetch" href="/fe-blog/assets/js/37.2c728d3e.js"><link rel="prefetch" href="/fe-blog/assets/js/38.5b00cff3.js"><link rel="prefetch" href="/fe-blog/assets/js/39.bc2ccb29.js"><link rel="prefetch" href="/fe-blog/assets/js/4.54c72001.js"><link rel="prefetch" href="/fe-blog/assets/js/40.fe52d14c.js"><link rel="prefetch" href="/fe-blog/assets/js/41.da19c7de.js"><link rel="prefetch" href="/fe-blog/assets/js/42.82780c8a.js"><link rel="prefetch" href="/fe-blog/assets/js/43.ea864644.js"><link rel="prefetch" href="/fe-blog/assets/js/44.683e33ca.js"><link rel="prefetch" href="/fe-blog/assets/js/45.6ebdb1c6.js"><link rel="prefetch" href="/fe-blog/assets/js/46.d152d9d1.js"><link rel="prefetch" href="/fe-blog/assets/js/5.7519b52c.js"><link rel="prefetch" href="/fe-blog/assets/js/6.60bc9110.js"><link rel="prefetch" href="/fe-blog/assets/js/7.583a8196.js"><link rel="prefetch" href="/fe-blog/assets/js/8.b04d2cae.js"><link rel="prefetch" href="/fe-blog/assets/js/9.f4b536f6.js">
    <link rel="stylesheet" href="/fe-blog/assets/css/0.styles.68cfcd3e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fe-blog/" class="home-link router-link-active"><!----> <span class="site-name">jasvtfvan前端博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fe-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">微信平台</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>公众号</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/wechat/serviceaccount/local-debug.html" class="nav-link">本地调试</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/regexp/" class="nav-link">正则表达式</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/highlights/" class="nav-link">基础集锦</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/promise/" class="nav-link">promise</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">主流框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/source/observer.html" class="nav-link">框架源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/application/base.html" class="nav-link">框架应用</a></li></ul></li><li class="dropdown-item"><h4>react</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/react15/source/native.html" class="nav-link">react15源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/react16/source/fiber.html" class="nav-link">react16源码</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具环境</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/git/" class="nav-link">git/git-flow</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/node/" class="nav-link">node工具</a></li></ul></li><li class="dropdown-item"><h4>系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/mnt.html" class="nav-link">centOS</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/cmd.html" class="nav-link">linux常用命令</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/mac/switch-hosts.html" class="nav-link">mac技巧</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/normal/" class="nav-link">常规部署</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd/" class="nav-link">CI/CD</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/gitlab/" class="nav-link">gitlab搭建</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/docker/" class="nav-link">docker常用容器</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="nav-link">CI/CD综合</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fe-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">微信平台</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>公众号</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/wechat/serviceaccount/local-debug.html" class="nav-link">本地调试</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/regexp/" class="nav-link">正则表达式</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/highlights/" class="nav-link">基础集锦</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/promise/" class="nav-link">promise</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">主流框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/source/observer.html" class="nav-link">框架源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/application/base.html" class="nav-link">框架应用</a></li></ul></li><li class="dropdown-item"><h4>react</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/react15/source/native.html" class="nav-link">react15源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/react16/source/fiber.html" class="nav-link">react16源码</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具环境</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/git/" class="nav-link">git/git-flow</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/node/" class="nav-link">node工具</a></li></ul></li><li class="dropdown-item"><h4>系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/mnt.html" class="nav-link">centOS</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/cmd.html" class="nav-link">linux常用命令</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/mac/switch-hosts.html" class="nav-link">mac技巧</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/normal/" class="nav-link">常规部署</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd/" class="nav-link">CI/CD</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/gitlab/" class="nav-link">gitlab搭建</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/docker/" class="nav-link">docker常用容器</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="nav-link">CI/CD综合</a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="sidebar-link">什么是CI/CD?</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/docker.html" class="sidebar-link">Docker</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html" class="sidebar-link">安装 Jenkins</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/gitlab.html" class="sidebar-link">安装 Gitlab</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/nginx.html" class="sidebar-link">Docker Nginx</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html" class="sidebar-link">Jenkins + Gitlab</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/nexus.html" class="sidebar-link">Nexus</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-nexus.html" class="active sidebar-link">Jenkins + Nexus</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-nexus.html#jenkins-登录认证制品库" class="sidebar-link">Jenkins 登录认证制品库</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-nexus.html#nginx-服务器登录认证制品库" class="sidebar-link">Nginx 服务器登录认证制品库</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-nexus.html#使用-dockerfile-构建前端镜像" class="sidebar-link">使用 DockerFile 构建前端镜像</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-nexus.html#修改-jenkins-执行脚本" class="sidebar-link">修改 Jenkins 执行脚本</a></li></ul></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/ansible.html" class="sidebar-link">Ansible</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-nexus-ansible.html" class="sidebar-link">Ansible + Jenkins + Nexus</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="jenkins-nexus"><a href="#jenkins-nexus" aria-hidden="true" class="header-anchor">#</a> Jenkins + Nexus</h1> <p><br>上一章我们写到，如何使用 Nexus 托管我们的镜像。这一章我们就将 Nexus 和 Jenkins 结合起来构建部署。<br></p> <p><a name="Im23h"></a></p> <h2 id="jenkins-登录认证制品库"><a href="#jenkins-登录认证制品库" aria-hidden="true" class="header-anchor">#</a> Jenkins 登录认证制品库</h2> <p><br>想使用 <code>Jenkins</code> 推送镜像到制品库，必须先登录制品库。进入 <code>Jenkins</code> 容器，使用 <code>docker login</code> 登录，然后退出即可：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker <span class="token builtin class-name">exec</span> -it jenkins /bin/bash
docker login 制品库地址:端口
<span class="token builtin class-name">exit</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>10.211.55.3:8082<br>
登录<code>login credentials</code>会记录在<code>/root/.docker/config.json</code>中<br>
如果不进行<code>docker logout 服务器ip:端口</code>操作，则服务器重启后无需再次登录</p></blockquote> <p><a name="obg0K"></a></p> <h2 id="nginx-服务器登录认证制品库"><a href="#nginx-服务器登录认证制品库" aria-hidden="true" class="header-anchor">#</a> Nginx 服务器登录认证制品库</h2> <p><br>编辑 <code>/etc/docker/daemon.json</code> 文件，将制品库地址写入，然后重启 <code>docker</code> 服务</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">vi</span> /etc/docker/daemon.json
<span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart docker
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;registry-mirrors&quot;: [&quot;https://jzirisvt.mirror.aliyuncs.com&quot;],
  &quot;insecure-registries&quot;: [&quot;10.211.55.3:8082&quot;]
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><br>接着使用 <code>docker login</code> 命令进行登录</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker login 制品库地址:端口
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>10.211.55.3:8082</p></blockquote> <p><a name="EjgWc"></a></p> <h2 id="使用-dockerfile-构建前端镜像"><a href="#使用-dockerfile-构建前端镜像" aria-hidden="true" class="header-anchor">#</a> 使用 DockerFile 构建前端镜像</h2> <p><br>在此之前，我们使用** 构建压缩包 =&gt; 直接上传到目标服务器 =&gt; 进行解压部署 <strong>的方式部署前端。<br>在这里，我们更换为部署docker镜像。既然要制作自己的镜像，那就少不了</strong> DockerFile。<strong><br></strong><br>在前面我们写到过，<strong>DockerFile 是一个镜像制作过程的步骤描述</strong>。那么我们也可以简单的描述下我们自己的步骤。<br> <br>我们在代码目录下，新建一个文件。叫 <strong>Dockerfile</strong> （注意，file全小写）：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># FROM nginx:1.15-alpine</span>
<span class="token comment"># COPY dist /usr/share/nginx/html</span>
<span class="token comment"># WORKDIR /usr/share/nginx/html</span>
FROM nginx:1.15-alpine
COPY dist /usr/share/nginx/html/jenkins-test-vue/
WORKDIR /usr/share/nginx/html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>此Dockerfile声明了以下步骤：</p> <ol><li>拉取一个 <code>nginx 1.15-alpine</code> 版本的镜像。</li> <li>将当前目录下的 <code>dist</code> <code>文件夹里的内容</code>拷贝到镜像的 <code>/usr/share/nginx/html</code> 文件夹中。</li> <li>声明启动容器时，在 <code>/usr/share/nginx/html</code> 下面执行。</li></ol> <blockquote><p><code>.</code>代表当前路径，即docker容器中的<code>/var/jenkins_home/workspace/项目目录</code>，项目是从gitlab拉取而来<br>
当执行到<code>docker build -t 172.16.81.150:8082/fe/nginx-fe-$timestamp .</code>时，会将<code>.代码的当前路径</code>作为<code>context上下文</code>，并在<code>context</code>中寻找<code>Dockerfile</code>。<br>
同时<code>docker客户端</code>会把<code>上下文</code>中的所有文件发送给<code>docker daemon</code>。<br>
当执行<code>COPY</code>操作时，会在当前<code>上下文</code>中寻找文件，并拷贝到镜像的目标路径<code>/usr/share/nginx/html</code>下，如果目标路径不存在则自动创建目标路径。<br>
不能拷贝上下文之外的文件，否则会报错。<br>
当执行<code>docker run</code>时，容器会拿到镜像里对应路径<code>/usr/share/nginx/html</code>下的所有文件。<br></p></blockquote> <p><br>接着提交到代码库中。<br></p> <p><a name="N6zCG"></a></p> <h2 id="修改-jenkins-执行脚本"><a href="#修改-jenkins-执行脚本" aria-hidden="true" class="header-anchor">#</a> 修改 Jenkins 执行脚本</h2> <p><br>我们打开之前 <code>Jenkins</code> 任务的编辑页面，改为以下脚本：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># set -e</span>
<span class="token comment"># timestamp=`date '+%Y%m%d%H%M%S'`</span>

<span class="token comment"># node -v</span>
<span class="token comment"># npm -v</span>

<span class="token comment"># npm install -g cnpm --registry=https://registry.npm.taobao.org</span>

<span class="token comment"># cnpm install</span>

<span class="token comment"># npm run build</span>

<span class="token comment"># # 编译docker镜像</span>
<span class="token comment"># docker build -t 172.16.81.150:8082/fe/nginx-fe-$timestamp .</span>

<span class="token comment"># # 推送docker镜像到制品库</span>
<span class="token comment"># docker push 172.16.81.150:8082/fe/nginx-fe-$timestamp</span>

<span class="token comment"># # 远程执行命令部署镜像</span>
<span class="token comment"># ssh -o StrictHostKeyChecking=no root@172.16.81.151 &quot;docker pull 172.# 16.81.150:8082/fe/nginx-fe-$timestamp &amp;&amp; \</span>
<span class="token comment"># docker stop jenkins-test &amp;&amp; \</span>
<span class="token comment"># docker rm jenkins-test &amp;&amp; \</span>
<span class="token comment"># docker run -p 80:80 -itd \</span>
<span class="token comment"># --name jenkins-test \</span>
<span class="token comment"># --restart always \</span>
<span class="token comment"># 172.16.81.150:8082/fe/nginx-fe-$timestamp&quot;</span>

<span class="token builtin class-name">set</span> -e
<span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> <span class="token string">'+%Y%m%d%H%M%S'</span><span class="token variable">`</span></span>

node -v
<span class="token function">npm</span> -v
<span class="token function">npm</span> <span class="token function">install</span> -g cnpm --registry<span class="token operator">=</span>https://registry.npm.taobao.org
<span class="token function">rm</span> -rf node_modules/
<span class="token function">rm</span> -rf dist/
cnpm <span class="token function">install</span>
<span class="token function">npm</span> run build

<span class="token comment"># 编译docker镜像</span>
docker build -t <span class="token number">10.211</span>.55.3:8082/fe/nginx-fe-<span class="token variable">$timestamp</span> <span class="token builtin class-name">.</span>

<span class="token comment"># 推送docker镜像到制品库</span>
docker push <span class="token number">10.211</span>.55.3:8082/fe/nginx-fe-<span class="token variable">$timestamp</span>

<span class="token comment"># 远程执行命令部署镜像</span>
<span class="token function">ssh</span> -o <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no root@10.211.55.4 <span class="token string">&quot;docker pull 10.211.55.3:8082/fe/nginx-fe-<span class="token variable">$timestamp</span> &amp;&amp; \
docker stop nginx &amp;&amp; \
docker rm nginx &amp;&amp; \
docker run -p 80:80 -itd \
--name nginx \
--restart always \
10.211.55.3:8082/fe/nginx-fe-<span class="token variable">$timestamp</span>&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><blockquote><p><code>set -e</code> bash如果任何语句的执行结果不是true则应该退出<br>
在shell脚本中，声明一个变量只需要 变量名=值 即可。在命令中用 $-变量名 进行使用。<br>
timestamp=`date '+%Y%m%d%H%M%S'`：这个代表执行 date '+%Y%m%d%H%M%S' 这条命令，并赋值给 timestamp 这个变量。<br>
date '+%Y%m%d%H%M%S' 代表输出当前时间的年月日时分秒。<br></p></blockquote> <blockquote><p>-o StrictHostKeyChecking=no <code>跳过ssh公钥检查</code><br>
比如: ssh root@ip -o StrictHostKeyChecking=no<br>
比如: scp test.txt root@ip:~ -o StrictHostKeyChecking=no<br>
StrictHostKeyChecking: <a href="https://cikeblog.com/ssh-cant-established.html" target="_blank" rel="noopener noreferrer">https://cikeblog.com/ssh-cant-established.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p><strong>如何进入nginx容器</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker <span class="token builtin class-name">exec</span> -it nginx /bin/sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>进入alpine容器</p></blockquote> <p><br>这里可以看到，我们将之前脚本后半部分的流程：<br> <br><strong>压缩打包资源 =&gt; 通过 <strong><strong><code>scp</code></strong></strong> 上传压缩包</strong>** =&gt; <strong><strong><code>ssh</code></strong></strong> 远程执行解压部署命令 <strong><br> <br>替换为：<br></strong><br><strong>Dockerfile构建镜像 =&gt; 上传镜像到制品库 =&gt; 远程执行命令拉取镜像，停止容器，删除容器，启动新拉取的镜像</strong><br></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/9/2020, 9:33:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe-blog/enviroment/deploy/cicd-pro/nexus.html" class="prev">Nexus</a></span> <span class="next"><a href="/fe-blog/enviroment/deploy/cicd-pro/ansible.html">Ansible</a>→
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/fe-blog/assets/js/app.8a3559bf.js" defer></script><script src="/fe-blog/assets/js/2.fbf19223.js" defer></script><script src="/fe-blog/assets/js/25.21f6581b.js" defer></script>
  </body>
</html>
