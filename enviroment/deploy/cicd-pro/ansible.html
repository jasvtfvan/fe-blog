<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ansible | jasvtfvan前端博客</title>
    <meta name="description" content="欢迎来到我的前端工厂">
    <link rel="icon" href="/fe-blog/github.ico">
    
    <link rel="preload" href="/fe-blog/assets/css/0.styles.68cfcd3e.css" as="style"><link rel="preload" href="/fe-blog/assets/js/app.8a3559bf.js" as="script"><link rel="preload" href="/fe-blog/assets/js/2.fbf19223.js" as="script"><link rel="preload" href="/fe-blog/assets/js/11.08202412.js" as="script"><link rel="prefetch" href="/fe-blog/assets/js/10.399f0c01.js"><link rel="prefetch" href="/fe-blog/assets/js/12.cfc10ac9.js"><link rel="prefetch" href="/fe-blog/assets/js/13.bdceb3a3.js"><link rel="prefetch" href="/fe-blog/assets/js/14.0c886dba.js"><link rel="prefetch" href="/fe-blog/assets/js/15.f5d42d2e.js"><link rel="prefetch" href="/fe-blog/assets/js/16.19c927b2.js"><link rel="prefetch" href="/fe-blog/assets/js/17.cc368339.js"><link rel="prefetch" href="/fe-blog/assets/js/18.99786a0e.js"><link rel="prefetch" href="/fe-blog/assets/js/19.2c96aa8f.js"><link rel="prefetch" href="/fe-blog/assets/js/20.feb358f9.js"><link rel="prefetch" href="/fe-blog/assets/js/21.854b8672.js"><link rel="prefetch" href="/fe-blog/assets/js/22.78adf0af.js"><link rel="prefetch" href="/fe-blog/assets/js/23.a8c123d2.js"><link rel="prefetch" href="/fe-blog/assets/js/24.65de2737.js"><link rel="prefetch" href="/fe-blog/assets/js/25.21f6581b.js"><link rel="prefetch" href="/fe-blog/assets/js/26.19b2e629.js"><link rel="prefetch" href="/fe-blog/assets/js/27.b0579100.js"><link rel="prefetch" href="/fe-blog/assets/js/28.a0c1bad8.js"><link rel="prefetch" href="/fe-blog/assets/js/29.3869f6fd.js"><link rel="prefetch" href="/fe-blog/assets/js/3.a5dd7d81.js"><link rel="prefetch" href="/fe-blog/assets/js/30.be6becb7.js"><link rel="prefetch" href="/fe-blog/assets/js/31.e027926c.js"><link rel="prefetch" href="/fe-blog/assets/js/32.dd112bea.js"><link rel="prefetch" href="/fe-blog/assets/js/33.2cdeb0bd.js"><link rel="prefetch" href="/fe-blog/assets/js/34.2eb22cbc.js"><link rel="prefetch" href="/fe-blog/assets/js/35.a1660bb3.js"><link rel="prefetch" href="/fe-blog/assets/js/36.3d49d679.js"><link rel="prefetch" href="/fe-blog/assets/js/37.2c728d3e.js"><link rel="prefetch" href="/fe-blog/assets/js/38.5b00cff3.js"><link rel="prefetch" href="/fe-blog/assets/js/39.bc2ccb29.js"><link rel="prefetch" href="/fe-blog/assets/js/4.54c72001.js"><link rel="prefetch" href="/fe-blog/assets/js/40.fe52d14c.js"><link rel="prefetch" href="/fe-blog/assets/js/41.da19c7de.js"><link rel="prefetch" href="/fe-blog/assets/js/42.82780c8a.js"><link rel="prefetch" href="/fe-blog/assets/js/43.ea864644.js"><link rel="prefetch" href="/fe-blog/assets/js/44.683e33ca.js"><link rel="prefetch" href="/fe-blog/assets/js/45.6ebdb1c6.js"><link rel="prefetch" href="/fe-blog/assets/js/46.d152d9d1.js"><link rel="prefetch" href="/fe-blog/assets/js/5.7519b52c.js"><link rel="prefetch" href="/fe-blog/assets/js/6.60bc9110.js"><link rel="prefetch" href="/fe-blog/assets/js/7.583a8196.js"><link rel="prefetch" href="/fe-blog/assets/js/8.b04d2cae.js"><link rel="prefetch" href="/fe-blog/assets/js/9.f4b536f6.js">
    <link rel="stylesheet" href="/fe-blog/assets/css/0.styles.68cfcd3e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fe-blog/" class="home-link router-link-active"><!----> <span class="site-name">jasvtfvan前端博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fe-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">微信平台</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>公众号</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/wechat/serviceaccount/local-debug.html" class="nav-link">本地调试</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/regexp/" class="nav-link">正则表达式</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/highlights/" class="nav-link">基础集锦</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/promise/" class="nav-link">promise</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">主流框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/source/observer.html" class="nav-link">框架源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/application/base.html" class="nav-link">框架应用</a></li></ul></li><li class="dropdown-item"><h4>react</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/react15/source/native.html" class="nav-link">react15源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/react16/source/fiber.html" class="nav-link">react16源码</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具环境</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/git/" class="nav-link">git/git-flow</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/node/" class="nav-link">node工具</a></li></ul></li><li class="dropdown-item"><h4>系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/mnt.html" class="nav-link">centOS</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/cmd.html" class="nav-link">linux常用命令</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/mac/switch-hosts.html" class="nav-link">mac技巧</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/normal/" class="nav-link">常规部署</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd/" class="nav-link">CI/CD</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/gitlab/" class="nav-link">gitlab搭建</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/docker/" class="nav-link">docker常用容器</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="nav-link">CI/CD综合</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fe-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">微信平台</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>公众号</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/wechat/serviceaccount/local-debug.html" class="nav-link">本地调试</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/regexp/" class="nav-link">正则表达式</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/highlights/" class="nav-link">基础集锦</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/promise/" class="nav-link">promise</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">主流框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/source/observer.html" class="nav-link">框架源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/application/base.html" class="nav-link">框架应用</a></li></ul></li><li class="dropdown-item"><h4>react</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/react15/source/native.html" class="nav-link">react15源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/react16/source/fiber.html" class="nav-link">react16源码</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具环境</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/git/" class="nav-link">git/git-flow</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/node/" class="nav-link">node工具</a></li></ul></li><li class="dropdown-item"><h4>系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/mnt.html" class="nav-link">centOS</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/cmd.html" class="nav-link">linux常用命令</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/mac/switch-hosts.html" class="nav-link">mac技巧</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/normal/" class="nav-link">常规部署</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd/" class="nav-link">CI/CD</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/gitlab/" class="nav-link">gitlab搭建</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/docker/" class="nav-link">docker常用容器</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="nav-link">CI/CD综合</a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="sidebar-link">什么是CI/CD?</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/docker.html" class="sidebar-link">Docker</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html" class="sidebar-link">安装 Jenkins</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/gitlab.html" class="sidebar-link">安装 Gitlab</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/nginx.html" class="sidebar-link">Docker Nginx</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html" class="sidebar-link">Jenkins + Gitlab</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/nexus.html" class="sidebar-link">Nexus</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-nexus.html" class="sidebar-link">Jenkins + Nexus</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/ansible.html" class="active sidebar-link">Ansible</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/ansible.html#介绍与安装" class="sidebar-link">介绍与安装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/ansible.html#什么是-ansible" class="sidebar-link">什么是 Ansible</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/ansible.html#对比-jenkins" class="sidebar-link">对比 Jenkins</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/ansible.html#安装-ansible" class="sidebar-link">安装 Ansible</a></li></ul></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/ansible.html#ansible-内的概念" class="sidebar-link">Ansible 内的概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/ansible.html#基础命令" class="sidebar-link">基础命令</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/ansible.html#modules-模块" class="sidebar-link">Modules 模块</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/ansible.html#inventory-主机清单" class="sidebar-link">Inventory 主机清单</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/ansible.html#playbook-任务剧本" class="sidebar-link">Playbook 任务剧本</a></li></ul></li></ul></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-nexus-ansible.html" class="sidebar-link">Ansible + Jenkins + Nexus</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ansible"><a href="#ansible" aria-hidden="true" class="header-anchor">#</a> Ansible</h1> <h2 id="介绍与安装"><a href="#介绍与安装" aria-hidden="true" class="header-anchor">#</a> 介绍与安装</h2> <h3 id="什么是-ansible"><a href="#什么是-ansible" aria-hidden="true" class="header-anchor">#</a> 什么是 Ansible</h3> <p><br>我们先看网络上对它的解释：</p> <blockquote><p><code>Ansible</code> 是一款简单的运维自动化工具，只需要使用 <code>ssh</code> 协议连接就可以来进行系统管理，自动化执行命令，部署等任务。</p></blockquote> <p><br>显而易见， <code>Ansible</code> 拿来做服务器部署再合适不过。只需要<strong>预制好一份主机清单和要执行的命令步骤</strong>，就可以实现<strong>对一个清单的全部或部分主机远程****批量执行命令</strong>。<br></p> <h3 id="对比-jenkins"><a href="#对比-jenkins" aria-hidden="true" class="header-anchor">#</a> 对比 Jenkins</h3> <p><br>和 <code>Jenkins</code> 做服务部署对比， <code>Ansible</code> 更适合批量执行。<br>以前我们在 <code>Jenkins</code> 做部署，就是脚本执行 <code>ssh</code> 命令远程执行命令。<strong>如果有大量的服务器，那么我们的脚本会写很长，且灵活度会变差</strong>。<br> <br><code>Ansible</code> 还支持<strong>无阻塞异步批量执行命令</strong>，非常方便。**<br></p> <h3 id="安装-ansible"><a href="#安装-ansible" aria-hidden="true" class="header-anchor">#</a> 安装 Ansible</h3> <h4 id="使用-dockerfile-制作镜像"><a href="#使用-dockerfile-制作镜像" aria-hidden="true" class="header-anchor">#</a> 使用 Dockerfile 制作镜像</h4> <p><br><code>Ansible</code> 目前的部署方式没有 <code>Docker</code> 安装，但我们可以定制一份 <code>Ansible</code> 镜像。<br> <br>因为 <code>Ansible</code> 批量执行服务器时，还是采用的 <code>ssh</code> 进行操作，所以我们还是需要配置公钥私钥。**我们可以找一个已经在目标服务器配置过的公钥，和它配套的私钥一起打到 **<code>**Ansible**</code><strong>镜像内。这样我们就可以实现 <code>Ansible</code> 免密登录。</strong><br> <br>但是，ssh连接时还涉及到一个叫做 <code>known_hosts</code> 文件。这个文件的主要作用是：<br></p> <blockquote><p>当你用ssh连接到一个新的服务器的时候，ssh会让你确认服务器的信息（域名、IP、公钥），如果你确认了，就会将其写到 known_hosts 文件内。
以后你再连接到这个服务器，但是信息改变了（通常是公钥改变了），就会提示你服务器信息改变了，你可以把服务器信息它从 known_hosts 里删除，然后重新确认一份新的服务器信息。</p></blockquote> <p><br>但是在我们这里该文件作用不大，我们就可以在 <code>Ansible</code> 内配置 <code>host_key_checking = False</code> 和 <code>host_key_checking = False</code> 这两个选项来关闭这个校验（下方dockerfile内有写）。**直接使用公钥私钥配对成功就可以进行连接。**我们将公钥私钥放在 <code>ssh</code> 文件夹内即可：<br> <img src="/fe-blog/assets/img/ansible-folder.28dc5764.png" alt="image"><br>除了公钥私钥外，我们还需要准备一份 <code>主机清单</code>，命名为 <code>hosts</code>。**清单里面声明了要批量执行的主机。**这里可以先简单写一下，下一章我们会详细描述清单的语法格式。**最简单的****格式使用中括号声明主机组名称，换行写IP即可。**如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">vim</span> ./hosts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>fe-servers<span class="token punctuation">]</span>
<span class="token number">172.16</span>.81.151
<span class="token number">172.16</span>.81.152
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><strong>将公钥添加到目标服务器<code>authorized_keys</code>中</strong></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>ssh-copy-id -i ./ssh/id_rsa.pub root@172.16.81.151
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>目标服务器<code>(172.16.81.151)</code>如果没有<code>公钥/私钥</code>需要使用<code>ssh-keygen -t rsa</code>生成</p></blockquote> <p><img src="/fe-blog/assets/img/ansible-hosts.5b4c95ef.png" alt="image"><br> <br>这里我们使用 <code>Centos7</code> 做镜像底座，用 <code>Dockerfile</code> 做镜像：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>FROM centos:7
<span class="token comment"># 安装必要依赖，openssh-clients是为了支持ssh连接</span>
RUN yum -y <span class="token function">install</span> <span class="token function">wget</span> <span class="token function">curl</span> <span class="token function">vim</span> openssh-clients
RUN <span class="token function">wget</span> -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
RUN yum clean all
RUN yum makecache
<span class="token comment"># 拷贝公钥私钥进镜像内</span>
COPY <span class="token function">ssh</span> /root/.ssh/
<span class="token comment"># 公钥私钥赋权</span>
RUN <span class="token function">chmod</span> <span class="token number">755</span> ~/.ssh/
RUN <span class="token function">chmod</span> <span class="token number">600</span> ~/.ssh/id_rsa ~/.ssh/id_rsa.pub
<span class="token comment"># 安装 ansible</span>
RUN yum -y <span class="token function">install</span> ansible
<span class="token comment"># 拷贝主机组清单进 ansible 目录</span>
COPY hosts /etc/ansible/
<span class="token comment"># 关闭 known_hosts 校验</span>
RUN <span class="token function">sed</span> -i <span class="token string">'s/^#host_key_checking = False/host_key_checking = False/'</span> /etc/ansible/ansible.cfg
RUN ansible --version
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><blockquote><p>sed -i ... ... 代表在<code>主配置文件</code>中<code>把#host_key_checking = False的#去掉</code></p></blockquote> <p>使用 <code>docker build</code> 命令打包为镜像，版本为t1：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker build -t ansible:t1 <span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="启动容器并测试"><a href="#启动容器并测试" aria-hidden="true" class="header-anchor">#</a> 启动容器并测试</h4> <p><br>等待 <code>build</code> 完成后，使用 <code>docker run</code> 命令启动容器：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker run -itd --name ansible ansible:t1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>因为ansible并没有可视化界面，所以不需要分配端口</p></blockquote> <p><br>启动后，使用 <code>docker exec</code> + <code>ansible command</code> 命令测试 <code>ansible</code> 安装，并远程执行一个命令测试：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker <span class="token builtin class-name">exec</span> -it ansible ansible all -m <span class="token builtin class-name">command</span> -a <span class="token string">&quot;chdir=~ docker ps&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>ansible all: 代表匹配所有主机组的所有主机<br>
command：Ansible 命令模块。代表执行一个命令<br>
chdir=~：chdir 在哪里执行命令<br>
docker ps：查看正在跑的docker容器<br></p></blockquote> <p><br>执行成功后，如下图（我的主机组配置了2台机器，一台可以连接另一台不存在）：<br><img src="/fe-blog/assets/img/ansible-success.52984a8c.png" alt="image"><br> <br>到这里，我们的 <code>Ansible</code> 就安装成功</p> <hr> <h2 id="ansible-内的概念"><a href="#ansible-内的概念" aria-hidden="true" class="header-anchor">#</a> Ansible 内的概念</h2> <p><strong>先进入docker，下文都基于docker容器内部执行</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker <span class="token builtin class-name">exec</span> -it ansible /bin/bash
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>如果ansible不是自启动可以更新为自启动<br>
docker container update --restart=always ansible</p></blockquote> <h3 id="基础命令"><a href="#基础命令" aria-hidden="true" class="header-anchor">#</a> 基础命令</h3> <p><br>安装好 <code>Ansible</code> 后，使用 <code>ansible</code> 命令即可完成基础操作。例如以下命令可以测试你的所有主机的连通性：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ansible all -m <span class="token function">ping</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p><code>-m</code> 代表使用 <code>ansible</code>  某个模块，后紧跟模块名
all代表匹配所有主机组，这里也可以传入指定的主机组名称。</p></blockquote> <p><br>如果想查看有哪些模块：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ansible-doc -l
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><br>想查看模块的具体帮助，比如fetch模块：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ansible-doc -s fetch
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="modules-模块"><a href="#modules-模块" aria-hidden="true" class="header-anchor">#</a> Modules 模块</h3> <h4 id="copy"><a href="#copy" aria-hidden="true" class="header-anchor">#</a> copy</h4> <p>文件拷贝模块：将 <code>Ansible</code> 主机下的目录拷贝到目标机器。例如将 <code>Ansible</code> 主机内的  <code>/testdir/copytest</code> 目录拷贝到目标机器 <code>/opt</code> 下。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ansible all -m copy -a <span class="token string">&quot;src=/testdir/copytest dest=/opt&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>mkdir -p /testdir/copytest<br>
touch /testdir/copytest/aa</p></blockquote> <h4 id="file"><a href="#file" aria-hidden="true" class="header-anchor">#</a> file</h4> <p>文件操作模块：可以对目标机器进行新建和删除文件。例如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ansible all -m file -a &quot;path=/testdir/testfile state=touch&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>在目标机器下新建 /testdir/testfile 文件</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>ansible all -m file -a &quot;path=/testdir/testfile state=absent&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>在目标机器下删除 /testdir/testfile 文件</p></blockquote> <h4 id="find"><a href="#find" aria-hidden="true" class="header-anchor">#</a> find</h4> <p>文件查找模块：可以查找目标机器内的文件。例如查找 <code>/testdir</code> 文件夹下包含 <code>abc</code> 字符串的文件：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ansible all -m find -a 'paths=/testdir contains=&quot;.*abc.*&quot;'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="replace"><a href="#replace" aria-hidden="true" class="header-anchor">#</a> replace</h4> <p>文件内容替换模块：可以在指定文件中通过正则匹配指定内容进行替换。例如在 <code>/testdir/test</code> 文件夹内，查找符合正则 <code>abc</code> 的内容，替换为 <code>buck</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ansible all -m replace -a 'path=/testdir/test  regexp=&quot;abc&quot; replace=buck'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="command"><a href="#command" aria-hidden="true" class="header-anchor">#</a> command</h4> <p>命令模块：可以在目标机器内执行命令。<br><strong>和shell命令不同的是，shell中的 <code>&lt;</code> , <code>&gt;</code> , <code>|</code> , <code>;</code> , <code>&amp;</code> , <code>$</code> 等特殊字符不能在command模块中使用，如果需要使用，则用shell模块。</strong><br>例如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ansible all -m command -a &quot;chdir=/testdir ls&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>在目标机器 /testdir 目录下执行 ls命令</p></blockquote> <p><br>更详细的介绍，可以参考：<a href="https://www.cnblogs.com/yanjieli/p/10969143.html" target="_blank" rel="noopener noreferrer"><strong>链接</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br></p> <h3 id="inventory-主机清单"><a href="#inventory-主机清单" aria-hidden="true" class="header-anchor">#</a> Inventory 主机清单</h3> <p><br>主机清单是 <code>Ansible</code> 最基础的概念，它声明了 <code>Ansible</code> <strong>到底在哪些机器上执行命令</strong>。主机清单默认是 <code>/etc/ansible/hosts</code> 文件。<br>主机清单语法花样也很多。<strong>不仅可以保存主机清单，还可以定义主机密码，授权方式等其他信息</strong>。<br> <br>一般在 <code>Ansible</code> 内，都是以 <code>组</code> 为集合管理主机。被称为 <code>主机组</code> ，一个主机组内有许多主机。<br> <br>最简单的主机组声明：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[apache]
192.168.1.36
192.168.1.33
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>其中， <code>apache</code> 是主机组名，下面是组内的主机IP。<br></p> <h4 id="使用密码连接"><a href="#使用密码连接" aria-hidden="true" class="header-anchor">#</a> 使用密码连接</h4> <p><br>在主机组内，可以在清单内定义主机密码，端口等信息。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># 方法一 主机+端口+密码
[webserver]
192.168.1.31 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=&quot;123456&quot;
192.168.1.32 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=&quot;123456&quot;
192.168.1.33 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=&quot;123456&quot;
192.168.1.36 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=&quot;123456&quot;


# 方法二 主机+端口+密码
[webserver]
192.168.1.3[1:3] ansible_ssh_user=root ansible_ssh_pass=&quot;123456&quot;


# 方法二 主机+端口+密码
[webserver]
192.168.1.3[1:3]
[webserver:vars]
ansible_ssh_pass=&quot;123456&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><blockquote><p>192.168.1.3[1:3]：代表 192.168.1.31 和 192.168.1.33</p></blockquote> <h4 id="使用密钥连接"><a href="#使用密钥连接" aria-hidden="true" class="header-anchor">#</a> 使用密钥连接</h4> <p><br>当然，最常用的就是密钥连接服务器。这种情况下，我们只需要定义最简单的主机组，将Ansible机器公钥在目标机器配置即可。<br> <br>更多花样玩法 =&gt; <a href="https://www.cnblogs.com/yanjieli/p/10969089.html#380920160" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/yanjieli/p/10969089.html#380920160<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br></p> <h3 id="playbook-任务剧本"><a href="#playbook-任务剧本" aria-hidden="true" class="header-anchor">#</a> Playbook 任务剧本</h3> <p><br>任务剧本（任务集），yaml格式文件，定义 Ansible 任务的配置文件。作用有点像 <code>Dockerfile</code> 。<strong>是一组任务的集合声明文件</strong><br>示例如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token key atrule">timestamp</span><span class="token punctuation">:</span> <span class="token number">20200625233149</span>
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker pull new images
      <span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">'chdir=~ docker pull 172.16.81.150:8082/fe/nginx-fe-{{timestamp}}'</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker rmf
      <span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">'chdir=~ docker ps | grep jenkins-test &amp;&amp; docker rm -f jenkins-test'</span>
      <span class="token key atrule">ignore_errors</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker run
      <span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">'chdir=~ docker run -p 80:80 -itd --name jenkins-test 172.16.81.150:8082/fe/nginx-fe-{{timestamp}}'</span>
      
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ul><li>hosts: 指定在哪个主机组执行该任务集合。 <code>all</code> 代表全部主机</li> <li>remote_user: 使用哪个用户进行远程执行</li> <li>vars: 定义变量的地方。在下方任务命令中可以使用 <code></code> 使用变量</li> <li>tasks: 任务集合</li> <li>shell: <code>Ansible</code> 的 <code>shell</code> 模块，上面有讲解模块的作用和类型。后面跟着模块的命令</li></ul> <p><br>更详细的语法：<a href="https://www.cnblogs.com/yanjieli/p/10969299.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/yanjieli/p/10969299.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br></p> <h4 id="执行-playbook"><a href="#执行-playbook" aria-hidden="true" class="header-anchor">#</a> 执行 Playbook</h4> <p><br>可以使用 <code>ansible-playbook</code> 命令执行 <code>playbook</code> ：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ansible-playbook test.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><br>使用 <code>--syntax-check</code> 命令测试 playbook 语法是否正确</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ansible-playbook --syntax-check test.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><br>测试playbook执行（并不会真的在主机组上执行，只是模拟）：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ansible-playbook --check test.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><br>替换playbook中默认的变量值，并执行playbook。在这种情况下，<strong>命令行传入参数 &gt; 默认值</strong>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ansible-playbook -e <span class="token string">&quot;timestamp=212123323&quot;</span> test.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/9/2020, 9:33:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-nexus.html" class="prev">Jenkins + Nexus</a></span> <span class="next"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-nexus-ansible.html">Ansible + Jenkins + Nexus</a>→
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/fe-blog/assets/js/app.8a3559bf.js" defer></script><script src="/fe-blog/assets/js/2.fbf19223.js" defer></script><script src="/fe-blog/assets/js/11.08202412.js" defer></script>
  </body>
</html>
