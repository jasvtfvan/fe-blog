<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>安装 Jenkins | jasvtfvan前端博客</title>
    <meta name="description" content="欢迎来到我的前端工厂">
    <link rel="icon" href="/fe-blog/github.ico">
    
    <link rel="preload" href="/fe-blog/assets/css/0.styles.68cfcd3e.css" as="style"><link rel="preload" href="/fe-blog/assets/js/app.8a3559bf.js" as="script"><link rel="preload" href="/fe-blog/assets/js/2.fbf19223.js" as="script"><link rel="preload" href="/fe-blog/assets/js/4.54c72001.js" as="script"><link rel="prefetch" href="/fe-blog/assets/js/10.399f0c01.js"><link rel="prefetch" href="/fe-blog/assets/js/11.08202412.js"><link rel="prefetch" href="/fe-blog/assets/js/12.cfc10ac9.js"><link rel="prefetch" href="/fe-blog/assets/js/13.bdceb3a3.js"><link rel="prefetch" href="/fe-blog/assets/js/14.0c886dba.js"><link rel="prefetch" href="/fe-blog/assets/js/15.f5d42d2e.js"><link rel="prefetch" href="/fe-blog/assets/js/16.19c927b2.js"><link rel="prefetch" href="/fe-blog/assets/js/17.cc368339.js"><link rel="prefetch" href="/fe-blog/assets/js/18.99786a0e.js"><link rel="prefetch" href="/fe-blog/assets/js/19.2c96aa8f.js"><link rel="prefetch" href="/fe-blog/assets/js/20.feb358f9.js"><link rel="prefetch" href="/fe-blog/assets/js/21.854b8672.js"><link rel="prefetch" href="/fe-blog/assets/js/22.78adf0af.js"><link rel="prefetch" href="/fe-blog/assets/js/23.a8c123d2.js"><link rel="prefetch" href="/fe-blog/assets/js/24.65de2737.js"><link rel="prefetch" href="/fe-blog/assets/js/25.21f6581b.js"><link rel="prefetch" href="/fe-blog/assets/js/26.19b2e629.js"><link rel="prefetch" href="/fe-blog/assets/js/27.b0579100.js"><link rel="prefetch" href="/fe-blog/assets/js/28.a0c1bad8.js"><link rel="prefetch" href="/fe-blog/assets/js/29.3869f6fd.js"><link rel="prefetch" href="/fe-blog/assets/js/3.a5dd7d81.js"><link rel="prefetch" href="/fe-blog/assets/js/30.be6becb7.js"><link rel="prefetch" href="/fe-blog/assets/js/31.e027926c.js"><link rel="prefetch" href="/fe-blog/assets/js/32.dd112bea.js"><link rel="prefetch" href="/fe-blog/assets/js/33.2cdeb0bd.js"><link rel="prefetch" href="/fe-blog/assets/js/34.2eb22cbc.js"><link rel="prefetch" href="/fe-blog/assets/js/35.a1660bb3.js"><link rel="prefetch" href="/fe-blog/assets/js/36.3d49d679.js"><link rel="prefetch" href="/fe-blog/assets/js/37.2c728d3e.js"><link rel="prefetch" href="/fe-blog/assets/js/38.5b00cff3.js"><link rel="prefetch" href="/fe-blog/assets/js/39.bc2ccb29.js"><link rel="prefetch" href="/fe-blog/assets/js/40.fe52d14c.js"><link rel="prefetch" href="/fe-blog/assets/js/41.da19c7de.js"><link rel="prefetch" href="/fe-blog/assets/js/42.82780c8a.js"><link rel="prefetch" href="/fe-blog/assets/js/43.ea864644.js"><link rel="prefetch" href="/fe-blog/assets/js/44.683e33ca.js"><link rel="prefetch" href="/fe-blog/assets/js/45.6ebdb1c6.js"><link rel="prefetch" href="/fe-blog/assets/js/46.d152d9d1.js"><link rel="prefetch" href="/fe-blog/assets/js/5.7519b52c.js"><link rel="prefetch" href="/fe-blog/assets/js/6.60bc9110.js"><link rel="prefetch" href="/fe-blog/assets/js/7.583a8196.js"><link rel="prefetch" href="/fe-blog/assets/js/8.b04d2cae.js"><link rel="prefetch" href="/fe-blog/assets/js/9.f4b536f6.js">
    <link rel="stylesheet" href="/fe-blog/assets/css/0.styles.68cfcd3e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fe-blog/" class="home-link router-link-active"><!----> <span class="site-name">jasvtfvan前端博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fe-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">微信平台</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>公众号</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/wechat/serviceaccount/local-debug.html" class="nav-link">本地调试</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/regexp/" class="nav-link">正则表达式</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/highlights/" class="nav-link">基础集锦</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/promise/" class="nav-link">promise</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">主流框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/source/observer.html" class="nav-link">框架源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/application/base.html" class="nav-link">框架应用</a></li></ul></li><li class="dropdown-item"><h4>react</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/react15/source/native.html" class="nav-link">react15源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/react16/source/fiber.html" class="nav-link">react16源码</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具环境</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/git/" class="nav-link">git/git-flow</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/node/" class="nav-link">node工具</a></li></ul></li><li class="dropdown-item"><h4>系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/mnt.html" class="nav-link">centOS</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/cmd.html" class="nav-link">linux常用命令</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/mac/switch-hosts.html" class="nav-link">mac技巧</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/normal/" class="nav-link">常规部署</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd/" class="nav-link">CI/CD</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/gitlab/" class="nav-link">gitlab搭建</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/docker/" class="nav-link">docker常用容器</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="nav-link">CI/CD综合</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fe-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">微信平台</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>公众号</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/wechat/serviceaccount/local-debug.html" class="nav-link">本地调试</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/regexp/" class="nav-link">正则表达式</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/highlights/" class="nav-link">基础集锦</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/promise/" class="nav-link">promise</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">主流框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/source/observer.html" class="nav-link">框架源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/application/base.html" class="nav-link">框架应用</a></li></ul></li><li class="dropdown-item"><h4>react</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/react15/source/native.html" class="nav-link">react15源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/react16/source/fiber.html" class="nav-link">react16源码</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具环境</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/git/" class="nav-link">git/git-flow</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/node/" class="nav-link">node工具</a></li></ul></li><li class="dropdown-item"><h4>系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/mnt.html" class="nav-link">centOS</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/cmd.html" class="nav-link">linux常用命令</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/mac/switch-hosts.html" class="nav-link">mac技巧</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/normal/" class="nav-link">常规部署</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd/" class="nav-link">CI/CD</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/gitlab/" class="nav-link">gitlab搭建</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/docker/" class="nav-link">docker常用容器</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="nav-link">CI/CD综合</a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="sidebar-link">什么是CI/CD?</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/docker.html" class="sidebar-link">Docker</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html" class="active sidebar-link">安装 Jenkins</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html#jenkins-是啥" class="sidebar-link">Jenkins 是啥</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html#安装-docker" class="sidebar-link">安装 Docker</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html#安装防火墙" class="sidebar-link">安装防火墙</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html#_1-使用-dockerfile-构建-jenkins-镜像" class="sidebar-link">1. 使用 DockerFile 构建 Jenkins 镜像</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html#docker-in-docker" class="sidebar-link">Docker in Docker</a></li></ul></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html#_2-构建-jenkins-镜像" class="sidebar-link">2. 构建 Jenkins 镜像</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html#_3-启动镜像" class="sidebar-link">3. 启动镜像</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html#_4-启动-jenkins" class="sidebar-link">4. 启动 Jenkins</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html#_5-初始化-jenkins-配置" class="sidebar-link">5. 初始化 Jenkins 配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html#解锁-jenkins" class="sidebar-link">解锁 Jenkins</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html#下载插件" class="sidebar-link">下载插件</a></li></ul></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html#_6-完成安装" class="sidebar-link">6. 完成安装</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html#_7-测试安装" class="sidebar-link">7. 测试安装</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html#_8-结束" class="sidebar-link">8. 结束</a></li></ul></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/gitlab.html" class="sidebar-link">安装 Gitlab</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/nginx.html" class="sidebar-link">Docker Nginx</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html" class="sidebar-link">Jenkins + Gitlab</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/nexus.html" class="sidebar-link">Nexus</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-nexus.html" class="sidebar-link">Jenkins + Nexus</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/ansible.html" class="sidebar-link">Ansible</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-nexus-ansible.html" class="sidebar-link">Ansible + Jenkins + Nexus</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="安装-jenkins"><a href="#安装-jenkins" aria-hidden="true" class="header-anchor">#</a> 安装 Jenkins</h1> <h2 id="jenkins-是啥"><a href="#jenkins-是啥" aria-hidden="true" class="header-anchor">#</a> Jenkins 是啥</h2> <p><br><code>Jenkins</code> 是一个基于Java语言开发的CI持续构建工具，主要用于持续、自动的构建/测试软件项目。<br>它可以执行你预先设定好的设置和脚本，也可以和 Git工具做集成，实现自动触发和定时触发器构建。</p> <h2 id="安装-docker"><a href="#安装-docker" aria-hidden="true" class="header-anchor">#</a> 安装 Docker</h2> <p><br>在这里，我们使用 <code>Docker</code> 安装 <code>Jenkins</code> 服务，在安装前，需要先安装 <code>Docker</code> 环境 :<br></p> <h2 id="安装防火墙"><a href="#安装防火墙" aria-hidden="true" class="header-anchor">#</a> 安装防火墙</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>yum <span class="token function">install</span> firewalld systemd -y
<span class="token function">service</span> firewalld start
firewall-cmd --permanent --add-service<span class="token operator">=</span>http
firewall-cmd --permanent --add-rich-rule<span class="token operator">=</span><span class="token string">&quot;rule family=&quot;</span>ipv4<span class="token string">&quot; source address=&quot;</span><span class="token number">172.16</span>.0.0/16<span class="token string">&quot; accept&quot;</span>
systemctl reload firewalld
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>pemmanent: 表示永久生效，若不加 --permanent 系统下次启动后就会失效。
systemctl：<a href="https://www.cnblogs.com/zwcry/p/9602756.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/zwcry/p/9602756.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
firewall-cmd：<a href="https://blog.csdn.net/s_p_j/article/details/80979450" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/s_p_j/article/details/80979450<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <blockquote><p>add-rich-rule：<strong>添加一条放行规则。作用是允许docker容器之间可以走宿主机互相访问。</strong> <strong>其中，172.16.0.0是宿主机网段，/16代表匹配所有网段内的IP：</strong><a href="https://blog.csdn.net/aerchi/article/details/39396423?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.nonecase&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.nonecase" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/aerchi/article/details/39396423?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.nonecase&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.nonecase<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h2 id="_1-使用-dockerfile-构建-jenkins-镜像"><a href="#_1-使用-dockerfile-构建-jenkins-镜像" aria-hidden="true" class="header-anchor">#</a> 1. 使用 DockerFile 构建 Jenkins 镜像</h2> <p><br>我们都知道，每个Docker容器，都是一个独立的，与外界隔离的操作系统环境。<strong>在使用 Jenkins 服务进行构建时，用户写的 <strong><strong><code>Shell</code></strong></strong> 脚本，也只会在容器内执行。</strong><br> <br>但我们问题来了，我们想让容器部署的 <code>Jenkins</code> 可以构建 <code>Docker</code> 镜像，只有2种办法：<br></p> <ol><li>加一台 <code>Jenkins</code> master 节点，构建机内安装 <code>Docker</code> 环境。这样我们就可以执行远程构建。</li> <li><strong>宿主机的Docker环境，移花接木到容器内部，在容器内部执行Docker命令构建镜像。</strong></li></ol> <p>这就是我们要讲的重磅知识点：<strong>Docker in Docker</strong></p> <h3 id="docker-in-docker"><a href="#docker-in-docker" aria-hidden="true" class="header-anchor">#</a> Docker in Docker</h3> <h4 id="原理"><a href="#原理" aria-hidden="true" class="header-anchor">#</a> 原理</h4> <p><br>那什么是 <code>Docker in Docker</code> 呢？<br> <br>Docker 采用的是C/S（即Client/Server）架构。我们在执行 <code>docker xxx</code> 等命令时，<strong>其实是使用 <code>Client</code> 在和<code>docker engine</code> 在进行通信。</strong></p> <p>我们在安装 Docker CE 时，会生成一个 <code>systemd service</code> 服务。这个服务启动时，就是 <code>Docker Engine</code> 服务。默认情况下，Docker守护进程会生成一个 socket（<code>/var/run/docker.sock</code>）文件来进行本地进程通信，因此只能在本地使用 docker 客户端或者使用 Docker API 进行操作。<br></p> <blockquote><p>*.sock文件：sock 文件是 UNIX 域套接字，它可以通过文件系统（而非网络地址）进行寻址和访问。</p></blockquote> <p><br>因此，只要把<strong>宿主机的Docker套接字通过Docker数据卷挂载到容器内部</strong>，就能实现在容器内使用Docker命令（如下图）。
<img src="/fe-blog/assets/img/docker-in-docker.f0d13333.png" alt="image"><br></p> <h4 id="使用"><a href="#使用" aria-hidden="true" class="header-anchor">#</a> 使用</h4> <p>下方的命令，就是 <code>Docker in Docker</code> 的使用。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker run <span class="token punctuation">..</span>. -v /var/run/docker.sock:/var/run/docker.sock
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><br>所以，我们要实现在Jenkins内部访问宿主机docker，要写一个DockerFile进行二次镜像构建。<br>此DockerFile的作用，就是为了安装容器使用宿主机 <code>Docker</code> 缺少的依赖。这里我们在容器内安装 <code>libltdl7</code> 。<br></p> <blockquote><p>如果不写DockerFile进行构建也可以，亲测直接挂Docker套接字进容器后会有依赖缺失问题，，，，这个方法只针对Jenkins镜像</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">vi</span> Dockerfile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>FROM jenkins/jenkins
<span class="token environment constant">USER</span> root
<span class="token comment"># 清除了基础镜像设置的源，切换成阿里云源</span>
RUN <span class="token builtin class-name">echo</span> <span class="token string">''</span> <span class="token operator">&gt;</span> /etc/apt/sources.list.d/jessie-backports.list <span class="token punctuation">\</span>
  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;deb http://mirrors.aliyun.com/debian jessie main contrib non-free&quot;</span> <span class="token operator">&gt;</span> /etc/apt/sources.list <span class="token punctuation">\</span>
  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;deb http://mirrors.aliyun.com/debian jessie-updates main contrib non-free&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/apt/sources.list <span class="token punctuation">\</span>
  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;deb http://mirrors.aliyun.com/debian-security jessie/updates main contrib non-free&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/apt/sources.list
<span class="token comment"># 更新源并安装缺少的包</span>
RUN <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y libltdl7
ARG <span class="token assign-left variable">dockerGid</span><span class="token operator">=</span><span class="token number">999</span>

RUN <span class="token builtin class-name">echo</span> <span class="token string">&quot;docker:x:<span class="token variable">${dockerGid}</span>:jenkins&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/group
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="_2-构建-jenkins-镜像"><a href="#_2-构建-jenkins-镜像" aria-hidden="true" class="header-anchor">#</a> 2. 构建 Jenkins 镜像</h2> <p><br>这样的话，我们就不能直接使用官方的 <code>Jenkins</code> 镜像进行构建，需要用 <code>DockerFile</code> 先构建一份自己的 <code>Jenkins</code> 镜像。使用 <code>docker build</code> 命令构建镜像</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker build -t local/jenkins <span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>-t：镜像的名字及tag，通常name:tag或者name格式；可以在一次构建中为一个镜像设置多个tag</p></blockquote> <br>
![image](./images/jenkins/build-jenkins.png)<br>
如果提示 `Successfully tagged local/jenkins:latest` 则构建成功
<h2 id="_3-启动镜像"><a href="#_3-启动镜像" aria-hidden="true" class="header-anchor">#</a> 3. 启动镜像</h2> <p><br>我们将Jenkins用户目录外挂到宿主机内，先新建一个 <code>/home/jenkins</code> 目录，并设置权限：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">mkdir</span> /home/jenkins
<span class="token function">chown</span> -R <span class="token number">1000</span> /home/jenkins/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><br>接下来我们用镜像创建容器并启动：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker run -itd --name jenkins -p <span class="token number">8080</span>:8080 -p <span class="token number">50000</span>:50000 <span class="token punctuation">\</span>
-v /var/run/docker.sock:/var/run/docker.sock <span class="token punctuation">\</span>
-v /usr/bin/docker:/usr/bin/docker <span class="token punctuation">\</span>
-v /home/jenkins:/var/jenkins_home <span class="token punctuation">\</span>
--restart always <span class="token punctuation">\</span>
--user root local/jenkins
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>-itd: 由 -i -t -d命令组合而成
-i: 开启容器内的交互模式，允许用户可以进入容器进行输入交互
-t: 分配一个虚拟终端
-d: 允许容器以后台运行（不加的话只能前台运行，退出终端容器就停止了）
--name: 容器名称
-p: 将容器内的端口映射到宿主机的端口。格式为：宿主机端口:容器端口
-v: 将宿主机内的文件挂载到容器目录下。格式为：宿主机目录:容器目录
--user: 指定用户启动
--restart: 当 Docker 重启时，容器自动启动，否则就需要使用 docker restart 手动启动</p></blockquote> <p><br>启动后，会返回一串ID值，这就是 <code>容器ID</code> 值。<br> <br>执行 <code>docker ps</code> 命令，查看Jenkins容器是否在列表内。如果在列表内，说明启动成功<br> <img src="/fe-blog/assets/img/docker-ps-jenkins.3b8d6b11.png" alt="image"><br></p> <blockquote><p>提示：如果执行docker ps 后容器没有在列表内，多半是启动失败。可以加-a参数查看所有已经生成的容器的运行状态。
如果想进一步查看原因，可以使用docker logs -f &lt;容器ID&gt; 查看容器内日志输出。</p></blockquote> <h2 id="_4-启动-jenkins"><a href="#_4-启动-jenkins" aria-hidden="true" class="header-anchor">#</a> 4. 启动 Jenkins</h2> <p><br>首先我们在防火墙添加 <code>8080</code> 和 <code>50000</code> 端口的放行，并重载防火墙</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>firewall-cmd --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">8080</span>/tcp --permanent
firewall-cmd --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">50000</span>/tcp --permanent
systemctl reload firewalld
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><br>容器启动后，访问 <code>宿主机IP:8080</code> 。如果看到以下界面，代表正在启动。<br>Jenkins第一次的启动时间一般比较长（视机器性能而看）<br> <img src="/fe-blog/assets/img/waiting-jenkins.56deb1cb.png" alt="image"></p> <h2 id="_5-初始化-jenkins-配置"><a href="#_5-初始化-jenkins-配置" aria-hidden="true" class="header-anchor">#</a> 5. 初始化 Jenkins 配置</h2> <h3 id="解锁-jenkins"><a href="#解锁-jenkins" aria-hidden="true" class="header-anchor">#</a> 解锁 Jenkins</h3> <p><br>Jenkins 启动完成后，会跳转至这个界面解锁 Jenkins。<br> <img src="/fe-blog/assets/img/unlock-jenkins.1017688e.png" alt="image"><br>Jenkins启动后，会生成一个 <code>初始密码</code> ，该密码在 Jenkins 容器内存放，可以进入容器后查看密码内容。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker <span class="token builtin class-name">exec</span> -it jenkins /bin/bash
<span class="token function">cat</span> /var/jenkins_home/secrets/initialAdminPassword
<span class="token builtin class-name">exit</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>docker exec: 进入一个已启动的容器内，执行命令
cat：查看文件内容。如果逐步查看可以用more命令
-it: -i -t的组合
-i: 即使没有附加也保持STDIN 打开
-t: 分配一个伪终端</p></blockquote> <p><img src="/fe-blog/assets/img/cat-jenkins-passwd.86534a7d.png" alt="image">
输入配置文件中的密码，解锁 Jenkins<br></p> <h3 id="下载插件"><a href="#下载插件" aria-hidden="true" class="header-anchor">#</a> 下载插件</h3> <p><br>解锁后，来到了插件下载页面。先进入容器配置一下清华大学的Jenkins插件源后，再安装插件。所以先不要点。<br> <img src="/fe-blog/assets/img/init-jenkins-plugins.0dd2c3b6.png" alt="image"><br> <br><strong>进入容器，查找  <code>default.json</code>  文件</strong>，把镜像源替换进去，替换后退出容器终端</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker <span class="token builtin class-name">exec</span> -it jenkins /bin/bash
<span class="token function">find</span> / -name <span class="token string">'default.json'</span>
<span class="token function">sed</span> -i <span class="token string">'s/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g'</span> /var/jenkins_home/updates/default.json <span class="token operator">&amp;&amp;</span> <span class="token function">sed</span> -i <span class="token string">'s/http:\/\/www.google.com/https:\/\/www.baidu.com/g'</span> /var/jenkins_home/updates/default.json
<span class="token builtin class-name">exit</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><br>然后重启容器，重新访问界面，解锁后安装推荐插件</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker restart jenkins
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_6-完成安装"><a href="#_6-完成安装" aria-hidden="true" class="header-anchor">#</a> 6. 完成安装</h2> <p><br>接下来一路按照提示配置，直到看到以下界面代表安装成功：<br> <br><img src="/fe-blog/assets/img/finish-jenkins-install.27492bda.png" alt="image"><br></p> <h2 id="_7-测试安装"><a href="#_7-测试安装" aria-hidden="true" class="header-anchor">#</a> 7. 测试安装</h2> <p><br>我们点击 Jenkins 首页 -&gt; 左侧导航 -&gt; 新建任务 -&gt; 构建一个自由风格的软件项目<br> <br><img src="/fe-blog/assets/img/jenkins-freedom-pj.6b84f30d.png" alt="image"><br> <br>找到 <code>构建</code> 一项，选择 “增加构建步骤”，选择 <code>执行Shell</code> ，输入以下命令：<br> <br>此命令是去拉取一个nodejs稳定版镜像</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker -v
docker pull node:latest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="/fe-blog/assets/img/jenkins-first-shell.e080f6a7.png" alt="image"><br>保存后，我们点击左侧菜单的 “立即构建”，Jenkins就会开始构建。选择左侧历史记录第一项（最新的一项），点击控制台输出，查看构建日志。<br> <img src="/fe-blog/assets/img/jenkins-first-console.a351bbb7.png" alt="image"><br> <br>Jenkins构建任务为蓝色灯，代表构建成功。红色灯代表构建失败<br> <img src="/fe-blog/assets/img/jenkins-build-status.eb60aac4.png" alt="image"></p> <h2 id="_8-结束"><a href="#_8-结束" aria-hidden="true" class="header-anchor">#</a> 8. 结束</h2> <p><br>到这里，我们的Jenkins就代表安装完成了<br></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/9/2020, 9:33:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe-blog/enviroment/deploy/cicd-pro/docker.html" class="prev">Docker</a></span> <span class="next"><a href="/fe-blog/enviroment/deploy/cicd-pro/gitlab.html">安装 Gitlab</a>→
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/fe-blog/assets/js/app.8a3559bf.js" defer></script><script src="/fe-blog/assets/js/2.fbf19223.js" defer></script><script src="/fe-blog/assets/js/4.54c72001.js" defer></script>
  </body>
</html>
