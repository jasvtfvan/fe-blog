<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Jenkins + Gitlab | jasvtfvan前端博客</title>
    <meta name="description" content="欢迎来到我的前端工厂">
    <link rel="icon" href="/fe-blog/github.ico">
    
    <link rel="preload" href="/fe-blog/assets/css/0.styles.68cfcd3e.css" as="style"><link rel="preload" href="/fe-blog/assets/js/app.8a3559bf.js" as="script"><link rel="preload" href="/fe-blog/assets/js/2.fbf19223.js" as="script"><link rel="preload" href="/fe-blog/assets/js/3.a5dd7d81.js" as="script"><link rel="prefetch" href="/fe-blog/assets/js/10.399f0c01.js"><link rel="prefetch" href="/fe-blog/assets/js/11.08202412.js"><link rel="prefetch" href="/fe-blog/assets/js/12.cfc10ac9.js"><link rel="prefetch" href="/fe-blog/assets/js/13.bdceb3a3.js"><link rel="prefetch" href="/fe-blog/assets/js/14.0c886dba.js"><link rel="prefetch" href="/fe-blog/assets/js/15.f5d42d2e.js"><link rel="prefetch" href="/fe-blog/assets/js/16.19c927b2.js"><link rel="prefetch" href="/fe-blog/assets/js/17.cc368339.js"><link rel="prefetch" href="/fe-blog/assets/js/18.99786a0e.js"><link rel="prefetch" href="/fe-blog/assets/js/19.2c96aa8f.js"><link rel="prefetch" href="/fe-blog/assets/js/20.feb358f9.js"><link rel="prefetch" href="/fe-blog/assets/js/21.854b8672.js"><link rel="prefetch" href="/fe-blog/assets/js/22.78adf0af.js"><link rel="prefetch" href="/fe-blog/assets/js/23.a8c123d2.js"><link rel="prefetch" href="/fe-blog/assets/js/24.65de2737.js"><link rel="prefetch" href="/fe-blog/assets/js/25.21f6581b.js"><link rel="prefetch" href="/fe-blog/assets/js/26.19b2e629.js"><link rel="prefetch" href="/fe-blog/assets/js/27.b0579100.js"><link rel="prefetch" href="/fe-blog/assets/js/28.a0c1bad8.js"><link rel="prefetch" href="/fe-blog/assets/js/29.3869f6fd.js"><link rel="prefetch" href="/fe-blog/assets/js/30.be6becb7.js"><link rel="prefetch" href="/fe-blog/assets/js/31.e027926c.js"><link rel="prefetch" href="/fe-blog/assets/js/32.dd112bea.js"><link rel="prefetch" href="/fe-blog/assets/js/33.2cdeb0bd.js"><link rel="prefetch" href="/fe-blog/assets/js/34.2eb22cbc.js"><link rel="prefetch" href="/fe-blog/assets/js/35.a1660bb3.js"><link rel="prefetch" href="/fe-blog/assets/js/36.3d49d679.js"><link rel="prefetch" href="/fe-blog/assets/js/37.2c728d3e.js"><link rel="prefetch" href="/fe-blog/assets/js/38.5b00cff3.js"><link rel="prefetch" href="/fe-blog/assets/js/39.bc2ccb29.js"><link rel="prefetch" href="/fe-blog/assets/js/4.54c72001.js"><link rel="prefetch" href="/fe-blog/assets/js/40.fe52d14c.js"><link rel="prefetch" href="/fe-blog/assets/js/41.da19c7de.js"><link rel="prefetch" href="/fe-blog/assets/js/42.82780c8a.js"><link rel="prefetch" href="/fe-blog/assets/js/43.ea864644.js"><link rel="prefetch" href="/fe-blog/assets/js/44.683e33ca.js"><link rel="prefetch" href="/fe-blog/assets/js/45.6ebdb1c6.js"><link rel="prefetch" href="/fe-blog/assets/js/46.d152d9d1.js"><link rel="prefetch" href="/fe-blog/assets/js/5.7519b52c.js"><link rel="prefetch" href="/fe-blog/assets/js/6.60bc9110.js"><link rel="prefetch" href="/fe-blog/assets/js/7.583a8196.js"><link rel="prefetch" href="/fe-blog/assets/js/8.b04d2cae.js"><link rel="prefetch" href="/fe-blog/assets/js/9.f4b536f6.js">
    <link rel="stylesheet" href="/fe-blog/assets/css/0.styles.68cfcd3e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fe-blog/" class="home-link router-link-active"><!----> <span class="site-name">jasvtfvan前端博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fe-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">微信平台</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>公众号</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/wechat/serviceaccount/local-debug.html" class="nav-link">本地调试</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/regexp/" class="nav-link">正则表达式</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/highlights/" class="nav-link">基础集锦</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/promise/" class="nav-link">promise</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">主流框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/source/observer.html" class="nav-link">框架源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/application/base.html" class="nav-link">框架应用</a></li></ul></li><li class="dropdown-item"><h4>react</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/react15/source/native.html" class="nav-link">react15源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/react16/source/fiber.html" class="nav-link">react16源码</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具环境</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/git/" class="nav-link">git/git-flow</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/node/" class="nav-link">node工具</a></li></ul></li><li class="dropdown-item"><h4>系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/mnt.html" class="nav-link">centOS</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/cmd.html" class="nav-link">linux常用命令</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/mac/switch-hosts.html" class="nav-link">mac技巧</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/normal/" class="nav-link">常规部署</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd/" class="nav-link">CI/CD</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/gitlab/" class="nav-link">gitlab搭建</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/docker/" class="nav-link">docker常用容器</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="nav-link">CI/CD综合</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fe-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">微信平台</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>公众号</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/wechat/serviceaccount/local-debug.html" class="nav-link">本地调试</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/regexp/" class="nav-link">正则表达式</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/highlights/" class="nav-link">基础集锦</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/promise/" class="nav-link">promise</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">主流框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/source/observer.html" class="nav-link">框架源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/application/base.html" class="nav-link">框架应用</a></li></ul></li><li class="dropdown-item"><h4>react</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/react15/source/native.html" class="nav-link">react15源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/react16/source/fiber.html" class="nav-link">react16源码</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具环境</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/git/" class="nav-link">git/git-flow</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/node/" class="nav-link">node工具</a></li></ul></li><li class="dropdown-item"><h4>系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/mnt.html" class="nav-link">centOS</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/cmd.html" class="nav-link">linux常用命令</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/mac/switch-hosts.html" class="nav-link">mac技巧</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/normal/" class="nav-link">常规部署</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd/" class="nav-link">CI/CD</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/gitlab/" class="nav-link">gitlab搭建</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/docker/" class="nav-link">docker常用容器</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="nav-link">CI/CD综合</a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="sidebar-link">什么是CI/CD?</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/docker.html" class="sidebar-link">Docker</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins.html" class="sidebar-link">安装 Jenkins</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/gitlab.html" class="sidebar-link">安装 Gitlab</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/nginx.html" class="sidebar-link">Docker Nginx</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html" class="active sidebar-link">Jenkins + Gitlab</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html#jenkins-安装-nodejs-环境" class="sidebar-link">Jenkins 安装 Nodejs 环境</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html#使用" class="sidebar-link">使用</a></li></ul></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html#开始集成" class="sidebar-link">开始集成</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html#jenkins-容器端生成私钥公钥" class="sidebar-link">Jenkins 容器端生成私钥公钥</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html#jenkins-端配置私钥" class="sidebar-link">Jenkins 端配置私钥</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html#gitlab-端配置公钥" class="sidebar-link">Gitlab 端配置公钥</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html#配置任务" class="sidebar-link">配置任务</a></li></ul></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html#部署" class="sidebar-link">部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html#配置nginx端公钥" class="sidebar-link">配置Nginx端公钥</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html#初始化scp" class="sidebar-link">初始化scp</a></li><li class="sidebar-sub-header"><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-gitlab.html#修改-jenkins-配置" class="sidebar-link">修改 Jenkins 配置</a></li></ul></li></ul></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/nexus.html" class="sidebar-link">Nexus</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-nexus.html" class="sidebar-link">Jenkins + Nexus</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/ansible.html" class="sidebar-link">Ansible</a></li><li><a href="/fe-blog/enviroment/deploy/cicd-pro/jenkins-nexus-ansible.html" class="sidebar-link">Ansible + Jenkins + Nexus</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="jenkins-gitlab"><a href="#jenkins-gitlab" aria-hidden="true" class="header-anchor">#</a> Jenkins + Gitlab</h1> <p><br>到这里，我们的Jenkins 和Gitlab就已经安装完成。<br>接下来我们将这两个平台串联起来，<strong>实现第一阶段的持续构建和部署</strong></p> <p><a name="PL5tW"></a></p> <h2 id="jenkins-安装-nodejs-环境"><a href="#jenkins-安装-nodejs-环境" aria-hidden="true" class="header-anchor">#</a> Jenkins 安装 Nodejs 环境</h2> <p><a name="56rzz"></a></p> <h3 id="安装"><a href="#安装" aria-hidden="true" class="header-anchor">#</a> 安装</h3> <p><br>《安装 Jenkins》那一章我们讲到，Jenkins容器环境是一个全新的环境，与外界隔离。那我们怎么在容器内部使用Node环境呢？有以下三种方式：<br></p> <ol><li>进入Jenkins容器，手动安装Node：这种方式靠谱，但是比较费时间，且需要找寻缺失的依赖（Jenkins容器底层是Ubuntu）</li> <li>像Docker in Docker一样，把宿主机的Node环境挂载到容器内：这种也可以，但是可能环境会有问题。如依赖缺失等</li> <li><strong>使用Jenkins平台自带的工具安装Node</strong></li></ol> <p><br>在这里，我们<strong>选择第三种方式</strong>安装Nodejs，既方便又省力。<br> <br>我们打开 Jenkins 首页，找到左侧的“系统配置”，选择“插件管理”，点击“可选插件”，搜索 “Node”。点击左下角的 “直接安装”<br><img src="/fe-blog/assets/img/jenkins1.d2f8a97c.png" alt="image"><br> <br>安装完毕后，重启 <code>Jenkins</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker restart jenkins
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><br>重启完毕后，回到 Jenkins 首页，找到左侧的“系统配置”，选择“全局工具配置”<br> <br><img src="/fe-blog/assets/img/jenkins2.cd46e3a6.png" alt="image"><br> <br>找到下面的“Node JS”，点击NodeJS安装，选择相应的版本填写信息保存即可。<br><img src="/fe-blog/assets/img/jenkins3.a9508a91.png" alt="image"><br></p> <p><a name="hTd85"></a></p> <h3 id="使用"><a href="#使用" aria-hidden="true" class="header-anchor">#</a> 使用</h3> <p><br>那我们在任务中如何使用呢？我们只需要在任务的“配置”中，找到“构建环境”，选中 “Provide Node &amp; npm bin/ folder to PATH” ，选择刚才配置好的NodeJS即可。<br> <br>第一次执行会下载对应的Node版本，后续不会下载。<br> <br><img src="/fe-blog/assets/img/jenkins4.ca94d2b0.png" alt="image"><br></p> <p><a name="Fi3uS"></a></p> <h2 id="开始集成"><a href="#开始集成" aria-hidden="true" class="header-anchor">#</a> 开始集成</h2> <p><a name="EmgFy"></a></p> <h3 id="jenkins-容器端生成私钥公钥"><a href="#jenkins-容器端生成私钥公钥" aria-hidden="true" class="header-anchor">#</a> Jenkins 容器端生成私钥公钥</h3> <p><br>先进入Jenkins容器内，使用 <code>ssh-keygen -t rsa</code> 生成私钥公钥。如下图所示，代表生成成功。<br></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker <span class="token builtin class-name">exec</span> -it jenkins /bin/bash
ssh-keygen -t rsa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><br><img src="/fe-blog/assets/img/jenkins5.8d5af049.png" alt="image"><br>执行后，我们生成的私钥公钥文件存放在了 <code>~/.ssh</code> 目录下。其中， <code>id_rsa</code> 为私钥， <code>id_rsa.pub</code> 为公钥。<br></p> <p><a name="6i7Ca"></a></p> <h3 id="jenkins-端配置私钥"><a href="#jenkins-端配置私钥" aria-hidden="true" class="header-anchor">#</a> Jenkins 端配置私钥</h3> <p><br>我们在Jenkins端先配置刚才创建的私钥，然后在Gitlab端配置公钥，用于代码拉取身份验证。<br>找到Jenkins首页的 “系统设置”，选择 “Manage Credentials”<br><img src="/fe-blog/assets/img/jenkins6.d2323fee.png" alt="image"><br>点击下方 “全局”，点击左边的 “添加凭据”<br> <br><img src="/fe-blog/assets/img/jenkins7.acad5969.png" alt="image"><br>接着选择类型为 “SSH Username with private key.”<br><img src="/fe-blog/assets/img/jenkins8.7793d580.png" alt="image"><br>在这里，ID为此凭据在Jenkins的标示，UserName 为你的Gitlab用户名，PrivateKey 为你的服务器私钥。<br> <br>选择PrivateKey，点击下方的“add”，将服务器的私钥内容复制进去（记得上下方的提示英文也复制）。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> ~/.ssh/id_rsa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后点击确定，保存退出。<br></p> <p><a name="3Wrk8"></a></p> <h3 id="gitlab-端配置公钥"><a href="#gitlab-端配置公钥" aria-hidden="true" class="header-anchor">#</a> Gitlab 端配置公钥</h3> <p><br>打开Gitlab页面，点击右上角头像 =&gt; 设置，找到左边的 “SSH密钥”。将 <code>~/.ssh/id_rsa.pub</code> 文件内容复制进去。点击添加密钥，保存成功</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> ~/.ssh/id_rsa.pub
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><br><img src="/fe-blog/assets/img/jenkins9.fc83b1db.png" alt="image"><br></p> <p><a name="OCyDk"></a></p> <h3 id="配置任务"><a href="#配置任务" aria-hidden="true" class="header-anchor">#</a> 配置任务</h3> <p><br>在上面，我们在分别配置了公钥和私钥用来做SSH免密登录。接下来我们的代码拉取，也用SSH的方式拉取。<br> <br>我们新建一个任务，选择 “自由风格的软件项目”。创建完成后，找到“源码管理“，点击”Git“。<br> <br><img src="/fe-blog/assets/img/jenkins10.dc16b891.png" alt="image"><br> <br>前往Gitlab仓库地址，找到 “克隆”，复制SSH克隆地址。<br><img src="/fe-blog/assets/img/jenkins11.fd4bfbb9.png" alt="image"><br> <br>将地址复制进刚才Jenkins任务 “Repository URL” 内，“Credentials” 选择刚才添加的凭证。<br><img src="/fe-blog/assets/img/jenkins12.8c7fd6cc.png" alt="image"><br>在下方找到 “构建”，选择 “执行Shell”。输入一段构建脚本来测试是否成功运行。<br></p> <blockquote><p>不要忘记勾选：Provide Node &amp; npm bin/ folder to PATH，否则没有Node环境</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>node -v
<span class="token function">npm</span> -v
<span class="token function">npm</span> <span class="token function">install</span> -g cnpm --registry<span class="token operator">=</span>https://registry.npm.taobao.org
cnpm <span class="token function">install</span>
<span class="token function">npm</span> run build
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="/fe-blog/assets/img/jenkins13.24ee797e.png" alt="image"><br> <br>最后我们查看Jenkins构建日志，构建成功。<br> <br><img src="/fe-blog/assets/img/jenkins14.108f44d2.png" alt="image"><br></p> <p><a name="KCdIc"></a></p> <h2 id="部署"><a href="#部署" aria-hidden="true" class="header-anchor">#</a> 部署</h2> <p><a name="J2Gub"></a></p> <h3 id="配置nginx端公钥"><a href="#配置nginx端公钥" aria-hidden="true" class="header-anchor">#</a> 配置Nginx端公钥</h3> <p><br>上面我们讲到，使用Jenkins做自动化构建，但缺少部署一环。<br>我们新创建一个服务器，只存放一个 Nginx 服务。在这里，nginx的安装方式不限，可以用docker也可以直接安装。<br> <br>我们在Nginx服务器内，使用 <code>ssh-keygen -t rsa</code> 生成公钥和私钥。接着 在 <code>.ssh/</code> 文件夹下，创建一个 <code>authorized_keys</code> 文件。将我们Jenkins容器端的公钥拷贝进 <code>authorized_keys</code> 文件内。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ssh-keygen -t rsa
<span class="token builtin class-name">cd</span> .ssh/
<span class="token function">touch</span> authorized_keys
<span class="token function">vi</span> authorized_keys
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="/fe-blog/assets/img/jenkins15.6279200e.png" alt="image"><br> <br></p> <h3 id="初始化scp"><a href="#初始化scp" aria-hidden="true" class="header-anchor">#</a> 初始化<code>scp</code></h3> <p>进入到 <code>Jenkins</code> 服务器<br></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>docker <span class="token builtin class-name">exec</span> -it jenkins /bin/bash
<span class="token builtin class-name">cd</span> ~
<span class="token function">touch</span> test.txt
<span class="token function">scp</span> test.txt root@10.211.55.4:~
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>首次scp需要手动操作</p></blockquote> <p><strong>如果不想首次手动操作，需要降低安全级别跳过<code>ssh公钥</code>检查，需要为<code>ssh</code>或<code>scp</code>添加参数<code>-o StrictHostKeyChecking=no</code></strong></p> <p><a name="3W1m3"></a></p> <h3 id="修改-jenkins-配置"><a href="#修改-jenkins-配置" aria-hidden="true" class="header-anchor">#</a> 修改 Jenkins 配置</h3> <p><br>编辑我们的 <code>Jenkins</code> 任务，新增加几条 <code>shell</code> 命令。<br> <br>在我们 <code>build</code> 结束后，先将dist文件打包为压缩包，然后通过 <code>linux scp</code> 命令上传至Nginx服务器。接着用 <code>ssh</code> 命令远程操控解压到 <code>Nginx</code> 目录即可。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># node -v</span>
<span class="token comment"># npm -v</span>
<span class="token comment"># npm install -g cnpm --registry=https://registry.npm.taobao.org</span>
<span class="token comment"># cnpm install</span>
<span class="token comment"># npm run build</span>

<span class="token comment"># # 压缩</span>
<span class="token comment"># tar -czvf vue-cli-demo.tar ./dist</span>
<span class="token comment"># scp ./vue-cli-demo.tar root@172.16.81.151:~</span>
<span class="token comment"># ssh root@172.16.81.151 &quot;tar zxvf ~/vue-cli-demo.tar &amp;&amp; mv dist/* /home/nginx/html&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>scp: 将本地文件/远程服务器内文件通过ssh上传/下载到指定地址</p></blockquote> <p>最终优化后的版本:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>node -v
<span class="token function">npm</span> -v
<span class="token function">npm</span> <span class="token function">install</span> -g cnpm --registry<span class="token operator">=</span>https://registry.npm.taobao.org
<span class="token function">rm</span> -rf node_modules/
<span class="token function">rm</span> -rf dist/
<span class="token function">rm</span> -rf vue-cli-demo.tar
cnpm <span class="token function">install</span>
<span class="token function">npm</span> run build

<span class="token function">tar</span> -czvf vue-cli-demo.tar ./dist
<span class="token function">ssh</span> root@10.211.55.4 <span class="token string">&quot;rm -rf ~/vue-cli-demo.tar &amp;&amp; rm -rf /home/nginx/html/jenkins-test-vue&quot;</span>
<span class="token function">scp</span> ./vue-cli-demo.tar root@10.211.55.4:~
<span class="token function">ssh</span> root@10.211.55.4 <span class="token string">&quot;tar zxvf ~/vue-cli-demo.tar &amp;&amp; mv ~/dist/ /home/nginx/html/jenkins-test-vue&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><blockquote><p>前提是修改了 vue 项目的 publicPath: '/jenkins-test-vue'
访问浏览器 10.211.55.4/jenkins-test-vue</p></blockquote> <p><br>打开新机器的页面，如果访问成功代表部署成功。<br> <br></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/9/2020, 9:33:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe-blog/enviroment/deploy/cicd-pro/nginx.html" class="prev">Docker Nginx</a></span> <span class="next"><a href="/fe-blog/enviroment/deploy/cicd-pro/nexus.html">Nexus</a>→
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/fe-blog/assets/js/app.8a3559bf.js" defer></script><script src="/fe-blog/assets/js/2.fbf19223.js" defer></script><script src="/fe-blog/assets/js/3.a5dd7d81.js" defer></script>
  </body>
</html>
