<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>生命周期 | jasvtfvan前端博客</title>
    <meta name="description" content="欢迎来到我的前端工厂">
    <link rel="icon" href="/fe-blog/github.ico">
    
    <link rel="preload" href="/fe-blog/assets/css/0.styles.68cfcd3e.css" as="style"><link rel="preload" href="/fe-blog/assets/js/app.8a3559bf.js" as="script"><link rel="preload" href="/fe-blog/assets/js/2.fbf19223.js" as="script"><link rel="preload" href="/fe-blog/assets/js/34.2eb22cbc.js" as="script"><link rel="prefetch" href="/fe-blog/assets/js/10.399f0c01.js"><link rel="prefetch" href="/fe-blog/assets/js/11.08202412.js"><link rel="prefetch" href="/fe-blog/assets/js/12.cfc10ac9.js"><link rel="prefetch" href="/fe-blog/assets/js/13.bdceb3a3.js"><link rel="prefetch" href="/fe-blog/assets/js/14.0c886dba.js"><link rel="prefetch" href="/fe-blog/assets/js/15.f5d42d2e.js"><link rel="prefetch" href="/fe-blog/assets/js/16.19c927b2.js"><link rel="prefetch" href="/fe-blog/assets/js/17.cc368339.js"><link rel="prefetch" href="/fe-blog/assets/js/18.99786a0e.js"><link rel="prefetch" href="/fe-blog/assets/js/19.2c96aa8f.js"><link rel="prefetch" href="/fe-blog/assets/js/20.feb358f9.js"><link rel="prefetch" href="/fe-blog/assets/js/21.854b8672.js"><link rel="prefetch" href="/fe-blog/assets/js/22.78adf0af.js"><link rel="prefetch" href="/fe-blog/assets/js/23.a8c123d2.js"><link rel="prefetch" href="/fe-blog/assets/js/24.65de2737.js"><link rel="prefetch" href="/fe-blog/assets/js/25.21f6581b.js"><link rel="prefetch" href="/fe-blog/assets/js/26.19b2e629.js"><link rel="prefetch" href="/fe-blog/assets/js/27.b0579100.js"><link rel="prefetch" href="/fe-blog/assets/js/28.a0c1bad8.js"><link rel="prefetch" href="/fe-blog/assets/js/29.3869f6fd.js"><link rel="prefetch" href="/fe-blog/assets/js/3.a5dd7d81.js"><link rel="prefetch" href="/fe-blog/assets/js/30.be6becb7.js"><link rel="prefetch" href="/fe-blog/assets/js/31.e027926c.js"><link rel="prefetch" href="/fe-blog/assets/js/32.dd112bea.js"><link rel="prefetch" href="/fe-blog/assets/js/33.2cdeb0bd.js"><link rel="prefetch" href="/fe-blog/assets/js/35.a1660bb3.js"><link rel="prefetch" href="/fe-blog/assets/js/36.3d49d679.js"><link rel="prefetch" href="/fe-blog/assets/js/37.2c728d3e.js"><link rel="prefetch" href="/fe-blog/assets/js/38.5b00cff3.js"><link rel="prefetch" href="/fe-blog/assets/js/39.bc2ccb29.js"><link rel="prefetch" href="/fe-blog/assets/js/4.54c72001.js"><link rel="prefetch" href="/fe-blog/assets/js/40.fe52d14c.js"><link rel="prefetch" href="/fe-blog/assets/js/41.da19c7de.js"><link rel="prefetch" href="/fe-blog/assets/js/42.82780c8a.js"><link rel="prefetch" href="/fe-blog/assets/js/43.ea864644.js"><link rel="prefetch" href="/fe-blog/assets/js/44.683e33ca.js"><link rel="prefetch" href="/fe-blog/assets/js/45.6ebdb1c6.js"><link rel="prefetch" href="/fe-blog/assets/js/46.d152d9d1.js"><link rel="prefetch" href="/fe-blog/assets/js/5.7519b52c.js"><link rel="prefetch" href="/fe-blog/assets/js/6.60bc9110.js"><link rel="prefetch" href="/fe-blog/assets/js/7.583a8196.js"><link rel="prefetch" href="/fe-blog/assets/js/8.b04d2cae.js"><link rel="prefetch" href="/fe-blog/assets/js/9.f4b536f6.js">
    <link rel="stylesheet" href="/fe-blog/assets/css/0.styles.68cfcd3e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fe-blog/" class="home-link router-link-active"><!----> <span class="site-name">jasvtfvan前端博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fe-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">微信平台</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>公众号</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/wechat/serviceaccount/local-debug.html" class="nav-link">本地调试</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/regexp/" class="nav-link">正则表达式</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/highlights/" class="nav-link">基础集锦</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/promise/" class="nav-link">promise</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">主流框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/source/observer.html" class="nav-link">框架源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/application/base.html" class="nav-link">框架应用</a></li></ul></li><li class="dropdown-item"><h4>react</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/react15/source/native.html" class="nav-link">react15源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/react16/source/fiber.html" class="nav-link">react16源码</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具环境</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/git/" class="nav-link">git/git-flow</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/node/" class="nav-link">node工具</a></li></ul></li><li class="dropdown-item"><h4>系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/mnt.html" class="nav-link">centOS</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/cmd.html" class="nav-link">linux常用命令</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/mac/switch-hosts.html" class="nav-link">mac技巧</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/normal/" class="nav-link">常规部署</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd/" class="nav-link">CI/CD</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/gitlab/" class="nav-link">gitlab搭建</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/docker/" class="nav-link">docker常用容器</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="nav-link">CI/CD综合</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fe-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">微信平台</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>公众号</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/wechat/serviceaccount/local-debug.html" class="nav-link">本地调试</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/regexp/" class="nav-link">正则表达式</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/highlights/" class="nav-link">基础集锦</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/promise/" class="nav-link">promise</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">主流框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/source/observer.html" class="nav-link">框架源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/application/base.html" class="nav-link">框架应用</a></li></ul></li><li class="dropdown-item"><h4>react</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/react15/source/native.html" class="nav-link">react15源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/react16/source/fiber.html" class="nav-link">react16源码</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具环境</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/git/" class="nav-link">git/git-flow</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/node/" class="nav-link">node工具</a></li></ul></li><li class="dropdown-item"><h4>系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/mnt.html" class="nav-link">centOS</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/cmd.html" class="nav-link">linux常用命令</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/mac/switch-hosts.html" class="nav-link">mac技巧</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/normal/" class="nav-link">常规部署</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd/" class="nav-link">CI/CD</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/gitlab/" class="nav-link">gitlab搭建</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/docker/" class="nav-link">docker常用容器</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="nav-link">CI/CD综合</a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fe-blog/frame/react15/source/native.html" class="sidebar-link">渲染原生组件</a></li><li><a href="/fe-blog/frame/react15/source/class-function.html" class="sidebar-link">类组件和函数组件</a></li><li><a href="/fe-blog/frame/react15/source/set-state.html" class="sidebar-link">组件更新</a></li><li><a href="/fe-blog/frame/react15/source/dom-diff.html" class="sidebar-link">dom-diff</a></li><li><a href="/fe-blog/frame/react15/source/life-cycle.html" class="active sidebar-link">生命周期</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_1-旧版生命周期" class="sidebar-link">1. 旧版生命周期</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_1-1-src-index-js" class="sidebar-link">1.1. src/index.js</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_1-2-src-react-constants-js" class="sidebar-link">1.2. src/react/constants.js</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_1-3-src-react-index-js" class="sidebar-link">1.3. src/react/index.js</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_1-4-src-react-component-js" class="sidebar-link">1.4. src/react/component.js</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_1-5-src-react-vdom-js" class="sidebar-link">1.5. src/react/vdom.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_2-getderivedstatefromprops" class="sidebar-link">2. getDerivedStateFromProps</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_2-1-src-index-js" class="sidebar-link">2.1. src/index.js</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_2-2-src-react-component-js" class="sidebar-link">2.2. src/react/component.js</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_2-3-src-react-vdom-js" class="sidebar-link">2.3. src/react/vdom.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_3-getsnapshotbeforeupdate" class="sidebar-link">3. getSnapshotBeforeUpdate</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_3-1-数组与rest参数" class="sidebar-link">3.1 数组与rest参数</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_3-2-src-index-js" class="sidebar-link">3.2. src/index.js</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_3-3-src-react-component-js" class="sidebar-link">3.3. src/react/component.js</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_3-4-src-react-index-js" class="sidebar-link">3.4. src/react/index.js</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/life-cycle.html#_3-5-src-react-vdom-js" class="sidebar-link">3.5. src/react/vdom.js</a></li></ul></li></ul></li><li><a href="/fe-blog/frame/react15/source/context.html" class="sidebar-link">context和批量更新</a></li><li><a href="/fe-blog/frame/react15/source/react15.html" class="sidebar-link">react15核心总揽</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="生命周期"><a href="#生命周期" aria-hidden="true" class="header-anchor">#</a> 生命周期</h1> <h2 id="_1-旧版生命周期"><a href="#_1-旧版生命周期" aria-hidden="true" class="header-anchor">#</a> 1. 旧版生命周期</h2> <h3 id="_1-1-src-index-js"><a href="#_1-1-src-index-js" aria-hidden="true" class="header-anchor">#</a> 1.1. src/index.js</h3> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'./react-dom'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> defaultProps <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'珠峰架构'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> number<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent--constructor'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent--componentWillMount'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent--componentDidMount'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent--shouldComponentUpdate'</span><span class="token punctuation">,</span> nextState<span class="token punctuation">.</span>number <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nextState<span class="token punctuation">.</span>number <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentWillUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent--componentWillUpdate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps<span class="token punctuation">,</span> prevState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent--componentDidUpdate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> number<span class="token punctuation">:</span> state<span class="token punctuation">.</span>number <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent--render'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number <span class="token operator">&lt;=</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>ChildCounter number<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">+</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">ChildCounter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child componentWillMount'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child componentDidMount'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child shouldComponentUpdate'</span><span class="token punctuation">,</span> nextProps<span class="token punctuation">.</span>number <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nextProps<span class="token punctuation">.</span>number <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentWillUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child componentWillUpdate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps<span class="token punctuation">,</span> prevState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child componentDidUpdate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child componentWillReceiveProps'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child componentWillUnmount'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child render'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>number<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>Counter <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><blockquote><p><code>this.state.number &lt;= 3</code>返回的是<code>BOOLEAN</code>类型</p></blockquote> <h3 id="_1-2-src-react-constants-js"><a href="#_1-2-src-react-constants-js" aria-hidden="true" class="header-anchor">#</a> 1.2. src/react/constants.js</h3> <ul><li>增加了 BOOLEAN 类型</li></ul> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">TEXT</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'TEXT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//文本类型</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">ELEMENT</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'ELEMENT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//元素类型</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">FUNCTION_COMPONENT</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'FUNCTION_COMPONENT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//函数数件</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">CLASS_COMPONENT</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'CLASS_COMPONENT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//类组件</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">BOOLEAN</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'BOOLEAN'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//boolean类型</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">MOVE</span> <span class="token operator">=</span> <span class="token string">'MOVE'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">REMOVE</span> <span class="token operator">=</span> <span class="token string">'REMOVE'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">INSERT</span> <span class="token operator">=</span> <span class="token string">'INSERT'</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_1-3-src-react-index-js"><a href="#_1-3-src-react-index-js" aria-hidden="true" class="header-anchor">#</a> 1.3. src/react/index.js</h3> <ul><li>处理了 defaultProps 和 BOOLEAN 类型</li></ul> <div class="language-js line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">BOOLEAN</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ReactElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./vdom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./component'</span><span class="token punctuation">;</span>

<span class="token comment">//利用数组 rest，方便children直接拿到数组</span>
<span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__source<span class="token punctuation">;</span><span class="token comment">//dev环境下变量，不考虑该变量</span>
  <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__self<span class="token punctuation">;</span><span class="token comment">//dev环境下变量，不考虑该变量</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>
  <span class="token keyword">let</span> $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//span div button</span>
    $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">ELEMENT</span><span class="token punctuation">;</span><span class="token comment">//是一个原生的DOM类型</span>
    <span class="token comment">/**
     * 这里要注意，用真实React在测试时，你会发现：
     * let e1 = React.createElement('abc');
     * console.log(e1); // $$typeof 仍然是 react.element类型，type: 'abc'
     */</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span>defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> defaultProps <span class="token operator">=</span> type<span class="token punctuation">.</span>defaultProps<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> propName <span class="token keyword">in</span> defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> defaultProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Warning: React.createElement: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">typeof</span> type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * !!! 叶子节点为字符串或数字时，需要包装成对象，这样才能指向dom节点，并根据dom更新内容
   * 见 src/react/vdom.js updateElement方法
   * 经过这样的改造后，element的输出结构，将跟官方有区别
   */</span>
  props<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ret <span class="token operator">=</span> item<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token constant">BOOLEAN</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token constant">BOOLEAN</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> item <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> item <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span>$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  Component
<span class="token punctuation">}</span>
<span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span>
  createElement<span class="token punctuation">,</span>
  Component
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h3 id="_1-4-src-react-component-js"><a href="#_1-4-src-react-component-js" aria-hidden="true" class="header-anchor">#</a> 1.4. src/react/component.js</h3> <ul><li>处理了 defaultProps</li></ul> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> compareTwoElements <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./vdom'</span><span class="token punctuation">;</span>

<span class="token comment">//更新队列</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> <span class="token punctuation">{</span>
  updaters<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//要执行的updater对象</span>
  isPending<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token comment">//是否处于批量更新模式</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">updater</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>updaters<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>updater<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//需要调用batchUpdate才更新</span>
  <span class="token function">batchUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> updaters <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//开始更新</span>
    <span class="token keyword">let</span> updater<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>updater <span class="token operator">=</span> updaters<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      updater<span class="token punctuation">.</span><span class="token function">updateComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新所有 dirty 组件</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//更新完毕</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Updater</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">componentInstance</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span><span class="token comment">//Updater和类组件1对1关系</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pendingStates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//更新如果批量的，先把状态暂存到数组，最后更新时统一合并</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nextProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//新的属性对象</span>
  <span class="token punctuation">}</span>
  <span class="token function">addState</span><span class="token punctuation">(</span><span class="token parameter">partialState</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pendingStates<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把新状态放入数组</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">emitUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nextProps <span class="token operator">=</span> nextProps<span class="token punctuation">;</span>
    <span class="token comment">//如果有新属性对象 或者 队列处于‘休息’状态，直接更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProps <span class="token operator">||</span> <span class="token operator">!</span>updateQueue<span class="token punctuation">.</span>isPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//否则交给队列处理</span>
      updateQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">updateComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> componentInstance<span class="token punctuation">,</span> pendingStates<span class="token punctuation">,</span> nextProps <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProps <span class="token operator">||</span> pendingStates<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//长度大于0，有要合并的状态</span>
      <span class="token function">shouldUpdate</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> nextProps<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//合并及返回新的状态</span>
  <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> componentInstance<span class="token punctuation">,</span> pendingStates <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> state <span class="token punctuation">}</span> <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span><span class="token comment">//老组件当前状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingStates<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//迭代pendingStates，将所有状态合并到state</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pendingStates<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> nextState <span class="token operator">=</span> pendingStates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> nextState <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token function">nextState</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> <span class="token operator">...</span>nextState <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    pendingStates<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//合并后清空数组</span>
    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//判断是否要更新</span>
<span class="token keyword">function</span> <span class="token function">shouldUpdate</span><span class="token punctuation">(</span><span class="token parameter">componentInstance<span class="token punctuation">,</span> nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  componentInstance<span class="token punctuation">.</span>props <span class="token operator">=</span> nextProps<span class="token punctuation">;</span><span class="token comment">//将新props赋给组件</span>
  componentInstance<span class="token punctuation">.</span>state <span class="token operator">=</span> nextState<span class="token punctuation">;</span><span class="token comment">//将新state赋给组件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    componentInstance<span class="token punctuation">.</span>shouldComponentUpdate <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>componentInstance<span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果shouldComponentUpdate返回false，则不更新</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  componentInstance<span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//让组件强制更新</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$updater <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Updater</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//this 就是类组件的实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 当前状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nextProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 下一个属性对象</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//批量更新 partial，状态可能会被合并</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">partialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$updater<span class="token punctuation">.</span><span class="token function">addState</span><span class="token punctuation">(</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//进行组件更新</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> renderElement<span class="token punctuation">:</span> oldRenderElement <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> defaultProps <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> propName <span class="token keyword">in</span> defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> defaultProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>componentWillUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">componentWillUpdate</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//nextProps,nextState</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> newRenderElement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> currentElement <span class="token operator">=</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderElement <span class="token operator">=</span> currentElement<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>componentDidUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//prevProps,prevState</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//类组件的本质也是函数(请参考new Class原理)，通过`isReactComponent`判断是类组件还是函数组件</span>
<span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  Component
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br></div></div><h3 id="_1-5-src-react-vdom-js"><a href="#_1-5-src-react-vdom-js" aria-hidden="true" class="header-anchor">#</a> 1.5. src/react/vdom.js</h3> <ul><li><code>BOOLEAN</code>类型按照空文本<code>dom</code>处理，以便于比对和挂载</li> <li>所有被删除的老元素，如果有<code>componentInstance</code>说明是函数组件，则执行<code>componentWillUnmount</code></li></ul> <div class="language-js line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span> <span class="token constant">BOOLEAN</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span> onlyOne<span class="token punctuation">,</span> flatten<span class="token punctuation">,</span> patchProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> updateDepth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//递归深度</span>
<span class="token keyword">let</span> diffQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//补丁包，比较移动、添加、删除的节点</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span><span class="token parameter">oldRenderElement<span class="token punctuation">,</span> newRenderElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  oldRenderElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newRenderElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> oldRenderElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span><span class="token comment">//取出老的DOM节点（此处，element.dom = dom;已经做过预埋设计）</span>
  <span class="token keyword">let</span> currentElement <span class="token operator">=</span> oldRenderElement<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newRenderElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//新的虚拟DOM为null，删掉老节点</span>
    currentDOM <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">.</span>type <span class="token operator">!=</span> newRenderElement<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// span div function class</span>
    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//类型不同，新节点替换老节点</span>
    currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newDOM<span class="token punctuation">,</span> currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentElement <span class="token operator">=</span> newRenderElement<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//新老节点都存在，类型一样。进行 dom-diff 深度比较，比较他们的属性和子节点，并尽可能复用老节点</span>
    <span class="token function">updateElement</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> currentElement<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// *** 如果是`函数组件`或`类组件`,`oldElement`就是`oldRenderElement`</span>
<span class="token comment">// renderElement 是函数组件执行后 或 类组件调用render后返回的虚拟DOM，虚拟DOM是由React.createElement创建的</span>
<span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * !!!给 src/react/index.js 做比对，如果是字符串或者数字，仍需要获取dom，并根据dom内容更新
   */</span>
  <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> newElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span> <span class="token operator">&amp;&amp;</span> newElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>content <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentDOM<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// div span p</span>
    <span class="token comment">//先更新父节点的属性，再比较更新子节点（返回来也可以）</span>
    <span class="token function">updateDOMProperties</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//把newElement.props赋给oldElement.props，不仅要更新dom上的attribute，还是要同步props</span>
    oldElement<span class="token punctuation">.</span>props <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 函数组件</span>
    <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 类组件</span>
    <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  updateDepth<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//每递归新一层，updateDepth++</span>
  <span class="token function">diff</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  updateDepth<span class="token operator">--</span><span class="token punctuation">;</span><span class="token comment">//每diff完一层，返回上一级，updateDepth--</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>updateDepth <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//当updateDepth为0，说明到了最上层，执行补丁包</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行补丁</span>
    diffQueue<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//注意 MOVE 的逻辑：删除原节点，再插入到新的位置，因此需要缓存老DOM</span>
<span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">diffQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> deleteMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//缓存老的dom</span>
  <span class="token keyword">let</span> deleteChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//要删除的子节点</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> fromIndex<span class="token punctuation">,</span> toIndex<span class="token punctuation">,</span> componentInstance <span class="token punctuation">}</span> <span class="token operator">=</span> difference<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token constant">REMOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//移动或删除</span>
      <span class="token keyword">let</span> oldChildDOM <span class="token operator">=</span> difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//老的DOM节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//移动则缓存</span>
        deleteMap<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildDOM<span class="token punctuation">;</span><span class="token comment">//缓存老的DOM，方便复用</span>
      <span class="token punctuation">}</span>
      deleteChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>childDOM<span class="token punctuation">:</span> oldChildDOM<span class="token punctuation">,</span> componentInstance<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//把移动和删除的节点，执行删除操作。因为移动的真实DOM已经缓存，所以还可以拿到</span>
  deleteChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>childDOM<span class="token punctuation">,</span> componentInstance<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    childDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果componentInstance存在，说明是类组件，如果卸载则执行 componentInstanceWillUnmount</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance <span class="token operator">&amp;&amp;</span> componentInstance<span class="token punctuation">.</span>componentWillUnmount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      componentInstance<span class="token punctuation">.</span><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//diff函数处理完毕后</span>
    <span class="token comment">//MOVE具有fromIndex,toIndex</span>
    <span class="token comment">//INSERT具有toIndex,dom</span>
    <span class="token comment">//REMOVE具有fromIndex</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> fromIndex<span class="token punctuation">,</span> toIndex<span class="token punctuation">,</span> parentNode<span class="token punctuation">,</span> dom <span class="token punctuation">}</span> <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">INSERT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertChildAt</span><span class="token punctuation">(</span>parentNode<span class="token punctuation">,</span> dom<span class="token punctuation">,</span> toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertChildAt</span><span class="token punctuation">(</span>parentNode<span class="token punctuation">,</span> deleteMap<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//释放资源</span>
  deleteMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  deleteChildren<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//向index索引位置插入元素</span>
<span class="token keyword">function</span> <span class="token function">insertChildAt</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> newChildDOM<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldChild <span class="token operator">=</span> parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//拿到老的节点</span>
  oldChild <span class="token operator">?</span> parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newChildDOM<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span> <span class="token punctuation">:</span> parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>newChildDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldChildrenElementsMap <span class="token operator">=</span> <span class="token function">getChildrenElementsMap</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> newChildrenElementsMap <span class="token operator">=</span> <span class="token function">getNewChildrenElementsMap</span><span class="token punctuation">(</span>oldChildrenElementsMap<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">//由于深度优先，所有子节点在diffQueue中的位置，比父节点位置靠前</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newChildElement <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> newKey <span class="token operator">=</span> newChildElement<span class="token punctuation">.</span>key <span class="token operator">||</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement <span class="token operator">===</span> oldChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//同一个对象，在构建newChildrenElementsMap时确定</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            parentNode<span class="token punctuation">,</span><span class="token comment">//记录父节点</span>
            type<span class="token punctuation">:</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span>
            fromIndex<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>
            toIndex<span class="token punctuation">:</span> i
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//如果类型不相等，插入新元素（后边该key对应的老元素将被迭代，并会标记为删除）</span>
        diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          parentNode<span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span>
          toIndex<span class="token punctuation">:</span> i<span class="token punctuation">,</span>
          dom<span class="token punctuation">:</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      newChildElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span><span class="token comment">//新的节点，下次更新时，将变成老节点，需要_mountIndex</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//迭代老节点，如果新节点map中不包含老key，或者key相同type不同，则将老节点标记为删除</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> oldKey <span class="token keyword">in</span> oldChildrenElementsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementsMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildrenElementsMap<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>oldKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//新老key相同</span>
      <span class="token keyword">let</span> newChildElement <span class="token operator">=</span> newChildrenElementsMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//如果key相同，type相同，在getNewChildrenElementsMap方法中，就确保了newChildElement === oldChildElement</span>
      <span class="token comment">//当然，也可以使用canDeepCompare判断</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildElement <span class="token operator">!==</span> newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//type不同</span>
        diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          parentNode<span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span>
          fromIndex<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>
          componentInstance<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>componentInstance <span class="token comment">//如果存在componentInstance，说明是类组件</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//新map不包含老key，标记老元素删除</span>
      diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        parentNode<span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span>
        fromIndex<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>
        componentInstance<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>componentInstance <span class="token comment">//如果不存在，则为undefined</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getNewChildrenElementsMap</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElementsMap<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newChildElement <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> newKey <span class="token operator">=</span> newChildElement<span class="token punctuation">.</span>key <span class="token operator">||</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// key一样，类型一样</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canDeepCompare</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">updateElement</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新属性后，递归更新子节点</span>
        newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildElement<span class="token punctuation">;</span><span class="token comment">//复用老的虚拟DOM，老的虚拟DOM的dom属性，指向真实DOM</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//新数组上的每个element都映射到map，其中包含了跟oldChildElement相等的元素</span>
      map<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span> <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//是否可以深度递归比较</span>
<span class="token keyword">function</span> <span class="token function">canDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">oldChildElement<span class="token punctuation">,</span> newChildElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>oldChildElement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> oldChildElement<span class="token punctuation">.</span>type <span class="token operator">===</span> newChildElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取老map</span>
<span class="token keyword">function</span> <span class="token function">getChildrenElementsMap</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldKey <span class="token operator">=</span> oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">||</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">updateDOMProperties</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">patchProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//类组件element.componentInstance.renderElement.dom=真实DOM</span>
<span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span>
  <span class="token keyword">let</span> updater <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span>$updater<span class="token punctuation">;</span>
  <span class="token keyword">let</span> nextProps <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentWillReceiveProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    componentInstance<span class="token punctuation">.</span><span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  updater<span class="token punctuation">.</span><span class="token function">emitUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//函数组件element.renderElement.dom=真实DOM</span>
<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldRenderElement <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>renderElement<span class="token punctuation">;</span>
  <span class="token keyword">let</span> newRenderElement <span class="token operator">=</span> newElement<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newElement<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> currentDOM<span class="token punctuation">;</span><span class="token comment">//更新之后，重新挂载</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Uncaught DOMException: Failed to execute 'createElement' on 'Document': The tag name provided ('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">') is not a valid name.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * !!! element 如果是字符串或者数字，修改成在 createElement时，封装成对象
   */</span>
  <span class="token keyword">let</span> dom<span class="token punctuation">;</span>
  element <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果是数组，只取第一个</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span> <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 字符串或者数字</span>
    dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 原生DOM节点</span>
    dom <span class="token operator">=</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 函数组件</span>
    dom <span class="token operator">=</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 类组件</span>
    dom <span class="token operator">=</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">BOOLEAN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// boolean</span>
    dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * `element`是ReactElement创建出来的虚拟DOM，让虚拟的DOM的`dom`属性指向真实DOM
   * 这里是一个预埋设计，或者叫铺垫，通过虚拟DOM能够获取真实DOM
   */</span>
  element<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 创建函数组件真实的DOM对象</span>
<span class="token keyword">function</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//element: $$typeof, type, key, ref, props</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token comment">/**
   * function FunctionComponent(props) {
   *   return React.createElement('div', { id: 'counter' }, 'hello');
   * }
   */</span>
  <span class="token keyword">let</span> renderElement <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// type === FunctionComponent</span>
  <span class="token comment">//element 是 React.createElement(FunctionComponent, config, children); 的返回值</span>
  <span class="token comment">//element 是 FunctionComponent 的父级，当然这里不是DOM的父级，只是理解为父级</span>
  element<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span> <span class="token comment">// 这里也是一个预埋设计</span>
  <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
  <span class="token comment">// `element.dom = dom;`，可以推导出: element.renderElement.dom=真实DOM</span>
<span class="token punctuation">}</span>
<span class="token comment">// 创建类组件真实的DOM对象</span>
<span class="token keyword">function</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token comment">/**
   * class ClassCounter extends React.Component {
   *   constructor(props) {
   *     super(props);
   *   }
   *   render() {
   *     return React.createElement('div', { id: 'counter' }, 'hello');
   *   }
   * }
   */</span>
  <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentWillMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    componentInstance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  element<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span> <span class="token comment">// 这里也是一个预埋设计</span>
  <span class="token keyword">let</span> renderElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  componentInstance<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span> <span class="token comment">// 这里也是一个预埋设计</span>
  <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  renderElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span> <span class="token comment">// 此处需要进行一次挂载,便于配合生命周期</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentDidMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    componentInstance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
  <span class="token comment">// `element.dom = dom;`，可以推导出: element.componentInstance.renderElement.dom=真实DOM</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
let element = React.createElement('button',
  { id: 'sayHello', onClick },
  'say', React.createElement('span', { onClick: spanClick, style: { color: 'red' } }, 'Hello')
);
 */</span>
<span class="token keyword">function</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span> <span class="token comment">// div button span</span>
  <span class="token keyword">let</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//真实DOM对象</span>
  <span class="token comment">//1，创建虚拟dom的子节点</span>
  <span class="token function">createNativeDOMChildren</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//2，给DOM元素添加属性</span>
  <span class="token function">setProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createNativeDOMChildren</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> childrenNodeArr <span class="token operator">=</span> children <span class="token operator">&amp;&amp;</span> <span class="token function">flatten</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenNodeArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenNodeArr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> child <span class="token operator">=</span> childrenNodeArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//child会传递给element，预埋设计，跟`element.dom = dom;`逻辑一样，给element添加索引</span>
      child<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token keyword">let</span> childDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
      parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> element<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br></div></div><h2 id="_2-getderivedstatefromprops"><a href="#_2-getderivedstatefromprops" aria-hidden="true" class="header-anchor">#</a> 2. getDerivedStateFromProps</h2> <h3 id="_2-1-src-index-js"><a href="#_2-1-src-index-js" aria-hidden="true" class="header-anchor">#</a> 2.1. src/index.js</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'./react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> defaultProps <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">'珠峰架构'</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> number<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> number<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ChildCounter number<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>parent<span class="token operator">+</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">ChildCounter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'ChildCounter'</span> <span class="token punctuation">,</span>number<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> prevState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> number <span class="token punctuation">}</span> <span class="token operator">=</span> nextProps<span class="token punctuation">;</span>
    <span class="token comment">// 当传入的type发生变化的时候，更新state</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> number<span class="token punctuation">:</span> number <span class="token operator">*</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//偶数乘以2</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> number<span class="token punctuation">:</span> number <span class="token operator">*</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//奇数乘以3</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> number<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>child<span class="token operator">+</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>Counter <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h3 id="_2-2-src-react-component-js"><a href="#_2-2-src-react-component-js" aria-hidden="true" class="header-anchor">#</a> 2.2. src/react/component.js</h3> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> compareTwoElements <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./vdom'</span><span class="token punctuation">;</span>

<span class="token comment">//更新队列</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> <span class="token punctuation">{</span>
  updaters<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//要执行的updater对象</span>
  isPending<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token comment">//是否处于批量更新模式</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">updater</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>updaters<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>updater<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//需要调用batchUpdate才更新</span>
  <span class="token function">batchUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> updaters <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//开始更新</span>
    <span class="token keyword">let</span> updater<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>updater <span class="token operator">=</span> updaters<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      updater<span class="token punctuation">.</span><span class="token function">updateComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新所有 dirty 组件</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//更新完毕</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Updater</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">componentInstance</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span><span class="token comment">//Updater和类组件1对1关系</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pendingStates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//更新如果批量的，先把状态暂存到数组，最后更新时统一合并</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nextProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//新的属性对象</span>
  <span class="token punctuation">}</span>
  <span class="token function">addState</span><span class="token punctuation">(</span><span class="token parameter">partialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pendingStates<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把新状态放入数组</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">emitUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nextProps <span class="token operator">=</span> nextProps<span class="token punctuation">;</span>
    <span class="token comment">//如果有新属性对象 或者 队列处于‘休息’状态，直接更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProps <span class="token operator">||</span> <span class="token operator">!</span>updateQueue<span class="token punctuation">.</span>isPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//否则交给队列处理</span>
      updateQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">updateComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> componentInstance<span class="token punctuation">,</span> pendingStates<span class="token punctuation">,</span> nextProps <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProps <span class="token operator">||</span> pendingStates<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//长度大于0，有要合并的状态</span>
      <span class="token function">shouldUpdate</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> nextProps<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//合并及返回新的状态</span>
  <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> componentInstance<span class="token punctuation">,</span> pendingStates <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> state <span class="token punctuation">}</span> <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span><span class="token comment">//老组件当前状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingStates<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//迭代pendingStates，将所有状态合并到state</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pendingStates<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> nextState <span class="token operator">=</span> pendingStates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> nextState <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token function">nextState</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> <span class="token operator">...</span>nextState <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    pendingStates<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//合并后清空数组</span>
    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//判断是否要更新</span>
<span class="token keyword">function</span> <span class="token function">shouldUpdate</span><span class="token punctuation">(</span><span class="token parameter">componentInstance<span class="token punctuation">,</span> nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  componentInstance<span class="token punctuation">.</span>props <span class="token operator">=</span> nextProps<span class="token punctuation">;</span><span class="token comment">//将新props赋给组件</span>
  componentInstance<span class="token punctuation">.</span>state <span class="token operator">=</span> nextState<span class="token punctuation">;</span><span class="token comment">//将新state赋给组件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    componentInstance<span class="token punctuation">.</span>shouldComponentUpdate <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>componentInstance<span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>
      <span class="token function">getComponentDefaultProps</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">,</span>
      nextState
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果shouldComponentUpdate返回false，则不更新</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  componentInstance<span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//让组件强制更新</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$updater <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Updater</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//this 就是类组件的实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 当前状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nextProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 下一个属性对象</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//批量更新 partial，状态可能会被合并</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">partialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$updater<span class="token punctuation">.</span><span class="token function">addState</span><span class="token punctuation">(</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//进行组件更新</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> props<span class="token punctuation">,</span> state<span class="token punctuation">,</span> renderElement<span class="token punctuation">:</span> oldRenderElement <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> <span class="token function">getComponentDefaultProps</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>componentWillUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">componentWillUpdate</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//nextProps,nextState</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> newRenderElement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> currentElement <span class="token operator">=</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderElement <span class="token operator">=</span> currentElement<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>componentDidUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//prevProps,prevState</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getComponentDefaultProps</span><span class="token punctuation">(</span><span class="token parameter">componentInstance<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>props<span class="token punctuation">)</span> props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> defaultProps <span class="token punctuation">}</span> <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> propName <span class="token keyword">in</span> defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> defaultProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> props<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//类组件的本质也是函数(请参考new Class原理)，通过`isReactComponent`判断是类组件还是函数组件</span>
<span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  Component
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br></div></div><h3 id="_2-3-src-react-vdom-js"><a href="#_2-3-src-react-vdom-js" aria-hidden="true" class="header-anchor">#</a> 2.3. src/react/vdom.js</h3> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span> <span class="token constant">BOOLEAN</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span> onlyOne<span class="token punctuation">,</span> flatten<span class="token punctuation">,</span> patchProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> updateDepth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//递归深度</span>
<span class="token keyword">let</span> diffQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//补丁包，比较移动、添加、删除的节点</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span><span class="token parameter">oldRenderElement<span class="token punctuation">,</span> newRenderElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  oldRenderElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newRenderElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> oldRenderElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span><span class="token comment">//取出老的DOM节点（此处，element.dom = dom;已经做过预埋设计）</span>
  <span class="token keyword">let</span> currentElement <span class="token operator">=</span> oldRenderElement<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newRenderElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//新的虚拟DOM为null，删掉老节点</span>
    currentDOM <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">.</span>type <span class="token operator">!=</span> newRenderElement<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// span div function class</span>
    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//类型不同，新节点替换老节点</span>
    currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newDOM<span class="token punctuation">,</span> currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentElement <span class="token operator">=</span> newRenderElement<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//新老节点都存在，类型一样。进行 dom-diff 深度比较，比较他们的属性和子节点，并尽可能复用老节点</span>
    <span class="token function">updateElement</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> currentElement<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// *** 如果是`函数组件`或`类组件`,`oldElement`就是`oldRenderElement`</span>
<span class="token comment">// renderElement 是函数组件执行后 或 类组件调用render后返回的虚拟DOM，虚拟DOM是由React.createElement创建的</span>
<span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * !!!给 src/react/index.js 做比对，如果是字符串或者数字，仍需要获取dom，并根据dom内容更新
   */</span>
  <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> newElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span> <span class="token operator">&amp;&amp;</span> newElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>content <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentDOM<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// div span p</span>
    <span class="token comment">//先更新父节点的属性，再比较更新子节点（返回来也可以）</span>
    <span class="token function">updateDOMProperties</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//把newElement.props赋给oldElement.props，不仅要更新dom上的attribute，还是要同步props</span>
    oldElement<span class="token punctuation">.</span>props <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 函数组件</span>
    <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 类组件</span>
    <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  updateDepth<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//每递归新一层，updateDepth++</span>
  <span class="token function">diff</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  updateDepth<span class="token operator">--</span><span class="token punctuation">;</span><span class="token comment">//每diff完一层，返回上一级，updateDepth--</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>updateDepth <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//当updateDepth为0，说明到了最上层，执行补丁包</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行补丁</span>
    diffQueue<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//注意 MOVE 的逻辑：删除原节点，再插入到新的位置，因此需要缓存老DOM</span>
<span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">diffQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> deleteMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//缓存老的dom</span>
  <span class="token keyword">let</span> deleteChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//要删除的子节点</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> fromIndex<span class="token punctuation">,</span> toIndex<span class="token punctuation">,</span> componentInstance <span class="token punctuation">}</span> <span class="token operator">=</span> difference<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token constant">REMOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//移动或删除</span>
      <span class="token keyword">let</span> oldChildDOM <span class="token operator">=</span> difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//老的DOM节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//移动则缓存</span>
        deleteMap<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildDOM<span class="token punctuation">;</span><span class="token comment">//缓存老的DOM，方便复用</span>
      <span class="token punctuation">}</span>
      deleteChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> childDOM<span class="token punctuation">:</span> oldChildDOM<span class="token punctuation">,</span> componentInstance <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//把移动和删除的节点，执行删除操作。因为移动的真实DOM已经缓存，所以还可以拿到</span>
  deleteChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> childDOM<span class="token punctuation">,</span> componentInstance <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    childDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果componentInstance存在，说明是类组件，如果卸载则执行 componentInstanceWillUnmount</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance <span class="token operator">&amp;&amp;</span> componentInstance<span class="token punctuation">.</span>componentWillUnmount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      componentInstance<span class="token punctuation">.</span><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//diff函数处理完毕后</span>
    <span class="token comment">//MOVE具有fromIndex,toIndex</span>
    <span class="token comment">//INSERT具有toIndex,dom</span>
    <span class="token comment">//REMOVE具有fromIndex</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> fromIndex<span class="token punctuation">,</span> toIndex<span class="token punctuation">,</span> parentNode<span class="token punctuation">,</span> dom <span class="token punctuation">}</span> <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">INSERT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertChildAt</span><span class="token punctuation">(</span>parentNode<span class="token punctuation">,</span> dom<span class="token punctuation">,</span> toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertChildAt</span><span class="token punctuation">(</span>parentNode<span class="token punctuation">,</span> deleteMap<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//释放资源</span>
  deleteMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  deleteChildren<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//向index索引位置插入元素</span>
<span class="token keyword">function</span> <span class="token function">insertChildAt</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> newChildDOM<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldChild <span class="token operator">=</span> parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//拿到老的节点</span>
  oldChild <span class="token operator">?</span> parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newChildDOM<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span> <span class="token punctuation">:</span> parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>newChildDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldChildrenElementsMap <span class="token operator">=</span> <span class="token function">getChildrenElementsMap</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> newChildrenElementsMap <span class="token operator">=</span> <span class="token function">getNewChildrenElementsMap</span><span class="token punctuation">(</span>oldChildrenElementsMap<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">//由于深度优先，所有子节点在diffQueue中的位置，比父节点位置靠前</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newChildElement <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> newKey <span class="token operator">=</span> newChildElement<span class="token punctuation">.</span>key <span class="token operator">||</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement <span class="token operator">===</span> oldChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//同一个对象，在构建newChildrenElementsMap时确定</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            parentNode<span class="token punctuation">,</span><span class="token comment">//记录父节点</span>
            type<span class="token punctuation">:</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span>
            fromIndex<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>
            toIndex<span class="token punctuation">:</span> i
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//如果类型不相等，插入新元素（后边该key对应的老元素将被迭代，并会标记为删除）</span>
        diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          parentNode<span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span>
          toIndex<span class="token punctuation">:</span> i<span class="token punctuation">,</span>
          dom<span class="token punctuation">:</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      newChildElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span><span class="token comment">//新的节点，下次更新时，将变成老节点，需要_mountIndex</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//迭代老节点，如果新节点map中不包含老key，或者key相同type不同，则将老节点标记为删除</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> oldKey <span class="token keyword">in</span> oldChildrenElementsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementsMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildrenElementsMap<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>oldKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//新老key相同</span>
      <span class="token keyword">let</span> newChildElement <span class="token operator">=</span> newChildrenElementsMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//如果key相同，type相同，在getNewChildrenElementsMap方法中，就确保了newChildElement === oldChildElement</span>
      <span class="token comment">//当然，也可以使用canDeepCompare判断</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildElement <span class="token operator">!==</span> newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//type不同</span>
        diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          parentNode<span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span>
          fromIndex<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>
          componentInstance<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>componentInstance <span class="token comment">//如果存在componentInstance，说明是类组件</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//新map不包含老key，标记老元素删除</span>
      diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        parentNode<span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span>
        fromIndex<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>
        componentInstance<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>componentInstance <span class="token comment">//如果不存在，则为undefined</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getNewChildrenElementsMap</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElementsMap<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newChildElement <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> newKey <span class="token operator">=</span> newChildElement<span class="token punctuation">.</span>key <span class="token operator">||</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// key一样，类型一样</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canDeepCompare</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">updateElement</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新属性后，递归更新子节点</span>
        newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildElement<span class="token punctuation">;</span><span class="token comment">//复用老的虚拟DOM，老的虚拟DOM的dom属性，指向真实DOM</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//新数组上的每个element都映射到map，其中包含了跟oldChildElement相等的元素</span>
      map<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span> <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//是否可以深度递归比较</span>
<span class="token keyword">function</span> <span class="token function">canDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">oldChildElement<span class="token punctuation">,</span> newChildElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>oldChildElement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> oldChildElement<span class="token punctuation">.</span>type <span class="token operator">===</span> newChildElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取老map</span>
<span class="token keyword">function</span> <span class="token function">getChildrenElementsMap</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldKey <span class="token operator">=</span> oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">||</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">updateDOMProperties</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">patchProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//类组件element.componentInstance.renderElement.dom=真实DOM</span>
<span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span>
  <span class="token keyword">let</span> updater <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span>$updater<span class="token punctuation">;</span>
  <span class="token keyword">let</span> nextProps <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentWillReceiveProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    componentInstance<span class="token punctuation">.</span><span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//getDerivedStateFromProps 在 componentWillReceiveProps 后边</span>
  <span class="token comment">//type指class,getDerivedStateFromProps是静态属性</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>type<span class="token punctuation">.</span>getDerivedStateFromProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> newState <span class="token operator">=</span> newElement<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      componentInstance<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token operator">...</span>newState <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  updater<span class="token punctuation">.</span><span class="token function">emitUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//函数组件element.renderElement.dom=真实DOM</span>
<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldRenderElement <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>renderElement<span class="token punctuation">;</span>
  <span class="token keyword">let</span> newRenderElement <span class="token operator">=</span> newElement<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newElement<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> currentDOM<span class="token punctuation">;</span><span class="token comment">//更新之后，重新挂载</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Uncaught DOMException: Failed to execute 'createElement' on 'Document': The tag name provided ('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">') is not a valid name.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * !!! element 如果是字符串或者数字，修改成在 createElement时，封装成对象
   */</span>
  <span class="token keyword">let</span> dom<span class="token punctuation">;</span>
  element <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果是数组，只取第一个</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span> <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 字符串或者数字</span>
    dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 原生DOM节点</span>
    dom <span class="token operator">=</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 函数组件</span>
    dom <span class="token operator">=</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 类组件</span>
    dom <span class="token operator">=</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">BOOLEAN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// boolean</span>
    dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * `element`是ReactElement创建出来的虚拟DOM，让虚拟的DOM的`dom`属性指向真实DOM
   * 这里是一个预埋设计，或者叫铺垫，通过虚拟DOM能够获取真实DOM
   */</span>
  element<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 创建函数组件真实的DOM对象</span>
<span class="token keyword">function</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//element: $$typeof, type, key, ref, props</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token comment">/**
   * function FunctionComponent(props) {
   *   return React.createElement('div', { id: 'counter' }, 'hello');
   * }
   */</span>
  <span class="token keyword">let</span> renderElement <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// type === FunctionComponent</span>
  <span class="token comment">//element 是 React.createElement(FunctionComponent, config, children); 的返回值</span>
  <span class="token comment">//element 是 FunctionComponent 的父级，当然这里不是DOM的父级，只是理解为父级</span>
  element<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span> <span class="token comment">// 这里也是一个预埋设计</span>
  <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
  <span class="token comment">// `element.dom = dom;`，可以推导出: element.renderElement.dom=真实DOM</span>
<span class="token punctuation">}</span>
<span class="token comment">// 创建类组件真实的DOM对象</span>
<span class="token keyword">function</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token comment">/**
   * class ClassCounter extends React.Component {
   *   constructor(props) {
   *     super(props);
   *   }
   *   render() {
   *     return React.createElement('div', { id: 'counter' }, 'hello');
   *   }
   * }
   */</span>
  <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentWillMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    componentInstance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span>getDerivedStateFromProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> newState <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      componentInstance<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token operator">...</span>newState <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  element<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span> <span class="token comment">// 这里也是一个预埋设计</span>
  <span class="token keyword">let</span> renderElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  componentInstance<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span> <span class="token comment">// 这里也是一个预埋设计</span>
  <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  renderElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span> <span class="token comment">// 此处需要进行一次挂载,便于配合生命周期</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentDidMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    componentInstance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
  <span class="token comment">// `element.dom = dom;`，可以推导出: element.componentInstance.renderElement.dom=真实DOM</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
let element = React.createElement('button',
  { id: 'sayHello', onClick },
  'say', React.createElement('span', { onClick: spanClick, style: { color: 'red' } }, 'Hello')
);
 */</span>
<span class="token keyword">function</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span> <span class="token comment">// div button span</span>
  <span class="token keyword">let</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//真实DOM对象</span>
  <span class="token comment">//1，创建虚拟dom的子节点</span>
  <span class="token function">createNativeDOMChildren</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//2，给DOM元素添加属性</span>
  <span class="token function">setProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createNativeDOMChildren</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> childrenNodeArr <span class="token operator">=</span> children <span class="token operator">&amp;&amp;</span> <span class="token function">flatten</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenNodeArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenNodeArr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> child <span class="token operator">=</span> childrenNodeArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//child会传递给element，预埋设计，跟`element.dom = dom;`逻辑一样，给element添加索引</span>
      child<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token keyword">let</span> childDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
      parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> element<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br></div></div><h2 id="_3-getsnapshotbeforeupdate"><a href="#_3-getsnapshotbeforeupdate" aria-hidden="true" class="header-anchor">#</a> 3. getSnapshotBeforeUpdate</h2> <h3 id="_3-1-数组与rest参数"><a href="#_3-1-数组与rest参数" aria-hidden="true" class="header-anchor">#</a> 3.1 数组与rest参数</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'div1'</span><span class="token punctuation">,</span> <span class="token string">'div2'</span><span class="token punctuation">,</span> <span class="token string">'div3'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">nest</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">nest</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[ [ 'div1', 'div2', 'div3' ] ]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_3-2-src-index-js"><a href="#_3-2-src-index-js" aria-hidden="true" class="header-anchor">#</a> 3.2. src/index.js</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'./react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">ScrollingList</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  wrapper
  timeID
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> messages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>wrapper <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{current:null}</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">addMessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      messages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>messages<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timeID <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">//设置定时器</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//清除定时器</span>
    window<span class="token punctuation">.</span><span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function-variable function">getSnapshotBeforeUpdate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取当前rootNode的scrollHeight，传到componentDidUpdate 的参数perScrollHeight</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrapper<span class="token punctuation">.</span>current<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">;</span><span class="token comment">//更新前先取一下内容的高</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token parameter">pervProps<span class="token punctuation">,</span> pervState<span class="token punctuation">,</span> prevScrollHeight</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> curScrollTop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrapper<span class="token punctuation">.</span>current<span class="token punctuation">.</span>scrollTop<span class="token punctuation">;</span><span class="token comment">//当前向上卷去的高度</span>
    <span class="token comment">//当前向上卷去的高度加上增加的内容高度</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>wrapper<span class="token punctuation">.</span>current<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span> curScrollTop <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>wrapper<span class="token punctuation">.</span>current<span class="token punctuation">.</span>scrollHeight <span class="token operator">-</span> prevScrollHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> style <span class="token operator">=</span> <span class="token punctuation">{</span>
      height<span class="token punctuation">:</span> <span class="token string">'100px'</span><span class="token punctuation">,</span>
      width<span class="token punctuation">:</span> <span class="token string">'200px'</span><span class="token punctuation">,</span>
      border<span class="token punctuation">:</span> <span class="token string">'1px solid red'</span><span class="token punctuation">,</span>
      overflow<span class="token punctuation">:</span> <span class="token string">'auto'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span> ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>wrapper<span class="token punctuation">}</span> <span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
          <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>message<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>ScrollingList <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h3 id="_3-3-src-react-component-js"><a href="#_3-3-src-react-component-js" aria-hidden="true" class="header-anchor">#</a> 3.3. src/react/component.js</h3> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> compareTwoElements <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./vdom'</span><span class="token punctuation">;</span>

<span class="token comment">//更新队列</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> <span class="token punctuation">{</span>
  updaters<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//要执行的updater对象</span>
  isPending<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token comment">//是否处于批量更新模式</span>
  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">updater</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>updaters<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>updater<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//需要调用batchUpdate才更新</span>
  <span class="token function">batchUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> updaters <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//开始更新</span>
    <span class="token keyword">let</span> updater<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>updater <span class="token operator">=</span> updaters<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      updater<span class="token punctuation">.</span><span class="token function">updateComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新所有 dirty 组件</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//更新完毕</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Updater</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">componentInstance</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span><span class="token comment">//Updater和类组件1对1关系</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pendingStates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//更新如果批量的，先把状态暂存到数组，最后更新时统一合并</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nextProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//新的属性对象</span>
  <span class="token punctuation">}</span>
  <span class="token function">addState</span><span class="token punctuation">(</span><span class="token parameter">partialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pendingStates<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把新状态放入数组</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">emitUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nextProps <span class="token operator">=</span> nextProps<span class="token punctuation">;</span>
    <span class="token comment">//如果有新属性对象 或者 队列处于‘休息’状态，直接更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProps <span class="token operator">||</span> <span class="token operator">!</span>updateQueue<span class="token punctuation">.</span>isPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//否则交给队列处理</span>
      updateQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">updateComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> componentInstance<span class="token punctuation">,</span> pendingStates<span class="token punctuation">,</span> nextProps <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProps <span class="token operator">||</span> pendingStates<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//长度大于0，有要合并的状态</span>
      <span class="token function">shouldUpdate</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> nextProps<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//合并及返回新的状态</span>
  <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> componentInstance<span class="token punctuation">,</span> pendingStates <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> state <span class="token punctuation">}</span> <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span><span class="token comment">//老组件当前状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingStates<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//迭代pendingStates，将所有状态合并到state</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pendingStates<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> nextState <span class="token operator">=</span> pendingStates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> nextState <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token function">nextState</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> <span class="token operator">...</span>nextState <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    pendingStates<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//合并后清空数组</span>
    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//判断是否要更新</span>
<span class="token keyword">function</span> <span class="token function">shouldUpdate</span><span class="token punctuation">(</span><span class="token parameter">componentInstance<span class="token punctuation">,</span> nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  componentInstance<span class="token punctuation">.</span>props <span class="token operator">=</span> nextProps<span class="token punctuation">;</span><span class="token comment">//将新props赋给组件</span>
  componentInstance<span class="token punctuation">.</span>state <span class="token operator">=</span> nextState<span class="token punctuation">;</span><span class="token comment">//将新state赋给组件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    componentInstance<span class="token punctuation">.</span>shouldComponentUpdate <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>componentInstance<span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>
      <span class="token function">getComponentDefaultProps</span><span class="token punctuation">(</span>componentInstance<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">,</span>
      nextState
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果shouldComponentUpdate返回false，则不更新</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  componentInstance<span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//让组件强制更新</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$updater <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Updater</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//this 就是类组件的实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 当前状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nextProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 下一个属性对象</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//批量更新 partial，状态可能会被合并</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">partialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$updater<span class="token punctuation">.</span><span class="token function">addState</span><span class="token punctuation">(</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//进行组件更新</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> props<span class="token punctuation">,</span> state<span class="token punctuation">,</span> renderElement<span class="token punctuation">:</span> oldRenderElement <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> <span class="token function">getComponentDefaultProps</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>componentWillUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">componentWillUpdate</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//nextProps,nextState</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> getSnapshotBeforeUpdate <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> extraArgs <span class="token operator">=</span> getSnapshotBeforeUpdate <span class="token operator">&amp;&amp;</span> <span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newRenderElement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> currentElement <span class="token operator">=</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderElement <span class="token operator">=</span> currentElement<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>componentDidUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> state<span class="token punctuation">,</span> extraArgs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//prevProps,prevState,extraArgs</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getComponentDefaultProps</span><span class="token punctuation">(</span><span class="token parameter">componentInstance<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>props<span class="token punctuation">)</span> props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> defaultProps <span class="token punctuation">}</span> <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token class-name">__proto__</span><span class="token punctuation">.</span>constructor<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> propName <span class="token keyword">in</span> defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> defaultProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> props<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//类组件的本质也是函数(请参考new Class原理)，通过`isReactComponent`判断是类组件还是函数组件</span>
<span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  Component
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br></div></div><h3 id="_3-4-src-react-index-js"><a href="#_3-4-src-react-index-js" aria-hidden="true" class="header-anchor">#</a> 3.4. src/react/index.js</h3> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">BOOLEAN</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ReactElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./vdom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> flatten <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>

<span class="token comment">//利用数组 rest，方便children直接拿到数组</span>
<span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__source<span class="token punctuation">;</span><span class="token comment">//dev环境下变量，不考虑该变量</span>
  <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__self<span class="token punctuation">;</span><span class="token comment">//dev环境下变量，不考虑该变量</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>
  <span class="token keyword">let</span> $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//span div button</span>
    $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">ELEMENT</span><span class="token punctuation">;</span><span class="token comment">//是一个原生的DOM类型</span>
    <span class="token comment">/**
     * 这里要注意，用真实React在测试时，你会发现：
     * let e1 = React.createElement('abc');
     * console.log(e1); // $$typeof 仍然是 react.element类型，type: 'abc'
     */</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span>defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> defaultProps <span class="token operator">=</span> type<span class="token punctuation">.</span>defaultProps<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> propName <span class="token keyword">in</span> defaultProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> defaultProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Warning: React.createElement: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">typeof</span> type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * 打平children，[['div']] =&gt; ['div']，递归打平的逻辑是什么呢？
   * 因为jsx会被babel解析成AST语法树，生成的每个虚拟DOM，都会调用React.createElement。
   * 因此就相当于 React.createElement('div',{id:'parent'},React.createElement('div',{id:'child'}));
   * 所以，在React.createElement中打平children就实现了递归打平。
   */</span>
  children <span class="token operator">=</span> <span class="token function">flatten</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * !!! 叶子节点为字符串或数字时，需要包装成对象，这样才能指向dom节点，并根据dom更新内容
   * 见 src/react/vdom.js updateElement方法
   * 经过这样的改造后，element的输出结构，将跟官方有区别
   */</span>
  props<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ret <span class="token operator">=</span> item<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token constant">BOOLEAN</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token constant">BOOLEAN</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> item <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> item <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span>$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> current<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  Component
<span class="token punctuation">}</span>
<span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span>
  createRef<span class="token punctuation">,</span>
  createElement<span class="token punctuation">,</span>
  Component
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><p>打平<code>children</code>，<code>[['div']] =&gt; ['div']</code>，<code>递归打平</code>的逻辑是什么呢？<br></p> <blockquote><p>因为jsx会被babel解析成AST语法树，生成的每个虚拟DOM，都会调用<code>React.createElement</code>。<br>
因此就相当于 <code>React.createElement('div',{id:'parent'},React.createElement('div',{id:'child'}))</code>;<br>
所以，在<code>React.createElement</code>中打平<code>children</code>就实现了<code>递归打平</code>。<br></p></blockquote> <h3 id="_3-5-src-react-vdom-js"><a href="#_3-5-src-react-vdom-js" aria-hidden="true" class="header-anchor">#</a> 3.5. src/react/vdom.js</h3> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span> <span class="token constant">BOOLEAN</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span> onlyOne<span class="token punctuation">,</span> flatten<span class="token punctuation">,</span> patchProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> updateDepth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//递归深度</span>
<span class="token keyword">let</span> diffQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//补丁包，比较移动、添加、删除的节点</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span><span class="token parameter">oldRenderElement<span class="token punctuation">,</span> newRenderElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  oldRenderElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newRenderElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> oldRenderElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span><span class="token comment">//取出老的DOM节点（此处，element.dom = dom;已经做过预埋设计）</span>
  <span class="token keyword">let</span> currentElement <span class="token operator">=</span> oldRenderElement<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newRenderElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//新的虚拟DOM为null，删掉老节点</span>
    currentDOM <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">.</span>type <span class="token operator">!=</span> newRenderElement<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// span div function class</span>
    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//类型不同，新节点替换老节点</span>
    currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newDOM<span class="token punctuation">,</span> currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentElement <span class="token operator">=</span> newRenderElement<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//新老节点都存在，类型一样。进行 dom-diff 深度比较，比较他们的属性和子节点，并尽可能复用老节点</span>
    <span class="token function">updateElement</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> currentElement<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// *** 如果是`函数组件`或`类组件`,`oldElement`就是`oldRenderElement`</span>
<span class="token comment">// renderElement 是函数组件执行后 或 类组件调用render后返回的虚拟DOM，虚拟DOM是由React.createElement创建的</span>
<span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * !!!给 src/react/index.js 做比对，如果是字符串或者数字，仍需要获取dom，并根据dom内容更新
   */</span>
  <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> newElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span> <span class="token operator">&amp;&amp;</span> newElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>content <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentDOM<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// div span p</span>
    <span class="token comment">//先更新父节点的属性，再比较更新子节点（返回来也可以）</span>
    <span class="token function">updateDOMProperties</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//把newElement.props赋给oldElement.props，不仅要更新dom上的attribute，还是要同步props</span>
    oldElement<span class="token punctuation">.</span>props <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 函数组件</span>
    <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 类组件</span>
    <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  updateDepth<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//每递归新一层，updateDepth++</span>
  <span class="token function">diff</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  updateDepth<span class="token operator">--</span><span class="token punctuation">;</span><span class="token comment">//每diff完一层，返回上一级，updateDepth--</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>updateDepth <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//当updateDepth为0，说明到了最上层，执行补丁包</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行补丁</span>
    diffQueue<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//注意 MOVE 的逻辑：删除原节点，再插入到新的位置，因此需要缓存老DOM</span>
<span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">diffQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> deleteMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//缓存老的dom</span>
  <span class="token keyword">let</span> deleteChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//要删除的子节点</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> fromIndex<span class="token punctuation">,</span> toIndex<span class="token punctuation">,</span> componentInstance <span class="token punctuation">}</span> <span class="token operator">=</span> difference<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token constant">REMOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//移动或删除</span>
      <span class="token keyword">let</span> oldChildDOM <span class="token operator">=</span> difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//老的DOM节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//移动则缓存</span>
        deleteMap<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildDOM<span class="token punctuation">;</span><span class="token comment">//缓存老的DOM，方便复用</span>
      <span class="token punctuation">}</span>
      deleteChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> childDOM<span class="token punctuation">:</span> oldChildDOM<span class="token punctuation">,</span> componentInstance <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//把移动和删除的节点，执行删除操作。因为移动的真实DOM已经缓存，所以还可以拿到</span>
  deleteChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> childDOM<span class="token punctuation">,</span> componentInstance <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    childDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果componentInstance存在，说明是类组件，如果卸载则执行 componentInstanceWillUnmount</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance <span class="token operator">&amp;&amp;</span> componentInstance<span class="token punctuation">.</span>componentWillUnmount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      componentInstance<span class="token punctuation">.</span><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//diff函数处理完毕后</span>
    <span class="token comment">//MOVE具有fromIndex,toIndex</span>
    <span class="token comment">//INSERT具有toIndex,dom</span>
    <span class="token comment">//REMOVE具有fromIndex</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> fromIndex<span class="token punctuation">,</span> toIndex<span class="token punctuation">,</span> parentNode<span class="token punctuation">,</span> dom <span class="token punctuation">}</span> <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">INSERT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertChildAt</span><span class="token punctuation">(</span>parentNode<span class="token punctuation">,</span> dom<span class="token punctuation">,</span> toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertChildAt</span><span class="token punctuation">(</span>parentNode<span class="token punctuation">,</span> deleteMap<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//释放资源</span>
  deleteMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  deleteChildren<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//向index索引位置插入元素</span>
<span class="token keyword">function</span> <span class="token function">insertChildAt</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> newChildDOM<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldChild <span class="token operator">=</span> parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//拿到老的节点</span>
  oldChild <span class="token operator">?</span> parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newChildDOM<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span> <span class="token punctuation">:</span> parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>newChildDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldChildrenElementsMap <span class="token operator">=</span> <span class="token function">getChildrenElementsMap</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> newChildrenElementsMap <span class="token operator">=</span> <span class="token function">getNewChildrenElementsMap</span><span class="token punctuation">(</span>oldChildrenElementsMap<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">//由于深度优先，所有子节点在diffQueue中的位置，比父节点位置靠前</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newChildElement <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> newKey <span class="token operator">=</span> newChildElement<span class="token punctuation">.</span>key <span class="token operator">||</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement <span class="token operator">===</span> oldChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//同一个对象，在构建newChildrenElementsMap时确定</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            parentNode<span class="token punctuation">,</span><span class="token comment">//记录父节点</span>
            type<span class="token punctuation">:</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span>
            fromIndex<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>
            toIndex<span class="token punctuation">:</span> i
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//如果类型不相等，插入新元素（后边该key对应的老元素将被迭代，并会标记为删除）</span>
        diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          parentNode<span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span>
          toIndex<span class="token punctuation">:</span> i<span class="token punctuation">,</span>
          dom<span class="token punctuation">:</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      newChildElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span><span class="token comment">//新的节点，下次更新时，将变成老节点，需要_mountIndex</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//迭代老节点，如果新节点map中不包含老key，或者key相同type不同，则将老节点标记为删除</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> oldKey <span class="token keyword">in</span> oldChildrenElementsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementsMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildrenElementsMap<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>oldKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//新老key相同</span>
      <span class="token keyword">let</span> newChildElement <span class="token operator">=</span> newChildrenElementsMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//如果key相同，type相同，在getNewChildrenElementsMap方法中，就确保了newChildElement === oldChildElement</span>
      <span class="token comment">//当然，也可以使用canDeepCompare判断</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildElement <span class="token operator">!==</span> newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//type不同</span>
        diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          parentNode<span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span>
          fromIndex<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>
          componentInstance<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>componentInstance <span class="token comment">//如果存在componentInstance，说明是类组件</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//新map不包含老key，标记老元素删除</span>
      diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        parentNode<span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span>
        fromIndex<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>
        componentInstance<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>componentInstance <span class="token comment">//如果不存在，则为undefined</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getNewChildrenElementsMap</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElementsMap<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newChildElement <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> newKey <span class="token operator">=</span> newChildElement<span class="token punctuation">.</span>key <span class="token operator">||</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// key一样，类型一样</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canDeepCompare</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">updateElement</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新属性后，递归更新子节点</span>
        newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildElement<span class="token punctuation">;</span><span class="token comment">//复用老的虚拟DOM，老的虚拟DOM的dom属性，指向真实DOM</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//新数组上的每个element都映射到map，其中包含了跟oldChildElement相等的元素</span>
      map<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span> <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//是否可以深度递归比较</span>
<span class="token keyword">function</span> <span class="token function">canDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">oldChildElement<span class="token punctuation">,</span> newChildElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>oldChildElement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> oldChildElement<span class="token punctuation">.</span>type <span class="token operator">===</span> newChildElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取老map</span>
<span class="token keyword">function</span> <span class="token function">getChildrenElementsMap</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldKey <span class="token operator">=</span> oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">||</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">updateDOMProperties</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">patchProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//类组件element.componentInstance.renderElement.dom=真实DOM</span>
<span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span>
  <span class="token keyword">let</span> updater <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span>$updater<span class="token punctuation">;</span>
  <span class="token keyword">let</span> nextProps <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentWillReceiveProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    componentInstance<span class="token punctuation">.</span><span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//getDerivedStateFromProps 在 componentWillReceiveProps 后边</span>
  <span class="token comment">//type指class,getDerivedStateFromProps是静态属性</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>type<span class="token punctuation">.</span>getDerivedStateFromProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> newState <span class="token operator">=</span> newElement<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      componentInstance<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token operator">...</span>newState <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  updater<span class="token punctuation">.</span><span class="token function">emitUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//函数组件element.renderElement.dom=真实DOM</span>
<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldRenderElement <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>renderElement<span class="token punctuation">;</span>
  <span class="token keyword">let</span> newRenderElement <span class="token operator">=</span> newElement<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newElement<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> currentDOM<span class="token punctuation">;</span><span class="token comment">//更新之后，重新挂载</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Uncaught DOMException: Failed to execute 'createElement' on 'Document': The tag name provided ('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">') is not a valid name.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * !!! element 如果是字符串或者数字，修改成在 createElement时，封装成对象
   */</span>
  <span class="token keyword">let</span> dom<span class="token punctuation">;</span>
  element <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果是数组，只取第一个</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span> <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 字符串或者数字</span>
    dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 原生DOM节点</span>
    dom <span class="token operator">=</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 函数组件</span>
    dom <span class="token operator">=</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 类组件</span>
    dom <span class="token operator">=</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">BOOLEAN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// boolean</span>
    dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * `element`是ReactElement创建出来的虚拟DOM，让虚拟的DOM的`dom`属性指向真实DOM
   * 这里是一个预埋设计，或者叫铺垫，通过虚拟DOM能够获取真实DOM
   */</span>
  element<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 创建函数组件真实的DOM对象</span>
<span class="token keyword">function</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//element: $$typeof, type, key, ref, props</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token comment">/**
   * function FunctionComponent(props) {
   *   return React.createElement('div', { id: 'counter' }, 'hello');
   * }
   */</span>
  <span class="token keyword">let</span> renderElement <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// type === FunctionComponent</span>
  <span class="token comment">//element 是 React.createElement(FunctionComponent, config, children); 的返回值</span>
  <span class="token comment">//element 是 FunctionComponent 的父级，当然这里不是DOM的父级，只是理解为父级</span>
  element<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span> <span class="token comment">// 这里也是一个预埋设计</span>
  <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
  <span class="token comment">// `element.dom = dom;`，可以推导出: element.renderElement.dom=真实DOM</span>
<span class="token punctuation">}</span>
<span class="token comment">// 创建类组件真实的DOM对象</span>
<span class="token keyword">function</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token comment">/**
   * class ClassCounter extends React.Component {
   *   constructor(props) {
   *     super(props);
   *   }
   *   render() {
   *     return React.createElement('div', { id: 'counter' }, 'hello');
   *   }
   * }
   */</span>
  <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//给类组件也增加ref</span>
    ref<span class="token punctuation">.</span>current <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentWillMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    componentInstance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span>getDerivedStateFromProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> newState <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      componentInstance<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token operator">...</span>newState <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  element<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span> <span class="token comment">// 这里也是一个预埋设计</span>
  <span class="token keyword">let</span> renderElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  componentInstance<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span> <span class="token comment">// 这里也是一个预埋设计</span>
  <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  renderElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span> <span class="token comment">// 此处需要进行一次挂载,便于配合生命周期</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentDidMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    componentInstance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
  <span class="token comment">// `element.dom = dom;`，可以推导出: element.componentInstance.renderElement.dom=真实DOM</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
let element = React.createElement('button',
  { id: 'sayHello', onClick },
  'say', React.createElement('span', { onClick: spanClick, style: { color: 'red' } }, 'Hello')
);
 */</span>
<span class="token keyword">function</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span> <span class="token comment">// div button span</span>
  <span class="token keyword">let</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//真实DOM对象</span>
  <span class="token comment">//1，创建虚拟dom的子节点</span>
  <span class="token function">createNativeDOMChildren</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//2，给DOM元素添加属性</span>
  <span class="token function">setProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ref<span class="token punctuation">.</span>current <span class="token operator">=</span> dom<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createNativeDOMChildren</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> childrenNodeArr <span class="token operator">=</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span><span class="token comment">//已经在React.createElement中打平</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenNodeArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenNodeArr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> child <span class="token operator">=</span> childrenNodeArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//child会传递给element，预埋设计，跟`element.dom = dom;`逻辑一样，给element添加索引</span>
      child<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token keyword">let</span> childDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
      parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> element<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/26/2020, 11:29:48 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe-blog/frame/react15/source/dom-diff.html" class="prev">dom-diff</a></span> <span class="next"><a href="/fe-blog/frame/react15/source/context.html">context和批量更新</a>→
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/fe-blog/assets/js/app.8a3559bf.js" defer></script><script src="/fe-blog/assets/js/2.fbf19223.js" defer></script><script src="/fe-blog/assets/js/34.2eb22cbc.js" defer></script>
  </body>
</html>
