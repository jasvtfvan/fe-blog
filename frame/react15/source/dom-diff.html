<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>dom-diff | jasvtfvan前端博客</title>
    <meta name="description" content="欢迎来到我的前端工厂">
    <link rel="icon" href="/fe-blog/github.ico">
    
    <link rel="preload" href="/fe-blog/assets/css/0.styles.68cfcd3e.css" as="style"><link rel="preload" href="/fe-blog/assets/js/app.8a3559bf.js" as="script"><link rel="preload" href="/fe-blog/assets/js/2.fbf19223.js" as="script"><link rel="preload" href="/fe-blog/assets/js/6.60bc9110.js" as="script"><link rel="prefetch" href="/fe-blog/assets/js/10.399f0c01.js"><link rel="prefetch" href="/fe-blog/assets/js/11.08202412.js"><link rel="prefetch" href="/fe-blog/assets/js/12.cfc10ac9.js"><link rel="prefetch" href="/fe-blog/assets/js/13.bdceb3a3.js"><link rel="prefetch" href="/fe-blog/assets/js/14.0c886dba.js"><link rel="prefetch" href="/fe-blog/assets/js/15.f5d42d2e.js"><link rel="prefetch" href="/fe-blog/assets/js/16.19c927b2.js"><link rel="prefetch" href="/fe-blog/assets/js/17.cc368339.js"><link rel="prefetch" href="/fe-blog/assets/js/18.99786a0e.js"><link rel="prefetch" href="/fe-blog/assets/js/19.2c96aa8f.js"><link rel="prefetch" href="/fe-blog/assets/js/20.feb358f9.js"><link rel="prefetch" href="/fe-blog/assets/js/21.854b8672.js"><link rel="prefetch" href="/fe-blog/assets/js/22.78adf0af.js"><link rel="prefetch" href="/fe-blog/assets/js/23.a8c123d2.js"><link rel="prefetch" href="/fe-blog/assets/js/24.65de2737.js"><link rel="prefetch" href="/fe-blog/assets/js/25.21f6581b.js"><link rel="prefetch" href="/fe-blog/assets/js/26.19b2e629.js"><link rel="prefetch" href="/fe-blog/assets/js/27.b0579100.js"><link rel="prefetch" href="/fe-blog/assets/js/28.a0c1bad8.js"><link rel="prefetch" href="/fe-blog/assets/js/29.3869f6fd.js"><link rel="prefetch" href="/fe-blog/assets/js/3.a5dd7d81.js"><link rel="prefetch" href="/fe-blog/assets/js/30.be6becb7.js"><link rel="prefetch" href="/fe-blog/assets/js/31.e027926c.js"><link rel="prefetch" href="/fe-blog/assets/js/32.dd112bea.js"><link rel="prefetch" href="/fe-blog/assets/js/33.2cdeb0bd.js"><link rel="prefetch" href="/fe-blog/assets/js/34.2eb22cbc.js"><link rel="prefetch" href="/fe-blog/assets/js/35.a1660bb3.js"><link rel="prefetch" href="/fe-blog/assets/js/36.3d49d679.js"><link rel="prefetch" href="/fe-blog/assets/js/37.2c728d3e.js"><link rel="prefetch" href="/fe-blog/assets/js/38.5b00cff3.js"><link rel="prefetch" href="/fe-blog/assets/js/39.bc2ccb29.js"><link rel="prefetch" href="/fe-blog/assets/js/4.54c72001.js"><link rel="prefetch" href="/fe-blog/assets/js/40.fe52d14c.js"><link rel="prefetch" href="/fe-blog/assets/js/41.da19c7de.js"><link rel="prefetch" href="/fe-blog/assets/js/42.82780c8a.js"><link rel="prefetch" href="/fe-blog/assets/js/43.ea864644.js"><link rel="prefetch" href="/fe-blog/assets/js/44.683e33ca.js"><link rel="prefetch" href="/fe-blog/assets/js/45.6ebdb1c6.js"><link rel="prefetch" href="/fe-blog/assets/js/46.d152d9d1.js"><link rel="prefetch" href="/fe-blog/assets/js/5.7519b52c.js"><link rel="prefetch" href="/fe-blog/assets/js/7.583a8196.js"><link rel="prefetch" href="/fe-blog/assets/js/8.b04d2cae.js"><link rel="prefetch" href="/fe-blog/assets/js/9.f4b536f6.js">
    <link rel="stylesheet" href="/fe-blog/assets/css/0.styles.68cfcd3e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fe-blog/" class="home-link router-link-active"><!----> <span class="site-name">jasvtfvan前端博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fe-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">微信平台</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>公众号</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/wechat/serviceaccount/local-debug.html" class="nav-link">本地调试</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/regexp/" class="nav-link">正则表达式</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/highlights/" class="nav-link">基础集锦</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/promise/" class="nav-link">promise</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">主流框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/source/observer.html" class="nav-link">框架源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/application/base.html" class="nav-link">框架应用</a></li></ul></li><li class="dropdown-item"><h4>react</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/react15/source/native.html" class="nav-link">react15源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/react16/source/fiber.html" class="nav-link">react16源码</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具环境</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/git/" class="nav-link">git/git-flow</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/node/" class="nav-link">node工具</a></li></ul></li><li class="dropdown-item"><h4>系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/mnt.html" class="nav-link">centOS</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/cmd.html" class="nav-link">linux常用命令</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/mac/switch-hosts.html" class="nav-link">mac技巧</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/normal/" class="nav-link">常规部署</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd/" class="nav-link">CI/CD</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/gitlab/" class="nav-link">gitlab搭建</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/docker/" class="nav-link">docker常用容器</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="nav-link">CI/CD综合</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fe-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">微信平台</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>公众号</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/wechat/serviceaccount/local-debug.html" class="nav-link">本地调试</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/regexp/" class="nav-link">正则表达式</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/highlights/" class="nav-link">基础集锦</a></li><li class="dropdown-item"><!----> <a href="/fe-blog/javascript/promise/" class="nav-link">promise</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">主流框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/source/observer.html" class="nav-link">框架源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/vue2/application/base.html" class="nav-link">框架应用</a></li></ul></li><li class="dropdown-item"><h4>react</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/frame/react15/source/native.html" class="nav-link">react15源码</a></li><li class="dropdown-subitem"><a href="/fe-blog/frame/react16/source/fiber.html" class="nav-link">react16源码</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">工具环境</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/git/" class="nav-link">git/git-flow</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/tools/node/" class="nav-link">node工具</a></li></ul></li><li class="dropdown-item"><h4>系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/mnt.html" class="nav-link">centOS</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/centos/cmd.html" class="nav-link">linux常用命令</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/os/mac/switch-hosts.html" class="nav-link">mac技巧</a></li></ul></li><li class="dropdown-item"><h4>部署</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/normal/" class="nav-link">常规部署</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd/" class="nav-link">CI/CD</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/gitlab/" class="nav-link">gitlab搭建</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/docker/" class="nav-link">docker常用容器</a></li><li class="dropdown-subitem"><a href="/fe-blog/enviroment/deploy/cicd-pro/cicd.html" class="nav-link">CI/CD综合</a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fe-blog/frame/react15/source/native.html" class="sidebar-link">渲染原生组件</a></li><li><a href="/fe-blog/frame/react15/source/class-function.html" class="sidebar-link">类组件和函数组件</a></li><li><a href="/fe-blog/frame/react15/source/set-state.html" class="sidebar-link">组件更新</a></li><li><a href="/fe-blog/frame/react15/source/dom-diff.html" class="active sidebar-link">dom-diff</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_1-整体策略" class="sidebar-link">1. 整体策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_1-1-递归算法" class="sidebar-link">1.1. 递归算法</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_1-2-比对算法" class="sidebar-link">1.2. 比对算法</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_1-3-移动和剔除" class="sidebar-link">1.3. 移动和剔除</a></li></ul></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_2-递归更新属性" class="sidebar-link">2. 递归更新属性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_2-1-src-index-js" class="sidebar-link">2.1. src/index.js</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_2-2-src-react-vdom-js" class="sidebar-link">2.2. src/react/vdom.js</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_2-3-src-react-index-js" class="sidebar-link">2.3. src/react/index.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_3-递归更新元素" class="sidebar-link">3. 递归更新元素</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_3-1-src-index-js" class="sidebar-link">3.1. src/index.js</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_3-2-src-react-constant-js" class="sidebar-link">3.2. src/react/constant.js</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_3-3-src-react-vdom-js" class="sidebar-link">3.3. src/react/vdom.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_4-番外篇dom-diff" class="sidebar-link">4. 番外篇DOM-DIFF</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_4-1-tree-diff" class="sidebar-link">4.1. Tree DIFF</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_4-2-component-diff" class="sidebar-link">4.2. Component DIFF</a></li><li class="sidebar-sub-header"><a href="/fe-blog/frame/react15/source/dom-diff.html#_4-3-element-diff" class="sidebar-link">4.3. Element DIFF</a></li></ul></li></ul></li><li><a href="/fe-blog/frame/react15/source/life-cycle.html" class="sidebar-link">生命周期</a></li><li><a href="/fe-blog/frame/react15/source/context.html" class="sidebar-link">context和批量更新</a></li><li><a href="/fe-blog/frame/react15/source/react15.html" class="sidebar-link">react15核心总揽</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="dom-diff"><a href="#dom-diff" aria-hidden="true" class="header-anchor">#</a> dom-diff</h1> <h2 id="_1-整体策略"><a href="#_1-整体策略" aria-hidden="true" class="header-anchor">#</a> 1. 整体策略</h2> <h3 id="_1-1-递归算法"><a href="#_1-1-递归算法" aria-hidden="true" class="header-anchor">#</a> 1.1. 递归算法</h3> <ul><li>深度优先遍历:<br></li></ul> <blockquote><p>先序 —&gt; 父节点,左子树,右子树<br>
中序 —&gt; 左子树,父节点,右子树<br>
后序 -&gt; 左子树,右子树,父节点<br></p></blockquote> <ul><li><strong>注意：</strong><br> <strong><code>先序、中序、后序</code>指的是<code>操作</code>节点时，因为检索一般都是从<code>根</code>开始的，而对节点进行操作时，才是<code>先序、中序、后序</code>的意义所在。</strong></li> <li>多叉树递归，深度优先遍历</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> tree <span class="token operator">=</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">:</span> <span class="token string">'A'</span><span class="token punctuation">,</span>children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>node<span class="token punctuation">:</span> <span class="token string">'B'</span><span class="token punctuation">,</span>children<span class="token punctuation">:</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>node<span class="token punctuation">:</span> <span class="token string">'E'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>node<span class="token punctuation">:</span> <span class="token string">'F'</span><span class="token punctuation">,</span>children<span class="token punctuation">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>node<span class="token punctuation">:</span> <span class="token string">'J'</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>node<span class="token punctuation">:</span> <span class="token string">'C'</span><span class="token punctuation">,</span>children<span class="token punctuation">:</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>node<span class="token punctuation">:</span> <span class="token string">'G'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>node<span class="token punctuation">:</span> <span class="token string">'H'</span><span class="token punctuation">,</span>children<span class="token punctuation">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>node<span class="token punctuation">:</span> <span class="token string">'K'</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>node<span class="token punctuation">:</span> <span class="token string">'D'</span><span class="token punctuation">,</span>children<span class="token punctuation">:</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>node<span class="token punctuation">:</span> <span class="token string">'I'</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token parameter">tree</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> children <span class="token operator">=</span> tree<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">search</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">search</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//A B E F J C G H K D I</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><ul><li>二叉树与多叉树:
<img src="/fe-blog/assets/img/DFS-compare.603de6a4.png" alt="./images/DFS-compare.png">
图中的 1,2,3,...,10,11 代表了递归检索的顺序，并使用了<code>先序</code>遍历</li></ul> <blockquote><p>当分析到<code>源码</code>的递归思路时，可能会感到困惑，到底是<code>二叉树</code>，还是<code>多叉树</code>.<br>
结论是<code>多叉树</code>，虽然比较函数传递了<code>老节点</code>和<code>新节点</code>，但是分别对<code>老节点</code>和<code>新节点</code>进行了递归.<br>
并且把<strong>每一层</strong><code>老节点</code>和<code>新节点</code><strong>同时递归</strong>，确保他们递归到的是<strong>同一层</strong>.</p></blockquote> <ul><li>老节点 &lt;==&gt; 新节点<br>
图中<code>O...</code>(old)代表老节点，<code>N...</code>(new)代表新节点<br>
图中假设了<code>OA</code>和<code>NA</code>类型相同，<code>OC</code>和<code>NC</code>类型相同
<img src="/fe-blog/assets/img/DFS-react.b1de199b.png" alt="./images/DFS-react.png"></li></ul> <hr> <p>*** <strong>结论：</strong></p> <ul><li>dom-diff是<code>多叉树深度遍历</code>，但不是简单的单颗树遍历.</li> <li>dom-diff深度遍历规则是，如果类型相同，老节点遍历到<code>第n层</code>，新节点也一定同时遍历到<code>第n层</code>.</li> <li>dom-diff采用的深度优先遍历，属于先序遍历.<br>
后边能看到，先更新父类props，再递归更新children，这里就是<code>先序操作</code>。如果先更新children，再更新父类props，则变成了<code>后序操作</code>。本文用到的是<code>先序</code>，当然可以改变成<code>后序操作</code>，不影响结果.</li></ul> <hr> <h3 id="_1-2-比对算法"><a href="#_1-2-比对算法" aria-hidden="true" class="header-anchor">#</a> 1.2. 比对算法</h3> <p><strong>老元素的dom属性是挂载在html上的，因此真正执行 不动、插入、删除 的操作实际是针对老元素数组.</strong><br> <strong>新元素是最新状态，排序顺序由新元素决定，迭代新元素数组时，当某一新元素和某一老元素相等时，对于老元素前边未比对到的，只存在2种情况，1继续迭代新元素数组，能找到相同的则标记为移动，2迭代完毕新元素数组，没找到相同的则标记为删除.</strong><br> <em>（王麻子在山寨里排行老八，由于给山寨做了贡献，提升为二当家，老五在战斗中去世了。开饭时，大当家还坐第一把椅子，王麻子还坐以前的椅子，而原来的老二到老七，默默地将椅子搬到王麻子的后边，老五的椅子被拿走了）</em></p> <hr> <ul><li><strong>一，新老map赋值</strong> <img src="/fe-blog/assets/img/dom-diff-1.2858ebe2.png" alt="./images/dom-diff-1.png"></li></ul> <ol><li>上方是老数组，下方是新数组，字母代表key值.<br></li> <li>递归老数组，利用<code>key</code>和<code>element</code>映射成<code>map</code> (element上的dom属性指向真实DOM).<br></li> <li>递归新数组，找到相同<code>key</code>和<code>type</code>相同的<code>element</code>，赋值给新数组对应对象，最终返回新<code>map</code>.</li></ol> <ul><li><strong>二，标记元素：不动、插入、删除</strong></li> <li>迭代新数组，并根据上一步的赋值，可判断相等的节点</li> <li>老元素默认_mountIndex === 老元素索引</li> <li>公式: <code>lastIndex = max(老元素_mountIndex，lastIndex)</code></li> <li>公式: <code>新元素_mountIndex</code> = 新索引</li> <li>图中蓝色手写数字，表示步骤
<img src="/fe-blog/assets/img/dom-diff-2.8a1d12b7.png" alt="./images/dom-diff-2.png"></li></ul> <ol><li>新A === 老A，不小于lastIndex不动.</li> <li>新E === 老E，不小于lastIndex不动，lastIndex = 4，老元素_mountIndex = 1.</li> <li>插入新G，插入位置为2.</li> <li>新C === 老C，老元素_mountIndex 2&lt;lastIndex 4，从2移动到3，老元素_mountIndex = 3.</li> <li>插入新H，插入位置为4.</li> <li>插入新I，插入位置为5.</li> <li>新D === 老D，老元素_mountIndex 3&lt;lastIndex 4，从3移动到6，老元素_mountIndex = 6.</li> <li>插入新J，插入位置为7.</li> <li>新数组中不存在，删除老元素索引1.</li> <li>新数组中不存在，删除老元素索引5.</li></ol> <ul><li><strong>三，标记完毕后的队列</strong> <img src="/fe-blog/assets/img/dom-diff-3.d649a43e.png" alt="./images/dom-diff-3.png">
根据标记后的队列，进行实际的dom操作</li></ul> <blockquote><p>insert =&gt; 插入、move =&gt; 移动、remove =&gt; 删除<br>
toIndex =&gt; 插入或移动 目标索引<br>
fromIndex =&gt; 移动或删除 哪个索引的元素</p></blockquote> <h3 id="_1-3-移动和剔除"><a href="#_1-3-移动和剔除" aria-hidden="true" class="header-anchor">#</a> 1.3. 移动和剔除</h3> <ul><li><code>dom-diff</code>利用<code>diffQueue</code>进行整体移动和剔除，将<code>parentNode、操作方式(移动/剔除)、索引、dom</code>等信息，作为对象放入<code>diffQueue</code>.</li> <li>每次<code>diff</code>递归到一层，全局变量<code>updateDepth++</code>，由于深度优先遍历，只要还有叶子层，就会继续递归，<code>updateDepth</code>会继续<code>++</code>，当没有叶子层时就会执行这一层<code>diff</code>，每执行完一层，<code>updateDepth--</code>，返回父类一层。<br>
当执行到最末端叶子层，此时<code>updateDepth</code>最大，当所有层执行完毕，<code>updateDepth</code>还原为0，此时循环触发<code>diffQueue</code>中的操作</li> <li>由于<code>深度优先</code>，最末端的叶子操作，在<code>diffQueue</code>中的位置，总是比叶子所属的父节点靠前，这样保证了总是先执行叶子层操作，再执行该叶子层对应的父节点层操作，就不会出现“<code>先删除了父节点，叶子节点操作时报错</code>”</li></ul> <h2 id="_2-递归更新属性"><a href="#_2-递归更新属性" aria-hidden="true" class="header-anchor">#</a> 2. 递归更新属性</h2> <ul><li><strong>在解读源代码实现时，对照<code>1.整体策略</code>的分析便于理解</strong></li></ul> <h3 id="_2-1-src-index-js"><a href="#_2-1-src-index-js" aria-hidden="true" class="header-anchor">#</a> 2.1. src/index.js</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'./react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> number<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> number<span class="token punctuation">:</span> state<span class="token punctuation">.</span>number <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'counter'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">+</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>Counter <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="_2-2-src-react-vdom-js"><a href="#_2-2-src-react-vdom-js" aria-hidden="true" class="header-anchor">#</a> 2.2. src/react/vdom.js</h3> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span> onlyOne<span class="token punctuation">,</span> flatten<span class="token punctuation">,</span> patchProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span><span class="token parameter">oldRenderElement<span class="token punctuation">,</span> newRenderElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  oldRenderElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newRenderElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> oldRenderElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span><span class="token comment">//取出老的DOM节点（此处，element.dom = dom;已经做过预埋设计）</span>
  <span class="token keyword">let</span> currentElement <span class="token operator">=</span> oldRenderElement<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newRenderElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//新的虚拟DOM为null，删掉老节点</span>
    currentDOM <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">.</span>type <span class="token operator">!=</span> newRenderElement<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// span div function class</span>
    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//类型不同，新节点替换老节点</span>
    currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newDOM<span class="token punctuation">,</span> currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentElement <span class="token operator">=</span> newRenderElement<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//新老节点都存在，类型一样。进行 dom-diff 深度比较，比较他们的属性和子节点，并尽可能复用老节点</span>
    <span class="token function">updateElement</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> currentElement<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// *** 如果是`函数组件`或`类组件`,`oldElement`就是`oldRenderElement`</span>
<span class="token comment">// renderElement 是函数组件执行后 或 类组件调用render后返回的虚拟DOM，虚拟DOM是由React.createElement创建的</span>
<span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * !!!给 src/react/index.js 做比对，如果是字符串或者数字，仍需要获取dom，并根据dom内容更新
   */</span>
  <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> newElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span> <span class="token operator">&amp;&amp;</span> newElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>content <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentDOM<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// div span p</span>
    <span class="token comment">//先更新父节点的属性，再比较更新子节点（返回来也可以）</span>
    <span class="token function">updateDOMProperties</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//把newElement.props赋给oldElement.props，不仅要更新dom上的attribute，还是要同步props</span>
    oldElement<span class="token punctuation">.</span>props <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 函数组件</span>
    <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 类组件</span>
    <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">diff</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldChildrenElementsMap <span class="token operator">=</span> <span class="token function">getChildrenElementsMap</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> newChildrenElementsMap <span class="token operator">=</span> <span class="token function">getNewChildrenElementsMap</span><span class="token punctuation">(</span>oldChildrenElementsMap<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getNewChildrenElementsMap</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElementsMap<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newChildElement <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> newKey <span class="token operator">=</span> newChildElement<span class="token punctuation">.</span>key <span class="token operator">||</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// key一样，类型一样</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canDeepCompare</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">updateElement</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新属性后，递归更新子节点</span>
        newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildElement<span class="token punctuation">;</span><span class="token comment">//复用老的虚拟DOM，老的虚拟DOM的dom属性，指向真实DOM</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//新数组上的每个element都映射到map，其中包含了跟oldChildElement相等的元素</span>
      map<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span> <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//是否可以深度递归比较</span>
<span class="token keyword">function</span> <span class="token function">canDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">oldChildElement<span class="token punctuation">,</span> newChildElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>oldChildElement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>newChildElement<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> oldChildElement<span class="token punctuation">.</span>type <span class="token operator">===</span> newChildElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取老map</span>
<span class="token keyword">function</span> <span class="token function">getChildrenElementsMap</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldKey <span class="token operator">=</span> oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">||</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">updateDOMProperties</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">patchProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//类组件element.componentInstance.renderElement.dom=真实DOM</span>
<span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span>
  <span class="token keyword">let</span> updater <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span>$updater<span class="token punctuation">;</span>
  <span class="token keyword">let</span> nextProps <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  updater<span class="token punctuation">.</span><span class="token function">emitUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//函数组件element.renderElement.dom=真实DOM</span>
<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldRenderElement <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>renderElement<span class="token punctuation">;</span>
  <span class="token keyword">let</span> newRenderElement <span class="token operator">=</span> newElement<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newElement<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> currentDOM<span class="token punctuation">;</span><span class="token comment">//更新之后，重新挂载</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Uncaught DOMException: Failed to execute 'createElement' on 'Document': The tag name provided ('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">') is not a valid name.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * !!! element 如果是字符串或者数字，修改成在 createElement时，封装成对象
   */</span>
  <span class="token keyword">let</span> dom<span class="token punctuation">;</span>
  element <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果是数组，只取第一个</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span> <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 字符串或者数字</span>
    dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 原生DOM节点</span>
    dom <span class="token operator">=</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 函数组件</span>
    dom <span class="token operator">=</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 类组件</span>
    dom <span class="token operator">=</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * `element`是ReactElement创建出来的虚拟DOM，让虚拟的DOM的`dom`属性指向真实DOM
   * 这里是一个预埋设计，或者叫铺垫，通过虚拟DOM能够获取真实DOM
   */</span>
  element<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 创建函数组件真实的DOM对象</span>
<span class="token keyword">function</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//element: $$typeof, type, key, ref, props</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token comment">/**
   * function FunctionComponent(props) {
   *   return React.createElement('div', { id: 'counter' }, 'hello');
   * }
   */</span>
  <span class="token keyword">let</span> renderElement <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// type === FunctionComponent</span>
  <span class="token comment">//element 是 React.createElement(FunctionComponent, config, children); 的返回值</span>
  <span class="token comment">//element 是 FunctionComponent 的父级，当然这里不是DOM的父级，只是理解为父级</span>
  element<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span> <span class="token comment">// 这里也是一个预埋设计</span>
  <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
  <span class="token comment">// `element.dom = dom;`，可以推导出: element.renderElement.dom=真实DOM</span>
<span class="token punctuation">}</span>
<span class="token comment">// 创建类组件真实的DOM对象</span>
<span class="token keyword">function</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token comment">/**
   * class ClassCounter extends React.Component {
   *   constructor(props) {
   *     super(props);
   *   }
   *   render() {
   *     return React.createElement('div', { id: 'counter' }, 'hello');
   *   }
   * }
   */</span>
  <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  element<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span> <span class="token comment">// 这里也是一个预埋设计</span>
  <span class="token keyword">let</span> renderElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  componentInstance<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span> <span class="token comment">// 这里也是一个预埋设计</span>
  <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
  <span class="token comment">// `element.dom = dom;`，可以推导出: element.componentInstance.renderElement.dom=真实DOM</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
let element = React.createElement('button',
  { id: 'sayHello', onClick },
  'say', React.createElement('span', { onClick: spanClick, style: { color: 'red' } }, 'Hello')
);
 */</span>
<span class="token keyword">function</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span> <span class="token comment">// div button span</span>
  <span class="token keyword">let</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//真实DOM对象</span>
  <span class="token comment">//1，创建虚拟dom的子节点</span>
  <span class="token function">createNativeDOMChildren</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//2，给DOM元素添加属性</span>
  <span class="token function">setProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createNativeDOMChildren</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> childrenNodeArr <span class="token operator">=</span> children <span class="token operator">&amp;&amp;</span> <span class="token function">flatten</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenNodeArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenNodeArr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> child <span class="token operator">=</span> childrenNodeArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//child会传递给element，预埋设计，跟`element.dom = dom;`逻辑一样，给element添加索引</span>
      child<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token keyword">let</span> childDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
      parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> element<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br></div></div><h3 id="_2-3-src-react-index-js"><a href="#_2-3-src-react-index-js" aria-hidden="true" class="header-anchor">#</a> 2.3. src/react/index.js</h3> <p>叶子节点为字符串或数字时，需要包装成对象，这样才能指向dom节点，并根据dom更新内容<br>
经过这样的改造后，element的输出结构，将跟官方有区别，（跟<code>渲染原生组件</code>中的官方结构不再相同）</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ReactElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./vdom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./component'</span><span class="token punctuation">;</span>

<span class="token comment">//利用数组 rest，方便children直接拿到数组</span>
<span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__source<span class="token punctuation">;</span><span class="token comment">//dev环境下变量，不考虑该变量</span>
  <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__self<span class="token punctuation">;</span><span class="token comment">//dev环境下变量，不考虑该变量</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>
  <span class="token keyword">let</span> $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//span div button</span>
    $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">ELEMENT</span><span class="token punctuation">;</span><span class="token comment">//是一个原生的DOM类型</span>
    <span class="token comment">/**
     * 这里要注意，用真实React在测试时，你会发现：
     * let e1 = React.createElement('abc');
     * console.log(e1); // $$typeof 仍然是 react.element类型，type: 'abc'
     */</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Warning: React.createElement: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">typeof</span> type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * !!! 叶子节点为字符串或数字时，需要包装成对象，这样才能指向dom节点，并根据dom更新内容
   * 见 src/react/vdom.js updateElement方法
   * 经过这样的改造后，element的输出结构，将跟官方有区别
   */</span>
  props<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span>
    <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">?</span> item <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> item <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span>$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  Component
<span class="token punctuation">}</span>
<span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span>
  createElement<span class="token punctuation">,</span>
  Component
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h2 id="_3-递归更新元素"><a href="#_3-递归更新元素" aria-hidden="true" class="header-anchor">#</a> 3. 递归更新元素</h2> <h3 id="_3-1-src-index-js"><a href="#_3-1-src-index-js" aria-hidden="true" class="header-anchor">#</a> 3.1. src/index.js</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'./react-dom'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> show<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> show<span class="token punctuation">:</span> <span class="token operator">!</span>state<span class="token punctuation">.</span>show <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>show<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>ul onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span><span class="token operator">&gt;</span><span class="token constant">B</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span><span class="token operator">&gt;</span><span class="token constant">C</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;D&quot;</span><span class="token operator">&gt;</span><span class="token constant">D</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>ul onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span><span class="token operator">&gt;</span><span class="token constant">C</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span><span class="token operator">&gt;</span><span class="token constant">B</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;E&quot;</span><span class="token operator">&gt;</span><span class="token constant">E</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;F&quot;</span><span class="token operator">&gt;</span><span class="token constant">F</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>Counter <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="_3-2-src-react-constant-js"><a href="#_3-2-src-react-constant-js" aria-hidden="true" class="header-anchor">#</a> 3.2. src/react/constant.js</h3> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br></div><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">TEXT</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'TEXT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">ELEMENT</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'ELEMENT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">FUNCTION_COMPONENT</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'FUNCTION_COMPONENT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//函数数件</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">CLASS_COMPONENT</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">'CLASS_COMPONENT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//类组件</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">MOVE</span> <span class="token operator">=</span> <span class="token string">'MOVE'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">REMOVE</span> <span class="token operator">=</span> <span class="token string">'REMOVE'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">INSERT</span> <span class="token operator">=</span> <span class="token string">'INSERT'</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_3-3-src-react-vdom-js"><a href="#_3-3-src-react-vdom-js" aria-hidden="true" class="header-anchor">#</a> 3.3. src/react/vdom.js</h3> <div class="language-js line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span> <span class="token constant">INSERT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span> onlyOne<span class="token punctuation">,</span> flatten<span class="token punctuation">,</span> patchProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> updateDepth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//递归深度</span>
<span class="token keyword">let</span> diffQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//补丁包，比较移动、添加、删除的节点</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span><span class="token parameter">oldRenderElement<span class="token punctuation">,</span> newRenderElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  oldRenderElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newRenderElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> oldRenderElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span><span class="token comment">//取出老的DOM节点（此处，element.dom = dom;已经做过预埋设计）</span>
  <span class="token keyword">let</span> currentElement <span class="token operator">=</span> oldRenderElement<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newRenderElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//新的虚拟DOM为null，删掉老节点</span>
    currentDOM <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">.</span>type <span class="token operator">!=</span> newRenderElement<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// span div function class</span>
    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//类型不同，新节点替换老节点</span>
    currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newDOM<span class="token punctuation">,</span> currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentElement <span class="token operator">=</span> newRenderElement<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//新老节点都存在，类型一样。进行 dom-diff 深度比较，比较他们的属性和子节点，并尽可能复用老节点</span>
    <span class="token function">updateElement</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> currentElement<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// *** 如果是`函数组件`或`类组件`,`oldElement`就是`oldRenderElement`</span>
<span class="token comment">// renderElement 是函数组件执行后 或 类组件调用render后返回的虚拟DOM，虚拟DOM是由React.createElement创建的</span>
<span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * !!!给 src/react/index.js 做比对，如果是字符串或者数字，仍需要获取dom，并根据dom内容更新
   */</span>
  <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> newElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span> <span class="token operator">&amp;&amp;</span> newElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>content <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentDOM<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// div span p</span>
    <span class="token comment">//先更新父节点的属性，再比较更新子节点（返回来也可以）</span>
    <span class="token function">updateDOMProperties</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//把newElement.props赋给oldElement.props，不仅要更新dom上的attribute，还是要同步props</span>
    oldElement<span class="token punctuation">.</span>props <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 函数组件</span>
    <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 类组件</span>
    <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  updateDepth<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//每递归新一层，updateDepth++</span>
  <span class="token function">diff</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  updateDepth<span class="token operator">--</span><span class="token punctuation">;</span><span class="token comment">//每diff完一层，返回上一级，updateDepth--</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>updateDepth <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//当updateDepth为0，说明到了最上层，执行补丁包</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行补丁</span>
    diffQueue<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//注意 MOVE 的逻辑：删除原节点，再插入到新的位置，因此需要缓存老DOM</span>
<span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">diffQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> deleteMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//缓存老的dom</span>
  <span class="token keyword">let</span> deleteChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//要删除的子节点</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> fromIndex<span class="token punctuation">,</span> toIndex <span class="token punctuation">}</span> <span class="token operator">=</span> difference<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token constant">REMOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//移动或删除</span>
      <span class="token keyword">let</span> oldChildDOM <span class="token operator">=</span> difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//老的DOM节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//移动则缓存</span>
        deleteMap<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildDOM<span class="token punctuation">;</span><span class="token comment">//缓存老的DOM，方便复用</span>
      <span class="token punctuation">}</span>
      deleteChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldChildDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//把移动和删除的节点，执行删除操作。因为移动的真实DOM已经缓存，所以还可以拿到</span>
  deleteChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">childDOM</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    childDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//diff函数处理完毕后</span>
    <span class="token comment">//MOVE具有fromIndex,toIndex</span>
    <span class="token comment">//INSERT具有toIndex,dom</span>
    <span class="token comment">//REMOVE具有fromIndex</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> fromIndex<span class="token punctuation">,</span> toIndex<span class="token punctuation">,</span> parentNode<span class="token punctuation">,</span> dom <span class="token punctuation">}</span> <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">INSERT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertChildAt</span><span class="token punctuation">(</span>parentNode<span class="token punctuation">,</span> dom<span class="token punctuation">,</span> toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">insertChildAt</span><span class="token punctuation">(</span>parentNode<span class="token punctuation">,</span> deleteMap<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//释放资源</span>
  deleteMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  deleteChildren<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//向index索引位置插入元素</span>
<span class="token keyword">function</span> <span class="token function">insertChildAt</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> newChildDOM<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldChild <span class="token operator">=</span> parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//拿到老的节点</span>
  oldChild <span class="token operator">?</span> parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newChildDOM<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span> <span class="token punctuation">:</span> parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>newChildDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldChildrenElementsMap <span class="token operator">=</span> <span class="token function">getChildrenElementsMap</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> newChildrenElementsMap <span class="token operator">=</span> <span class="token function">getNewChildrenElementsMap</span><span class="token punctuation">(</span>oldChildrenElementsMap<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">//由于深度优先，所有子节点在diffQueue中的位置，比父节点位置靠前</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newChildElement <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> newKey <span class="token operator">=</span> newChildElement<span class="token punctuation">.</span>key <span class="token operator">||</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement <span class="token operator">===</span> oldChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//同一个对象，在构建newChildrenElementsMap时确定</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            parentNode<span class="token punctuation">,</span><span class="token comment">//记录父节点</span>
            type<span class="token punctuation">:</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span>
            fromIndex<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>
            toIndex<span class="token punctuation">:</span> i
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//如果类型不相等，插入新元素（后边该key对应的老元素将被迭代，并会标记为删除）</span>
        diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          parentNode<span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span>
          toIndex<span class="token punctuation">:</span> i<span class="token punctuation">,</span>
          dom<span class="token punctuation">:</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      newChildElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span><span class="token comment">//新的节点，下次更新时，将变成老节点，需要_mountIndex</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//迭代老节点，如果新节点map中不包含老key，或者key相同type不同，则将老节点标记为删除</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> oldKey <span class="token keyword">in</span> oldChildrenElementsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementsMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildrenElementsMap<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>oldKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//新老key相同</span>
      <span class="token keyword">let</span> newChildElement <span class="token operator">=</span> newChildrenElementsMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//如果key相同，type相同，在getNewChildrenElementsMap方法中，就确保了newChildElement === oldChildElement</span>
      <span class="token comment">//当然，也可以使用canDeepCompare判断</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildElement <span class="token operator">!==</span> newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//type不同</span>
        diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          parentNode<span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span>
          fromIndex<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>_mountIndex
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//新map不包含老key，标记老元素删除</span>
      diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        parentNode<span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span>
        fromIndex<span class="token punctuation">:</span> oldChildElement<span class="token punctuation">.</span>_mountIndex
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getNewChildrenElementsMap</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElementsMap<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newChildElement <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> newKey <span class="token operator">=</span> newChildElement<span class="token punctuation">.</span>key <span class="token operator">||</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// key一样，类型一样</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canDeepCompare</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">updateElement</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新属性后，递归更新子节点</span>
        newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildElement<span class="token punctuation">;</span><span class="token comment">//复用老的虚拟DOM，老的虚拟DOM的dom属性，指向真实DOM</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//新数组上的每个element都映射到map，其中包含了跟oldChildElement相等的元素</span>
      map<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span> <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//是否可以深度递归比较</span>
<span class="token keyword">function</span> <span class="token function">canDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">oldChildElement<span class="token punctuation">,</span> newChildElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>oldChildElement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> oldChildElement<span class="token punctuation">.</span>type <span class="token operator">===</span> newChildElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取老map</span>
<span class="token keyword">function</span> <span class="token function">getChildrenElementsMap</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldKey <span class="token operator">=</span> oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">||</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">updateDOMProperties</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">patchProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//类组件element.componentInstance.renderElement.dom=真实DOM</span>
<span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span>
  <span class="token keyword">let</span> updater <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span>$updater<span class="token punctuation">;</span>
  <span class="token keyword">let</span> nextProps <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  updater<span class="token punctuation">.</span><span class="token function">emitUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//函数组件element.renderElement.dom=真实DOM</span>
<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> oldRenderElement <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>renderElement<span class="token punctuation">;</span>
  <span class="token keyword">let</span> newRenderElement <span class="token operator">=</span> newElement<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newElement<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> currentDOM<span class="token punctuation">;</span><span class="token comment">//更新之后，重新挂载</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Uncaught DOMException: Failed to execute 'createElement' on 'Document': The tag name provided ('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">') is not a valid name.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * !!! element 如果是字符串或者数字，修改成在 createElement时，封装成对象
   */</span>
  <span class="token keyword">let</span> dom<span class="token punctuation">;</span>
  element <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果是数组，只取第一个</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span> <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 字符串或者数字</span>
    dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 原生DOM节点</span>
    dom <span class="token operator">=</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 函数组件</span>
    dom <span class="token operator">=</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">==</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 类组件</span>
    dom <span class="token operator">=</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * `element`是ReactElement创建出来的虚拟DOM，让虚拟的DOM的`dom`属性指向真实DOM
   * 这里是一个预埋设计，或者叫铺垫，通过虚拟DOM能够获取真实DOM
   */</span>
  element<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 创建函数组件真实的DOM对象</span>
<span class="token keyword">function</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//element: $$typeof, type, key, ref, props</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token comment">/**
   * function FunctionComponent(props) {
   *   return React.createElement('div', { id: 'counter' }, 'hello');
   * }
   */</span>
  <span class="token keyword">let</span> renderElement <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// type === FunctionComponent</span>
  <span class="token comment">//element 是 React.createElement(FunctionComponent, config, children); 的返回值</span>
  <span class="token comment">//element 是 FunctionComponent 的父级，当然这里不是DOM的父级，只是理解为父级</span>
  element<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span> <span class="token comment">// 这里也是一个预埋设计</span>
  <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
  <span class="token comment">// `element.dom = dom;`，可以推导出: element.renderElement.dom=真实DOM</span>
<span class="token punctuation">}</span>
<span class="token comment">// 创建类组件真实的DOM对象</span>
<span class="token keyword">function</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token comment">/**
   * class ClassCounter extends React.Component {
   *   constructor(props) {
   *     super(props);
   *   }
   *   render() {
   *     return React.createElement('div', { id: 'counter' }, 'hello');
   *   }
   * }
   */</span>
  <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  element<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span> <span class="token comment">// 这里也是一个预埋设计</span>
  <span class="token keyword">let</span> renderElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  componentInstance<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span> <span class="token comment">// 这里也是一个预埋设计</span>
  <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
  <span class="token comment">// `element.dom = dom;`，可以推导出: element.componentInstance.renderElement.dom=真实DOM</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
let element = React.createElement('button',
  { id: 'sayHello', onClick },
  'say', React.createElement('span', { onClick: spanClick, style: { color: 'red' } }, 'Hello')
);
 */</span>
<span class="token keyword">function</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span> <span class="token comment">// div button span</span>
  <span class="token keyword">let</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//真实DOM对象</span>
  <span class="token comment">//1，创建虚拟dom的子节点</span>
  <span class="token function">createNativeDOMChildren</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//2，给DOM元素添加属性</span>
  <span class="token function">setProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createNativeDOMChildren</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> childrenNodeArr <span class="token operator">=</span> children <span class="token operator">&amp;&amp;</span> <span class="token function">flatten</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenNodeArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenNodeArr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> child <span class="token operator">=</span> childrenNodeArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//child会传递给element，预埋设计，跟`element.dom = dom;`逻辑一样，给element添加索引</span>
      child<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token keyword">let</span> childDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
      parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> element<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br></div></div><h2 id="_4-番外篇dom-diff"><a href="#_4-番外篇dom-diff" aria-hidden="true" class="header-anchor">#</a> 4. 番外篇DOM-DIFF</h2> <p><strong>番外篇出自《珠峰架构》，挪用时请注明《珠峰架构》版权</strong></p> <ul><li>DOM 节点跨层级的移动操作特别少，可以忽略不计</li> <li>拥有相同类的两个组件将会生成相似的树形结构，拥有不同类的两个组件将会生成不同的树形结构</li> <li>对于同一层级的一组子节点，它们可以通过唯一key进行区分</li> <li>DIFF算法在执行时有三个维度，分别是Tree DIFF、Component DIFF和Element DIFF，执行时按顺序依次执行，它们的差异仅仅因为DIFF粒度不同、执行先后顺序不同</li></ul> <h3 id="_4-1-tree-diff"><a href="#_4-1-tree-diff" aria-hidden="true" class="header-anchor">#</a> 4.1. Tree DIFF</h3> <ul><li>Tree DIFF是对树的每一层进行遍历，如果某组件不存在了，则会直接销毁
<img src="/fe-blog/assets/img/dom-diff-patch-1.2dbccb02.png" alt="./images/dom-diff-patch-1.png"></li> <li>当出现节点跨层级移动时，并不会出现想象中的移动操作，而是以 A 为根节点的树被整个重新创建
<img src="/fe-blog/assets/img/dom-diff-patch-2.c0e46058.png" alt="./images/dom-diff-patch-2.png"></li></ul> <h3 id="_4-2-component-diff"><a href="#_4-2-component-diff" aria-hidden="true" class="header-anchor">#</a> 4.2. Component DIFF</h3> <ul><li>如果是同一类型的组件，按照原策略继续比较</li> <li>类型不同则直接替换
<img src="/fe-blog/assets/img/dom-diff-patch-3.d2115c9c.png" alt="./images/dom-diff-patch-3.png"></li></ul> <h3 id="_4-3-element-diff"><a href="#_4-3-element-diff" aria-hidden="true" class="header-anchor">#</a> 4.3. Element DIFF</h3> <ul><li>当节点处于同一层级时，React diff 提供了三种节点操作,分别为：INSERT(插入)、MOVE(移动)和 REMOVE(删除)</li></ul> <blockquote><p>INSERT: 新的 component 类型不在老集合里， 即是全新的节点，需要对新节点执行插入操作<br>
MOVE: 在老集合有新 component 类型，就需要做更新和移动操作，可以复用以前的 DOM 节点<br>
REMOVE: 老 component 不在新集合里的，也需要执行删除操作</p></blockquote> <p><img src="/fe-blog/assets/img/dom-diff-patch-4.77a3897f.png" alt="./images/dom-diff-patch-4.png"> <img src="/fe-blog/assets/img/dom-diff-patch-5.37b973ae.png" alt="./images/dom-diff-patch-5.png"> <img src="/fe-blog/assets/img/dom-diff-patch-6.eb73de8b.png" alt="./images/dom-diff-patch-6.png"></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/26/2020, 11:29:48 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe-blog/frame/react15/source/set-state.html" class="prev">组件更新</a></span> <span class="next"><a href="/fe-blog/frame/react15/source/life-cycle.html">生命周期</a>→
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/fe-blog/assets/js/app.8a3559bf.js" defer></script><script src="/fe-blog/assets/js/2.fbf19223.js" defer></script><script src="/fe-blog/assets/js/6.60bc9110.js" defer></script>
  </body>
</html>
