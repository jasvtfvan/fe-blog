(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{228:function(s,e,a){s.exports=a.p+"assets/img/nexus1.dd7fd62e.png"},229:function(s,e,a){s.exports=a.p+"assets/img/nexus2.669ba0c6.png"},230:function(s,e,a){s.exports=a.p+"assets/img/nexus3.164b2c13.png"},231:function(s,e,a){s.exports=a.p+"assets/img/nexus4.a7cdeb12.png"},232:function(s,e,a){s.exports=a.p+"assets/img/nexus5.7e05ef41.png"},233:function(s,e,a){s.exports=a.p+"assets/img/nexus6.7e78392d.png"},234:function(s,e,a){s.exports=a.p+"assets/img/nexus7.3572e6bf.png"},235:function(s,e,a){s.exports=a.p+"assets/img/DockerAuth.0f695d73.png"},236:function(s,e,a){s.exports=a.p+"assets/img/nexus8.7c515ad2.png"},237:function(s,e,a){s.exports=a.p+"assets/img/nexus9.c58318e5.png"},238:function(s,e,a){s.exports=a.p+"assets/img/nexus10.92514dde.png"},306:function(s,e,a){"use strict";a.r(e);var t=a(0),r=Object(t.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"nexus"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nexus","aria-hidden":"true"}},[s._v("#")]),s._v(" Nexus")]),s._v(" "),t("h2",{attrs:{id:"介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#介绍","aria-hidden":"true"}},[s._v("#")]),s._v(" 介绍")]),s._v(" "),t("p",[s._v("在前面我们写到，制品库是 "),t("strong",[s._v("承接CI构建后的产出制品的仓库")]),s._v(" 。具有版本管理，历史管理，权限校验等功能。"),t("br"),s._v("\n在这里，我们选用 "),t("strong",[s._v("Nexus3")]),s._v(" 作为制品库。")]),s._v(" "),t("h2",{attrs:{id:"拉取-neuxs-镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#拉取-neuxs-镜像","aria-hidden":"true"}},[s._v("#")]),s._v(" 拉取 Neuxs 镜像")]),s._v(" "),t("p",[s._v("老规矩，先拉取nexus镜像。命令不多解释：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker pull sonatype/nexus3\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"启动-nexus-容器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动-nexus-容器","aria-hidden":"true"}},[s._v("#")]),s._v(" 启动 Nexus 容器")]),s._v(" "),t("p",[s._v("在 "),t("code",[s._v("/home")]),s._v(" 下面新建一个名为 "),t("code",[s._v("nexus")]),s._v(" 的文件夹，方便我们存放 "),t("code",[s._v("Nexus")]),s._v(" 相关数据。并赋予权限")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /home/nexus "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" /home/nexus\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("然后启动容器。")]),s._v(" "),t("div",{staticClass:"language-py line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-py"}},[t("code",[s._v("docker run "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("d "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8081")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8081")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8082")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8082")]),s._v(" \\\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("name nexus \\\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("v "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("home"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nexus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nexus"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("data \\\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("restart always \\\nsonatype"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nexus3\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("blockquote",[t("p",[s._v("Nexus 的主服务端口是8081，但 Nexus Docker 制品库还需要分配一个新的端口作为服务端口。"),t("br"),s._v("\n这里没有演示分配哪个端口，想分配自己加 -p 参数即可。在这里我使用8082作为 docker 服务端口")])]),s._v(" "),t("p",[s._v("将8081，8082端口添加到防火墙规则内：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("firewall-cmd --zone"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("public --add-port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8081")]),s._v("/tcp --permanent\nfirewall-cmd --zone"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("public --add-port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8082")]),s._v("/tcp --permanent\nsystemctl reload firewalld\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("查看防火墙生效的配置:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("firewall-cmd --list-all\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("blockquote",[t("p",[s._v("其中可以看到 "),t("code",[s._v("8081")]),s._v(" 和 "),t("code",[s._v("8082")]),s._v(" 已经加入到防火墙")])]),s._v(" "),t("h2",{attrs:{id:"访问-nexus"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#访问-nexus","aria-hidden":"true"}},[s._v("#")]),s._v(" 访问 Nexus")]),s._v(" "),t("p",[s._v("打开浏览器地址栏，访问 "),t("code",[s._v("Nexus")]),s._v(" 的服务地址。启动时间比较长，需要耐心等待。可以使用 "),t("code",[s._v("docker logs")]),s._v(" 命令查看启动日志。如果显示以下文字，代表启动成功。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker logs -f nexus\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:a(228),alt:"image"}})]),s._v(" "),t("p",[t("img",{attrs:{src:a(229),alt:"image"}})]),s._v(" "),t("h2",{attrs:{id:"配置-nexus"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置-nexus","aria-hidden":"true"}},[s._v("#")]),s._v(" 配置 Nexus")]),s._v(" "),t("p",[s._v("启动成功后，会显示上图提示文字。需要我们输入 "),t("code",[s._v("默认密码")]),s._v(" 初始化配置。可以在这里找到：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /home/nexus/admin.password\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 6cd3cb39-2479-48ca-8ca0-831342b6f29d")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("将获取到的密码输入进去，用户是 "),t("code",[s._v("admin")]),s._v(" 。")]),s._v(" "),t("p",[s._v("修改新密码后，会进入到这一步。这一步的意思是 "),t("strong",[s._v('"是否开启匿名访问"')]),s._v("。匿名访问是指："),t("strong",[s._v("我们在任何没有登录的情况下，拉取（推送）制品到制品库，都算匿名访问。")]),s._v(" 这是个很便捷，也很危险 "),t("code",[s._v("⚠️")]),s._v(" 的行为。")]),s._v(" "),t("p",[s._v("例如，这个制品库也支持 node 的 "),t("code",[s._v("NPM")]),s._v(" 私有库。那么我们在没有 "),t("code",[s._v("npm login")]),s._v(" 这个制品库之前，就可以进行 "),t("code",[s._v("npm install")]),s._v(" "),t("code",[s._v("npm publish")]),s._v(" ，其实是不太安全的。那么任何一个知道制品库地址的人，都可以任意进行推送和获取资源。")]),s._v(" "),t("p",[t("strong",[s._v("这里我们为了测试，可以先允许开启匿名访问")]),s._v("。选择 "),t("strong",[s._v("Enable")]),s._v(" "),t("strong",[s._v("anonymous")]),s._v(" "),t("strong",[s._v("access")]),s._v(" ，点击下一步。")]),s._v(" "),t("p",[t("img",{attrs:{src:a(230),alt:"image"}})]),s._v(" "),t("h2",{attrs:{id:"创建一个-docker-私服"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建一个-docker-私服","aria-hidden":"true"}},[s._v("#")]),s._v(" 创建一个 Docker 私服")]),s._v(" "),t("p",[s._v("我们使用有权限的账号登录后，点击页面头部导航栏的 齿轮 图标，选择左侧菜单中的 "),t("code",[s._v("Repositories")]),s._v(" ，点击 "),t("code",[s._v("Create repository")]),s._v(" 。")]),s._v(" "),t("p",[t("img",{attrs:{src:a(231),alt:"image"}})]),s._v(" "),t("p",[s._v("点击后，我们可以看到一个列表，这就是Nexus所支持的制品库类型。其中有我们要使用的Docker，也有熟悉的 Npm。我们在里面找到 Docker：")]),s._v(" "),t("p",[t("img",{attrs:{src:a(232),alt:"image"}})]),s._v(" "),t("p",[s._v("但是 "),t("code",[s._v("Docker")]),s._v(" 有三种，该选哪个呢？")]),s._v(" "),t("h3",{attrs:{id:"制品库的类型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#制品库的类型","aria-hidden":"true"}},[s._v("#")]),s._v(" 制品库的类型")]),s._v(" "),t("p",[s._v("在Nexus中，无论什么制品库，一般分为以下三种类型：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("proxy: 此类型制品库原则上 "),t("strong",[s._v("“只下载，不允许用户推送”")]),s._v("。可以理解为"),t("strong",[s._v("缓存外网制品的制品库")]),s._v("。例如，我们在拉取nginx镜像时，如果通过proxy类型的制品库，则它会去创建时配置好的外网docker镜像源拉取（有点像cnpm）到自己的制品库，然后给你。第二次拉取，则不会下载。起到 "),t("code",[s._v("缓存")]),s._v(" 的作用。\n"),t("br")])]),s._v(" "),t("li",[t("p",[s._v("hosted：此类型制品库和proxy相反，原则上 "),t("strong",[s._v("”只允许用户推送，不允许缓存“")]),s._v(" 。这是私有库的核心，只存放自己的私有镜像或制品。\n"),t("br")])]),s._v(" "),t("li",[t("p",[s._v("group：此类型制品库用作以上两种类型的 "),t("strong",[s._v("“集合”")]),s._v(" ，将上面两个库集合为一个使用。")])])]),s._v(" "),t("h3",{attrs:{id:"表单解释"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#表单解释","aria-hidden":"true"}},[s._v("#")]),s._v(" 表单解释")]),s._v(" "),t("p",[s._v("在这里，我们其实不需要"),t("strong",[s._v("缓存外网镜像")]),s._v("，那么我们只需要 "),t("strong",[s._v("hosted类型")]),s._v(" 即可。选择 "),t("strong",[s._v("docker(hosted)")]),s._v("。")]),s._v(" "),t("p",[s._v("我们将启动Nexus镜像时，配置好的 Docker 端口填入HTTP 内，可以先允许匿名拉取镜像。")]),s._v(" "),t("p",[t("img",{attrs:{src:a(233),alt:"image"}})]),s._v(" "),t("p",[s._v("填写完成后，点击最下方的 Create repository，保存创建。")]),s._v(" "),t("h3",{attrs:{id:"查看制品地址"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看制品地址","aria-hidden":"true"}},[s._v("#")]),s._v(" 查看制品地址")]),s._v(" "),t("p",[s._v("找到我们刚刚创建的制品，点击上面的 "),t("strong",[s._v("copy")]),s._v("，查看地址。")]),s._v(" "),t("p",[t("img",{attrs:{src:a(234),alt:"image"}})]),s._v(" "),t("h3",{attrs:{id:"配置登录docker权限"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置登录docker权限","aria-hidden":"true"}},[s._v("#")]),s._v(" 配置登录"),t("code",[s._v("Docker")]),s._v("权限")]),s._v(" "),t("p",[s._v("如果启动匿名拉取镜像 "),t("code",[s._v("Allow anonymous docker pull")]),s._v(" 则需要配置 "),t("code",[s._v("Docker Bearer Token Realm")]),s._v(" "),t("img",{attrs:{src:a(235),alt:"image"}})]),s._v(" "),t("h2",{attrs:{id:"登录制品库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#登录制品库","aria-hidden":"true"}},[s._v("#")]),s._v(" 登录制品库")]),s._v(" "),t("p",[s._v("私服建设完成后，还需要在客户端配置一下才可以使用。"),t("br"),s._v("\n找到 "),t("code",[s._v("daemon.json")]),s._v(" 文件，该文件描述了当前docker配置的镜像加速地址，和配置过的私服地址。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/docker/daemon.json\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("找到 "),t("code",[s._v("insecure-registries")]),s._v(" 字段，如果不存在就自己添加一个。值是数组类型，添加一条你的制品库地址。例如：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('{\n  "registry-mirrors": ["https://之前配置的阿里云镜像.mirror.aliyuncs.com"],\n  "insecure-registries": ["172.16.81.50:8082"]\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("blockquote",[t("p",[s._v("注意json格式，不能有多余的逗号"),t("br"),s._v("\n这里注意，nexus显示的镜像库端口为nexus服务端口，要替换为自己配置的端口才有效。")])]),s._v(" "),t("p",[s._v("保存退出，重启 Docker")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("systemctl daemon-reload\nsystemctl restart docker\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("接着使用 docker login 命令尝试登录：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker login 服务IP:端口\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("blockquote",[t("p",[s._v("登录"),t("code",[s._v("login credentials")]),s._v("会记录在"),t("code",[s._v("/root/.docker/config.json")]),s._v("中"),t("br"),s._v("\n如果不进行"),t("code",[s._v("docker logout 服务器ip:端口")]),s._v("操作，则服务器重启后无需再次登录")])]),s._v(" "),t("p",[s._v("如果提示："),t("strong",[s._v("Login Succeeded")]),s._v(" 则代表登录成功。")]),s._v(" "),t("p",[t("img",{attrs:{src:a(236),alt:"image"}})]),s._v(" "),t("h2",{attrs:{id:"推送镜像到制品库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#推送镜像到制品库","aria-hidden":"true"}},[s._v("#")]),s._v(" 推送镜像到制品库")]),s._v(" "),t("p",[s._v("在这里，我们使用 "),t("code",[s._v("docker push")]),s._v(" 命令推送一个本地的镜像到远程制品库。"),t("br"),s._v("\n还记得在我们前面安装 "),t("code",[s._v("Jenkins")]),s._v(" 时，使用过 "),t("code",[s._v("DockerFile")]),s._v(" 生成了自己的 "),t("code",[s._v("Jenkins")]),s._v(" 镜像 -"),t("code",[s._v("local/jenkins")]),s._v(" 。所以我们可以尝试，将 "),t("code",[s._v("local/jenkins")]),s._v(" 推送到制品库。"),t("br")]),s._v(" "),t("p",[s._v("但是，docker在推送一个镜像时，"),t("strong",[s._v("镜像的 Tag (名称:版本号) 必须开头带着镜像库的地址，才可以推送")]),s._v("。例如下面两个镜像："),t("br"),s._v("\n🙅 "),t("strong",[s._v("local/jenkins")]),s._v(" 不能推送"),t("br"),s._v("\n🙆 "),t("strong",[s._v("172.16.81.150:8082/local/jenkins")]),s._v(" 可以推送。"),t("br")]),s._v(" "),t("p",[s._v("那我们怎么才能推送上去呢？")]),s._v(" "),t("ol",[t("li",[t("strong",[s._v("制作一份带镜像库地址的镜像：这个可以做，但是开销太大，需要走一遍制作流程")])]),s._v(" "),t("li",[t("strong",[s._v("使用 docker")]),s._v(" "),t("strong",[s._v("tag 命令给已有的镜像打个标签：推荐使用，会将已有的镜像归位某个镜像库内。如下面格式")])])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker tag <镜像ID> 新镜像名称[:版本]")]),s._v("\ndocker tag bd695e3e4317 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".81.150:8082/local/jenkins\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("blockquote",[t("p",[s._v("查看服务器上的docker镜像列表，可以使用docker images查看")])]),s._v(" "),t("p",[s._v("这样，就可以重新打一个全新的tag，实现 “重命名” 功能。")]),s._v(" "),t("p",[t("img",{attrs:{src:a(237),alt:"image"}})]),s._v(" "),t("p",[s._v("接着我们使用 "),t("code",[s._v("docker push")]),s._v("命令进行推送：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker push "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".81.150:8082/local/jenkins\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:a(238),alt:"image"}})]),s._v(" "),t("p",[s._v("到这里，就代表推送成功。")])])}),[],!1,null,null,null);e.default=r.exports}}]);