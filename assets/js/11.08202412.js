(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{208:function(s,a,e){s.exports=e.p+"assets/img/ansible-folder.28dc5764.png"},209:function(s,a,e){s.exports=e.p+"assets/img/ansible-hosts.5b4c95ef.png"},210:function(s,a,e){s.exports=e.p+"assets/img/ansible-success.52984a8c.png"},300:function(s,a,e){"use strict";e.r(a);var t=e(0),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"ansible"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ansible","aria-hidden":"true"}},[s._v("#")]),s._v(" Ansible")]),s._v(" "),t("h2",{attrs:{id:"介绍与安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#介绍与安装","aria-hidden":"true"}},[s._v("#")]),s._v(" 介绍与安装")]),s._v(" "),t("h3",{attrs:{id:"什么是-ansible"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#什么是-ansible","aria-hidden":"true"}},[s._v("#")]),s._v(" 什么是 Ansible")]),s._v(" "),t("p",[t("br"),s._v("我们先看网络上对它的解释：")]),s._v(" "),t("blockquote",[t("p",[t("code",[s._v("Ansible")]),s._v(" 是一款简单的运维自动化工具，只需要使用 "),t("code",[s._v("ssh")]),s._v(" 协议连接就可以来进行系统管理，自动化执行命令，部署等任务。")])]),s._v(" "),t("p",[t("br"),s._v("显而易见， "),t("code",[s._v("Ansible")]),s._v(" 拿来做服务器部署再合适不过。只需要"),t("strong",[s._v("预制好一份主机清单和要执行的命令步骤")]),s._v("，就可以实现"),t("strong",[s._v("对一个清单的全部或部分主机远程****批量执行命令")]),s._v("。"),t("br")]),s._v(" "),t("h3",{attrs:{id:"对比-jenkins"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#对比-jenkins","aria-hidden":"true"}},[s._v("#")]),s._v(" 对比 Jenkins")]),s._v(" "),t("p",[t("br"),s._v("和 "),t("code",[s._v("Jenkins")]),s._v(" 做服务部署对比， "),t("code",[s._v("Ansible")]),s._v(" 更适合批量执行。"),t("br"),s._v("以前我们在 "),t("code",[s._v("Jenkins")]),s._v(" 做部署，就是脚本执行 "),t("code",[s._v("ssh")]),s._v(" 命令远程执行命令。"),t("strong",[s._v("如果有大量的服务器，那么我们的脚本会写很长，且灵活度会变差")]),s._v("。"),t("br"),s._v(" "),t("br"),t("code",[s._v("Ansible")]),s._v(" 还支持"),t("strong",[s._v("无阻塞异步批量执行命令")]),s._v("，非常方便。**"),t("br")]),s._v(" "),t("h3",{attrs:{id:"安装-ansible"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装-ansible","aria-hidden":"true"}},[s._v("#")]),s._v(" 安装 Ansible")]),s._v(" "),t("h4",{attrs:{id:"使用-dockerfile-制作镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用-dockerfile-制作镜像","aria-hidden":"true"}},[s._v("#")]),s._v(" 使用 Dockerfile 制作镜像")]),s._v(" "),t("p",[t("br"),t("code",[s._v("Ansible")]),s._v(" 目前的部署方式没有 "),t("code",[s._v("Docker")]),s._v(" 安装，但我们可以定制一份 "),t("code",[s._v("Ansible")]),s._v(" 镜像。"),t("br"),s._v(" "),t("br"),s._v("因为 "),t("code",[s._v("Ansible")]),s._v(" 批量执行服务器时，还是采用的 "),t("code",[s._v("ssh")]),s._v(" 进行操作，所以我们还是需要配置公钥私钥。**我们可以找一个已经在目标服务器配置过的公钥，和它配套的私钥一起打到 **"),t("code",[s._v("**Ansible**")]),t("strong",[s._v("镜像内。这样我们就可以实现 "),t("code",[s._v("Ansible")]),s._v(" 免密登录。")]),t("br"),s._v(" "),t("br"),s._v("但是，ssh连接时还涉及到一个叫做 "),t("code",[s._v("known_hosts")]),s._v(" 文件。这个文件的主要作用是："),t("br")]),s._v(" "),t("blockquote",[t("p",[s._v("当你用ssh连接到一个新的服务器的时候，ssh会让你确认服务器的信息（域名、IP、公钥），如果你确认了，就会将其写到 known_hosts 文件内。\n以后你再连接到这个服务器，但是信息改变了（通常是公钥改变了），就会提示你服务器信息改变了，你可以把服务器信息它从 known_hosts 里删除，然后重新确认一份新的服务器信息。")])]),s._v(" "),t("p",[t("br"),s._v("但是在我们这里该文件作用不大，我们就可以在 "),t("code",[s._v("Ansible")]),s._v(" 内配置 "),t("code",[s._v("host_key_checking = False")]),s._v(" 和 "),t("code",[s._v("host_key_checking = False")]),s._v(" 这两个选项来关闭这个校验（下方dockerfile内有写）。**直接使用公钥私钥配对成功就可以进行连接。**我们将公钥私钥放在 "),t("code",[s._v("ssh")]),s._v(" 文件夹内即可："),t("br"),s._v(" "),t("img",{attrs:{src:e(208),alt:"image"}}),t("br"),s._v("除了公钥私钥外，我们还需要准备一份 "),t("code",[s._v("主机清单")]),s._v("，命名为 "),t("code",[s._v("hosts")]),s._v("。**清单里面声明了要批量执行的主机。**这里可以先简单写一下，下一章我们会详细描述清单的语法格式。**最简单的****格式使用中括号声明主机组名称，换行写IP即可。**如下：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" ./hosts\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("fe-servers"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".81.151\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".81.152\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[t("strong",[s._v("将公钥添加到目标服务器"),t("code",[s._v("authorized_keys")]),s._v("中")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("ssh-copy-id -i ./ssh/id_rsa.pub root@172.16.81.151\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("blockquote",[t("p",[s._v("目标服务器"),t("code",[s._v("(172.16.81.151)")]),s._v("如果没有"),t("code",[s._v("公钥/私钥")]),s._v("需要使用"),t("code",[s._v("ssh-keygen -t rsa")]),s._v("生成")])]),s._v(" "),t("p",[t("img",{attrs:{src:e(209),alt:"image"}}),t("br"),s._v(" "),t("br"),s._v("这里我们使用 "),t("code",[s._v("Centos7")]),s._v(" 做镜像底座，用 "),t("code",[s._v("Dockerfile")]),s._v(" 做镜像：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("FROM centos:7\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装必要依赖，openssh-clients是为了支持ssh连接")]),s._v("\nRUN yum -y "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" openssh-clients\nRUN "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\nRUN yum clean all\nRUN yum makecache\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 拷贝公钥私钥进镜像内")]),s._v("\nCOPY "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" /root/.ssh/\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 公钥私钥赋权")]),s._v("\nRUN "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("755")]),s._v(" ~/.ssh/\nRUN "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v(" ~/.ssh/id_rsa ~/.ssh/id_rsa.pub\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装 ansible")]),s._v("\nRUN yum -y "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" ansible\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 拷贝主机组清单进 ansible 目录")]),s._v("\nCOPY hosts /etc/ansible/\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭 known_hosts 校验")]),s._v("\nRUN "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/^#host_key_checking = False/host_key_checking = False/'")]),s._v(" /etc/ansible/ansible.cfg\nRUN ansible --version\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("blockquote",[t("p",[s._v("sed -i ... ... 代表在"),t("code",[s._v("主配置文件")]),s._v("中"),t("code",[s._v("把#host_key_checking = False的#去掉")])])]),s._v(" "),t("p",[s._v("使用 "),t("code",[s._v("docker build")]),s._v(" 命令打包为镜像，版本为t1：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker build -t ansible:t1 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h4",{attrs:{id:"启动容器并测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动容器并测试","aria-hidden":"true"}},[s._v("#")]),s._v(" 启动容器并测试")]),s._v(" "),t("p",[t("br"),s._v("等待 "),t("code",[s._v("build")]),s._v(" 完成后，使用 "),t("code",[s._v("docker run")]),s._v(" 命令启动容器：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker run -itd --name ansible ansible:t1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("blockquote",[t("p",[s._v("因为ansible并没有可视化界面，所以不需要分配端口")])]),s._v(" "),t("p",[t("br"),s._v("启动后，使用 "),t("code",[s._v("docker exec")]),s._v(" + "),t("code",[s._v("ansible command")]),s._v(" 命令测试 "),t("code",[s._v("ansible")]),s._v(" 安装，并远程执行一个命令测试：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it ansible ansible all -m "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" -a "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"chdir=~ docker ps"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("blockquote",[t("p",[s._v("ansible all: 代表匹配所有主机组的所有主机"),t("br"),s._v("\ncommand：Ansible 命令模块。代表执行一个命令"),t("br"),s._v("\nchdir=~：chdir 在哪里执行命令"),t("br"),s._v("\ndocker ps：查看正在跑的docker容器"),t("br")])]),s._v(" "),t("p",[t("br"),s._v("执行成功后，如下图（我的主机组配置了2台机器，一台可以连接另一台不存在）："),t("br"),t("img",{attrs:{src:e(210),alt:"image"}}),t("br"),s._v(" "),t("br"),s._v("到这里，我们的 "),t("code",[s._v("Ansible")]),s._v(" 就安装成功")]),s._v(" "),t("hr"),s._v(" "),t("h2",{attrs:{id:"ansible-内的概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ansible-内的概念","aria-hidden":"true"}},[s._v("#")]),s._v(" Ansible 内的概念")]),s._v(" "),t("p",[t("strong",[s._v("先进入docker，下文都基于docker容器内部执行")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it ansible /bin/bash\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("blockquote",[t("p",[s._v("如果ansible不是自启动可以更新为自启动"),t("br"),s._v("\ndocker container update --restart=always ansible")])]),s._v(" "),t("h3",{attrs:{id:"基础命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基础命令","aria-hidden":"true"}},[s._v("#")]),s._v(" 基础命令")]),s._v(" "),t("p",[t("br"),s._v("安装好 "),t("code",[s._v("Ansible")]),s._v(" 后，使用 "),t("code",[s._v("ansible")]),s._v(" 命令即可完成基础操作。例如以下命令可以测试你的所有主机的连通性：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ansible all -m "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("blockquote",[t("p",[t("code",[s._v("-m")]),s._v(" 代表使用 "),t("code",[s._v("ansible")]),s._v("  某个模块，后紧跟模块名\nall代表匹配所有主机组，这里也可以传入指定的主机组名称。")])]),s._v(" "),t("p",[t("br"),s._v("如果想查看有哪些模块：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ansible-doc -l\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("br"),s._v("想查看模块的具体帮助，比如fetch模块：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ansible-doc -s fetch\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"modules-模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#modules-模块","aria-hidden":"true"}},[s._v("#")]),s._v(" Modules 模块")]),s._v(" "),t("h4",{attrs:{id:"copy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#copy","aria-hidden":"true"}},[s._v("#")]),s._v(" copy")]),s._v(" "),t("p",[s._v("文件拷贝模块：将 "),t("code",[s._v("Ansible")]),s._v(" 主机下的目录拷贝到目标机器。例如将 "),t("code",[s._v("Ansible")]),s._v(" 主机内的  "),t("code",[s._v("/testdir/copytest")]),s._v(" 目录拷贝到目标机器 "),t("code",[s._v("/opt")]),s._v(" 下。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ansible all -m copy -a "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"src=/testdir/copytest dest=/opt"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("blockquote",[t("p",[s._v("mkdir -p /testdir/copytest"),t("br"),s._v("\ntouch /testdir/copytest/aa")])]),s._v(" "),t("h4",{attrs:{id:"file"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#file","aria-hidden":"true"}},[s._v("#")]),s._v(" file")]),s._v(" "),t("p",[s._v("文件操作模块：可以对目标机器进行新建和删除文件。例如：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('ansible all -m file -a "path=/testdir/testfile state=touch"\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("blockquote",[t("p",[s._v("在目标机器下新建 /testdir/testfile 文件")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('ansible all -m file -a "path=/testdir/testfile state=absent"\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("blockquote",[t("p",[s._v("在目标机器下删除 /testdir/testfile 文件")])]),s._v(" "),t("h4",{attrs:{id:"find"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#find","aria-hidden":"true"}},[s._v("#")]),s._v(" find")]),s._v(" "),t("p",[s._v("文件查找模块：可以查找目标机器内的文件。例如查找 "),t("code",[s._v("/testdir")]),s._v(" 文件夹下包含 "),t("code",[s._v("abc")]),s._v(" 字符串的文件：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("ansible all -m find -a 'paths=/testdir contains=\".*abc.*\"'\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h4",{attrs:{id:"replace"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#replace","aria-hidden":"true"}},[s._v("#")]),s._v(" replace")]),s._v(" "),t("p",[s._v("文件内容替换模块：可以在指定文件中通过正则匹配指定内容进行替换。例如在 "),t("code",[s._v("/testdir/test")]),s._v(" 文件夹内，查找符合正则 "),t("code",[s._v("abc")]),s._v(" 的内容，替换为 "),t("code",[s._v("buck")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("ansible all -m replace -a 'path=/testdir/test  regexp=\"abc\" replace=buck'\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h4",{attrs:{id:"command"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#command","aria-hidden":"true"}},[s._v("#")]),s._v(" command")]),s._v(" "),t("p",[s._v("命令模块：可以在目标机器内执行命令。"),t("br"),t("strong",[s._v("和shell命令不同的是，shell中的 "),t("code",[s._v("<")]),s._v(" , "),t("code",[s._v(">")]),s._v(" , "),t("code",[s._v("|")]),s._v(" , "),t("code",[s._v(";")]),s._v(" , "),t("code",[s._v("&")]),s._v(" , "),t("code",[s._v("$")]),s._v(" 等特殊字符不能在command模块中使用，如果需要使用，则用shell模块。")]),t("br"),s._v("例如：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('ansible all -m command -a "chdir=/testdir ls"\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("blockquote",[t("p",[s._v("在目标机器 /testdir 目录下执行 ls命令")])]),s._v(" "),t("p",[t("br"),s._v("更详细的介绍，可以参考："),t("a",{attrs:{href:"https://www.cnblogs.com/yanjieli/p/10969143.html",target:"_blank",rel:"noopener noreferrer"}},[t("strong",[s._v("链接")]),t("OutboundLink")],1),t("br")]),s._v(" "),t("h3",{attrs:{id:"inventory-主机清单"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#inventory-主机清单","aria-hidden":"true"}},[s._v("#")]),s._v(" Inventory 主机清单")]),s._v(" "),t("p",[t("br"),s._v("主机清单是 "),t("code",[s._v("Ansible")]),s._v(" 最基础的概念，它声明了 "),t("code",[s._v("Ansible")]),s._v(" "),t("strong",[s._v("到底在哪些机器上执行命令")]),s._v("。主机清单默认是 "),t("code",[s._v("/etc/ansible/hosts")]),s._v(" 文件。"),t("br"),s._v("主机清单语法花样也很多。"),t("strong",[s._v("不仅可以保存主机清单，还可以定义主机密码，授权方式等其他信息")]),s._v("。"),t("br"),s._v(" "),t("br"),s._v("一般在 "),t("code",[s._v("Ansible")]),s._v(" 内，都是以 "),t("code",[s._v("组")]),s._v(" 为集合管理主机。被称为 "),t("code",[s._v("主机组")]),s._v(" ，一个主机组内有许多主机。"),t("br"),s._v(" "),t("br"),s._v("最简单的主机组声明：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("[apache]\n192.168.1.36\n192.168.1.33\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("其中， "),t("code",[s._v("apache")]),s._v(" 是主机组名，下面是组内的主机IP。"),t("br")]),s._v(" "),t("h4",{attrs:{id:"使用密码连接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用密码连接","aria-hidden":"true"}},[s._v("#")]),s._v(" 使用密码连接")]),s._v(" "),t("p",[t("br"),s._v("在主机组内，可以在清单内定义主机密码，端口等信息。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('# 方法一 主机+端口+密码\n[webserver]\n192.168.1.31 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass="123456"\n192.168.1.32 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass="123456"\n192.168.1.33 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass="123456"\n192.168.1.36 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass="123456"\n\n\n# 方法二 主机+端口+密码\n[webserver]\n192.168.1.3[1:3] ansible_ssh_user=root ansible_ssh_pass="123456"\n\n\n# 方法二 主机+端口+密码\n[webserver]\n192.168.1.3[1:3]\n[webserver:vars]\nansible_ssh_pass="123456"\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("blockquote",[t("p",[s._v("192.168.1.3[1:3]：代表 192.168.1.31 和 192.168.1.33")])]),s._v(" "),t("h4",{attrs:{id:"使用密钥连接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用密钥连接","aria-hidden":"true"}},[s._v("#")]),s._v(" 使用密钥连接")]),s._v(" "),t("p",[t("br"),s._v("当然，最常用的就是密钥连接服务器。这种情况下，我们只需要定义最简单的主机组，将Ansible机器公钥在目标机器配置即可。"),t("br"),s._v(" "),t("br"),s._v("更多花样玩法 => "),t("a",{attrs:{href:"https://www.cnblogs.com/yanjieli/p/10969089.html#380920160",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.cnblogs.com/yanjieli/p/10969089.html#380920160"),t("OutboundLink")],1),t("br")]),s._v(" "),t("h3",{attrs:{id:"playbook-任务剧本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#playbook-任务剧本","aria-hidden":"true"}},[s._v("#")]),s._v(" Playbook 任务剧本")]),s._v(" "),t("p",[t("br"),s._v("任务剧本（任务集），yaml格式文件，定义 Ansible 任务的配置文件。作用有点像 "),t("code",[s._v("Dockerfile")]),s._v(" 。"),t("strong",[s._v("是一组任务的集合声明文件")]),t("br"),s._v("示例如下：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" all\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("remote_user")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("vars")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("timestamp")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20200625233149")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tasks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" docker pull new images\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("shell")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'chdir=~ docker pull 172.16.81.150:8082/fe/nginx-fe-{{timestamp}}'")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" docker rmf\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("shell")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'chdir=~ docker ps | grep jenkins-test && docker rm -f jenkins-test'")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ignore_errors")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" docker run\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("shell")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'chdir=~ docker run -p 80:80 -itd --name jenkins-test 172.16.81.150:8082/fe/nginx-fe-{{timestamp}}'")]),s._v("\n      \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("ul",[t("li",[s._v("hosts: 指定在哪个主机组执行该任务集合。 "),t("code",[s._v("all")]),s._v(" 代表全部主机")]),s._v(" "),t("li",[s._v("remote_user: 使用哪个用户进行远程执行")]),s._v(" "),t("li",[s._v("vars: 定义变量的地方。在下方任务命令中可以使用 "),t("code",[s._v(s._s(s.varName))]),s._v(" 使用变量")]),s._v(" "),t("li",[s._v("tasks: 任务集合")]),s._v(" "),t("li",[s._v("shell: "),t("code",[s._v("Ansible")]),s._v(" 的 "),t("code",[s._v("shell")]),s._v(" 模块，上面有讲解模块的作用和类型。后面跟着模块的命令")])]),s._v(" "),t("p",[t("br"),s._v("更详细的语法："),t("a",{attrs:{href:"https://www.cnblogs.com/yanjieli/p/10969299.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.cnblogs.com/yanjieli/p/10969299.html"),t("OutboundLink")],1),t("br")]),s._v(" "),t("h4",{attrs:{id:"执行-playbook"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#执行-playbook","aria-hidden":"true"}},[s._v("#")]),s._v(" 执行 Playbook")]),s._v(" "),t("p",[t("br"),s._v("可以使用 "),t("code",[s._v("ansible-playbook")]),s._v(" 命令执行 "),t("code",[s._v("playbook")]),s._v(" ：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ansible-playbook test.yml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("br"),s._v("使用 "),t("code",[s._v("--syntax-check")]),s._v(" 命令测试 playbook 语法是否正确")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ansible-playbook --syntax-check test.yml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("br"),s._v("测试playbook执行（并不会真的在主机组上执行，只是模拟）：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ansible-playbook --check test.yml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("br"),s._v("替换playbook中默认的变量值，并执行playbook。在这种情况下，"),t("strong",[s._v("命令行传入参数 > 默认值")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ansible-playbook -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"timestamp=212123323"')]),s._v(" test.yml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])}),[],!1,null,null,null);a.default=n.exports}}]);