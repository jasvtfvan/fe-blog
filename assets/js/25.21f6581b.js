(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{305:function(s,n,e){"use strict";e.r(n);var a=e(0),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"jenkins-nexus"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#jenkins-nexus","aria-hidden":"true"}},[s._v("#")]),s._v(" Jenkins + Nexus")]),s._v(" "),e("p",[e("br"),s._v("上一章我们写到，如何使用 Nexus 托管我们的镜像。这一章我们就将 Nexus 和 Jenkins 结合起来构建部署。"),e("br")]),s._v(" "),e("p",[e("a",{attrs:{name:"Im23h"}})]),s._v(" "),e("h2",{attrs:{id:"jenkins-登录认证制品库"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#jenkins-登录认证制品库","aria-hidden":"true"}},[s._v("#")]),s._v(" Jenkins 登录认证制品库")]),s._v(" "),e("p",[e("br"),s._v("想使用 "),e("code",[s._v("Jenkins")]),s._v(" 推送镜像到制品库，必须先登录制品库。进入 "),e("code",[s._v("Jenkins")]),s._v(" 容器，使用 "),e("code",[s._v("docker login")]),s._v(" 登录，然后退出即可：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("docker "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it jenkins /bin/bash\ndocker login 制品库地址:端口\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("blockquote",[e("p",[s._v("10.211.55.3:8082"),e("br"),s._v("\n登录"),e("code",[s._v("login credentials")]),s._v("会记录在"),e("code",[s._v("/root/.docker/config.json")]),s._v("中"),e("br"),s._v("\n如果不进行"),e("code",[s._v("docker logout 服务器ip:端口")]),s._v("操作，则服务器重启后无需再次登录")])]),s._v(" "),e("p",[e("a",{attrs:{name:"obg0K"}})]),s._v(" "),e("h2",{attrs:{id:"nginx-服务器登录认证制品库"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx-服务器登录认证制品库","aria-hidden":"true"}},[s._v("#")]),s._v(" Nginx 服务器登录认证制品库")]),s._v(" "),e("p",[e("br"),s._v("编辑 "),e("code",[s._v("/etc/docker/daemon.json")]),s._v(" 文件，将制品库地址写入，然后重启 "),e("code",[s._v("docker")]),s._v(" 服务")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/docker/daemon.json\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl daemon-reload\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl restart docker\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('{\n  "registry-mirrors": ["https://jzirisvt.mirror.aliyuncs.com"],\n  "insecure-registries": ["10.211.55.3:8082"]\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("br"),s._v("接着使用 "),e("code",[s._v("docker login")]),s._v(" 命令进行登录")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("docker login 制品库地址:端口\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("blockquote",[e("p",[s._v("10.211.55.3:8082")])]),s._v(" "),e("p",[e("a",{attrs:{name:"EjgWc"}})]),s._v(" "),e("h2",{attrs:{id:"使用-dockerfile-构建前端镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-dockerfile-构建前端镜像","aria-hidden":"true"}},[s._v("#")]),s._v(" 使用 DockerFile 构建前端镜像")]),s._v(" "),e("p",[e("br"),s._v("在此之前，我们使用** 构建压缩包 => 直接上传到目标服务器 => 进行解压部署 "),e("strong",[s._v("的方式部署前端。"),e("br"),s._v("在这里，我们更换为部署docker镜像。既然要制作自己的镜像，那就少不了")]),s._v(" DockerFile。"),e("strong",[e("br")]),e("br"),s._v("在前面我们写到过，"),e("strong",[s._v("DockerFile 是一个镜像制作过程的步骤描述")]),s._v("。那么我们也可以简单的描述下我们自己的步骤。"),e("br"),s._v(" "),e("br"),s._v("我们在代码目录下，新建一个文件。叫 "),e("strong",[s._v("Dockerfile")]),s._v(" （注意，file全小写）：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# FROM nginx:1.15-alpine")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# COPY dist /usr/share/nginx/html")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# WORKDIR /usr/share/nginx/html")]),s._v("\nFROM nginx:1.15-alpine\nCOPY dist /usr/share/nginx/html/jenkins-test-vue/\nWORKDIR /usr/share/nginx/html\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("此Dockerfile声明了以下步骤：")]),s._v(" "),e("ol",[e("li",[s._v("拉取一个 "),e("code",[s._v("nginx 1.15-alpine")]),s._v(" 版本的镜像。")]),s._v(" "),e("li",[s._v("将当前目录下的 "),e("code",[s._v("dist")]),s._v(" "),e("code",[s._v("文件夹里的内容")]),s._v("拷贝到镜像的 "),e("code",[s._v("/usr/share/nginx/html")]),s._v(" 文件夹中。")]),s._v(" "),e("li",[s._v("声明启动容器时，在 "),e("code",[s._v("/usr/share/nginx/html")]),s._v(" 下面执行。")])]),s._v(" "),e("blockquote",[e("p",[e("code",[s._v(".")]),s._v("代表当前路径，即docker容器中的"),e("code",[s._v("/var/jenkins_home/workspace/项目目录")]),s._v("，项目是从gitlab拉取而来"),e("br"),s._v("\n当执行到"),e("code",[s._v("docker build -t 172.16.81.150:8082/fe/nginx-fe-$timestamp .")]),s._v("时，会将"),e("code",[s._v(".代码的当前路径")]),s._v("作为"),e("code",[s._v("context上下文")]),s._v("，并在"),e("code",[s._v("context")]),s._v("中寻找"),e("code",[s._v("Dockerfile")]),s._v("。"),e("br"),s._v("\n同时"),e("code",[s._v("docker客户端")]),s._v("会把"),e("code",[s._v("上下文")]),s._v("中的所有文件发送给"),e("code",[s._v("docker daemon")]),s._v("。"),e("br"),s._v("\n当执行"),e("code",[s._v("COPY")]),s._v("操作时，会在当前"),e("code",[s._v("上下文")]),s._v("中寻找文件，并拷贝到镜像的目标路径"),e("code",[s._v("/usr/share/nginx/html")]),s._v("下，如果目标路径不存在则自动创建目标路径。"),e("br"),s._v("\n不能拷贝上下文之外的文件，否则会报错。"),e("br"),s._v("\n当执行"),e("code",[s._v("docker run")]),s._v("时，容器会拿到镜像里对应路径"),e("code",[s._v("/usr/share/nginx/html")]),s._v("下的所有文件。"),e("br")])]),s._v(" "),e("p",[e("br"),s._v("接着提交到代码库中。"),e("br")]),s._v(" "),e("p",[e("a",{attrs:{name:"N6zCG"}})]),s._v(" "),e("h2",{attrs:{id:"修改-jenkins-执行脚本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修改-jenkins-执行脚本","aria-hidden":"true"}},[s._v("#")]),s._v(" 修改 Jenkins 执行脚本")]),s._v(" "),e("p",[e("br"),s._v("我们打开之前 "),e("code",[s._v("Jenkins")]),s._v(" 任务的编辑页面，改为以下脚本：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# set -e")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# timestamp=`date '+%Y%m%d%H%M%S'`")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# node -v")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# npm -v")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# npm install -g cnpm --registry=https://registry.npm.taobao.org")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cnpm install")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# npm run build")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# # 编译docker镜像")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker build -t 172.16.81.150:8082/fe/nginx-fe-$timestamp .")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# # 推送docker镜像到制品库")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker push 172.16.81.150:8082/fe/nginx-fe-$timestamp")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# # 远程执行命令部署镜像")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# ssh -o StrictHostKeyChecking=no root@172.16.81.151 "docker pull 172.# 16.81.150:8082/fe/nginx-fe-$timestamp && \\')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker stop jenkins-test && \\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker rm jenkins-test && \\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -p 80:80 -itd \\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --name jenkins-test \\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --restart always \\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 172.16.81.150:8082/fe/nginx-fe-$timestamp"')]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" -e\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("timestamp")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'+%Y%m%d%H%M%S'")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n\nnode -v\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" -v\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -g cnpm --registry"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://registry.npm.taobao.org\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf node_modules/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf dist/\ncnpm "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" run build\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 编译docker镜像")]),s._v("\ndocker build -t "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.211")]),s._v(".55.3:8082/fe/nginx-fe-"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$timestamp")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 推送docker镜像到制品库")]),s._v("\ndocker push "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.211")]),s._v(".55.3:8082/fe/nginx-fe-"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$timestamp")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 远程执行命令部署镜像")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" -o "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("StrictHostKeyChecking")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("no root@10.211.55.4 "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"docker pull 10.211.55.3:8082/fe/nginx-fe-'),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$timestamp")]),s._v(" && \\\ndocker stop nginx && \\\ndocker rm nginx && \\\ndocker run -p 80:80 -itd \\\n--name nginx \\\n--restart always \\\n10.211.55.3:8082/fe/nginx-fe-"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$timestamp")]),s._v('"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br")])]),e("blockquote",[e("p",[e("code",[s._v("set -e")]),s._v(" bash如果任何语句的执行结果不是true则应该退出"),e("br"),s._v("\n在shell脚本中，声明一个变量只需要 变量名=值 即可。在命令中用 $-变量名 进行使用。"),e("br"),s._v("\ntimestamp=`date '+%Y%m%d%H%M%S'`：这个代表执行 date '+%Y%m%d%H%M%S' 这条命令，并赋值给 timestamp 这个变量。"),e("br"),s._v("\ndate '+%Y%m%d%H%M%S' 代表输出当前时间的年月日时分秒。"),e("br")])]),s._v(" "),e("blockquote",[e("p",[s._v("-o StrictHostKeyChecking=no "),e("code",[s._v("跳过ssh公钥检查")]),e("br"),s._v("\n比如: ssh root@ip -o StrictHostKeyChecking=no"),e("br"),s._v("\n比如: scp test.txt root@ip:~ -o StrictHostKeyChecking=no"),e("br"),s._v("\nStrictHostKeyChecking: "),e("a",{attrs:{href:"https://cikeblog.com/ssh-cant-established.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://cikeblog.com/ssh-cant-established.html"),e("OutboundLink")],1)])]),s._v(" "),e("p",[e("strong",[s._v("如何进入nginx容器")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("docker "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it nginx /bin/sh\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("blockquote",[e("p",[s._v("进入alpine容器")])]),s._v(" "),e("p",[e("br"),s._v("这里可以看到，我们将之前脚本后半部分的流程："),e("br"),s._v(" "),e("br"),e("strong",[s._v("压缩打包资源 => 通过 "),e("strong",[e("strong",[e("code",[s._v("scp")])])]),s._v(" 上传压缩包")]),s._v("** => "),e("strong",[e("strong",[e("code",[s._v("ssh")])])]),s._v(" 远程执行解压部署命令 "),e("strong",[e("br"),s._v(" "),e("br"),s._v("替换为："),e("br")]),e("br"),e("strong",[s._v("Dockerfile构建镜像 => 上传镜像到制品库 => 远程执行命令拉取镜像，停止容器，删除容器，启动新拉取的镜像")]),e("br")])])}),[],!1,null,null,null);n.default=t.exports}}]);